# v0.8 - í‰ì  ì‹œìŠ¤í…œ êµ¬í˜„

## ê°œìš”
ë¹„ë””ì˜¤ í‰ì  ì‹œìŠ¤í…œ êµ¬í˜„ (Phase 2ì˜ ì²« ë²ˆì§¸ ê¸°ëŠ¥)

**ì‘ì—… ê¸°ê°„**: 2026-01-13
**ë²„ì „**: v0.8
**ì£¼ìš” ê¸°ëŠ¥**: 1-5ì  ë³„ì  í‰ê°€ ì‹œìŠ¤í…œ

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ratings í…Œì´ë¸”
```sql
CREATE TABLE ratings (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    video_id INTEGER NOT NULL,
    score INTEGER NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,

    CONSTRAINT uq_user_video_rating UNIQUE (user_id, video_id),
    CONSTRAINT check_rating_score CHECK (score >= 1 AND score <= 5)
);

CREATE INDEX ix_ratings_id ON ratings(id);
```

### ì œì•½ ì¡°ê±´
- **UniqueConstraint**: (user_id, video_id) - í•œ ì‚¬ìš©ìëŠ” í•œ ë¹„ë””ì˜¤ì— í•˜ë‚˜ì˜ í‰ì ë§Œ ë“±ë¡ ê°€ëŠ¥
- **CheckConstraint**: score >= 1 AND score <= 5 - í‰ì ì€ 1-5 ì‚¬ì´ë§Œ í—ˆìš©
- **CASCADE**: ì‚¬ìš©ìë‚˜ ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ ê´€ë ¨ í‰ì ë„ ìë™ ì‚­ì œ

### ë§ˆì´ê·¸ë ˆì´ì…˜
- **íŒŒì¼**: `backend/alembic/versions/20260113_0936_41fff3752bb2_add_ratings_table.py`
- **ì‹¤í–‰**: `alembic upgrade head`

---

## ğŸ”§ ë°±ì—”ë“œ êµ¬í˜„

### 1. ëª¨ë¸ (backend/app/models/rating.py)

```python
class Rating(Base):
    """Rating model for video ratings (1-5 stars)"""
    __tablename__ = "ratings"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    video_id = Column(Integer, ForeignKey("videos.id", ondelete="CASCADE"), nullable=False)
    score = Column(Integer, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)

    # Relationships
    user = relationship("User", backref="ratings")
    video = relationship("Video", backref="ratings")
```

### 2. ìŠ¤í‚¤ë§ˆ (backend/app/schemas/rating.py)

```python
class RatingBase(BaseModel):
    score: int = Field(..., ge=1, le=5, description="Rating score from 1 to 5")

class RatingCreate(RatingBase):
    pass

class RatingUpdate(RatingBase):
    pass

class RatingResponse(RatingBase):
    id: int
    user_id: int
    video_id: int
    created_at: datetime
    updated_at: datetime
    model_config = ConfigDict(from_attributes=True)

class VideoRatingStats(BaseModel):
    avg_rating: float = Field(0.0, description="Average rating score")
    rating_count: int = Field(0, description="Total number of ratings")
    user_rating: int | None = Field(None, description="Current user's rating")
```

### 3. ì„œë¹„ìŠ¤ (backend/app/services/rating_service.py)

ì£¼ìš” ë©”ì„œë“œ:
- `create_or_update_rating()`: í‰ì  ë“±ë¡/ìˆ˜ì • (upsert)
- `get_user_rating()`: íŠ¹ì • ì‚¬ìš©ìì˜ í‰ì  ì¡°íšŒ
- `get_video_rating_stats()`: ë¹„ë””ì˜¤ í‰ì  í†µê³„ (í‰ê· , ê°œìˆ˜)
- `delete_rating()`: í‰ì  ì‚­ì œ

**Upsert ë¡œì§**:
```python
# ê¸°ì¡´ í‰ì ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
existing_rating = await db.execute(
    select(Rating).where(
        and_(Rating.user_id == user_id, Rating.video_id == video_id)
    )
)
```

**í‰ê·  í‰ì  ê³„ì‚°**:
```python
result = await db.execute(
    select(
        func.coalesce(func.avg(Rating.score), 0.0).label('avg_rating'),
        func.count(Rating.id).label('rating_count')
    ).where(Rating.video_id == video_id)
)
```

### 4. API ì—”ë“œí¬ì¸íŠ¸ (backend/app/api/v1/ratings.py)

| Method | Endpoint | ì„¤ëª… | ì¸ì¦ í•„ìš” |
|--------|----------|------|----------|
| POST | `/api/v1/videos/{video_id}/rating` | í‰ì  ë“±ë¡/ìˆ˜ì • | âœ… |
| GET | `/api/v1/videos/{video_id}/rating` | ë‚´ í‰ì  ì¡°íšŒ | âœ… |
| GET | `/api/v1/videos/{video_id}/rating/stats` | í‰ì  í†µê³„ ì¡°íšŒ | âŒ |
| DELETE | `/api/v1/videos/{video_id}/rating` | ë‚´ í‰ì  ì‚­ì œ | âœ… |

**API ì‘ë‹µ ì˜ˆì‹œ**:

```json
// POST /api/v1/videos/12/rating
{
  "score": 5
}

// Response
{
  "id": 1,
  "user_id": 1,
  "video_id": 12,
  "score": 5,
  "created_at": "2026-01-13T09:36:00",
  "updated_at": "2026-01-13T09:36:00"
}

// GET /api/v1/videos/12/rating/stats
{
  "avg_rating": 4.5,
  "rating_count": 10,
  "user_rating": null
}
```

---

## ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 1. StarRating ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `frontend/src/components/rating/StarRating.tsx`

**ê¸°ëŠ¥**:
- 1-5ì  ë³„ì  í‘œì‹œ
- í‰ê·  í‰ì  ì‹œê°í™” (ë°˜ ë³„ í‘œì‹œ ì§€ì›)
- ì‚¬ìš©ì í‰ì  ì…ë ¥ (í´ë¦­)
- í˜¸ë²„ íš¨ê³¼ (ë¯¸ë¦¬ë³´ê¸°)
- ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¥¸ UI ë³€ê²½

**Props**:
```typescript
interface StarRatingProps {
  rating: number;           // í‰ê·  í‰ì  (0-5, ì†Œìˆ˜ì  ê°€ëŠ¥)
  count: number;            // í‰ê°€ ê°œìˆ˜
  userRating?: number | null; // ì‚¬ìš©ìì˜ í‰ì 
  onRate?: (score: number) => Promise<void>; // í‰ì  ë“±ë¡ ì½œë°±
  readOnly?: boolean;       // ì½ê¸° ì „ìš© ëª¨ë“œ
}
```

**UI ìƒíƒœ**:
- ë¡œê·¸ì¸ ì „: ì½ê¸° ì „ìš©, "ë³„ì ì„ í´ë¦­í•˜ì—¬ í‰ê°€í•˜ì„¸ìš”" ì•ˆë‚´
- ë¡œê·¸ì¸ í›„ ë¯¸í‰ê°€: í´ë¦­ ê°€ëŠ¥, í˜¸ë²„ ì‹œ ë¯¸ë¦¬ë³´ê¸°
- ë¡œê·¸ì¸ í›„ í‰ê°€ ì™„ë£Œ: "ë‚´ í‰ê°€: Nì " í‘œì‹œ, ì¬í‰ê°€ ê°€ëŠ¥

### 2. VideoPlayer í˜ì´ì§€ í†µí•©

**íŒŒì¼**: `frontend/src/pages/VideoPlayer.tsx`

**ì¶”ê°€ëœ ê¸°ëŠ¥**:
```typescript
// State
const [ratingStats, setRatingStats] = useState<RatingStats>({
  avg_rating: 0,
  rating_count: 0,
  user_rating: null
});

// í‰ì  í†µê³„ ë¡œë“œ
const loadRatingStats = async (videoId: number) => {
  // 1. ê³µê°œ í†µê³„ ì¡°íšŒ
  const response = await apiClient.get(`/videos/${videoId}/rating/stats`);

  // 2. ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ê°œì¸ í‰ì  ì¡°íšŒ (ì„ íƒì )
  if (user) {
    const userRatingResponse = await apiClient.get(`/videos/${videoId}/rating`);
    setRatingStats(prev => ({
      ...prev,
      user_rating: userRatingResponse.data.score
    }));
  }
};

// í‰ì  ë“±ë¡ í•¸ë“¤ëŸ¬
const handleRate = async (score: number) => {
  await apiClient.post(`/videos/${video.id}/rating`, { score });
  await loadRatingStats(video.id);
  alert('í‰ê°€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
};
```

**UI ë°°ì¹˜**:
- ìœ„ì¹˜: íƒœê·¸ ì„¹ì…˜ ë‹¤ìŒ, ì¸ë„¤ì¼ ê´€ë¦¬ ì„¹ì…˜ ì´ì „
- ìŠ¤íƒ€ì¼: íšŒìƒ‰ ì¹´ë“œ ë‚´ë¶€, êµ¬ë¶„ì„ ìœ¼ë¡œ ë¶„ë¦¬

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ë°±ì—”ë“œ API í…ŒìŠ¤íŠ¸

```bash
# 1. í‰ì  í†µê³„ ì¡°íšŒ (ì¸ì¦ ë¶ˆí•„ìš”)
curl http://localhost:8000/api/v1/videos/12/rating/stats

# ì‘ë‹µ: {"avg_rating": 0.0, "rating_count": 0, "user_rating": null}

# 2. í‰ì  ë“±ë¡ (ì¸ì¦ í•„ìš”)
curl -X POST http://localhost:8000/api/v1/videos/12/rating \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"score": 5}'

# 3. ë‚´ í‰ì  ì¡°íšŒ
curl http://localhost:8000/api/v1/videos/12/rating \
  -H "Authorization: Bearer <token>"
```

### í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ë¡œê·¸ì•„ì›ƒ ìƒíƒœ**
   - âœ… í‰ì  í†µê³„ í‘œì‹œ (í‰ê· , ê°œìˆ˜)
   - âœ… ë³„ì ì€ ì½ê¸° ì „ìš© (í˜¸ë²„ íš¨ê³¼ ì—†ìŒ)
   - âœ… "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤" ì•ˆë‚´

2. **ë¡œê·¸ì¸ ìƒíƒœ (ë¯¸í‰ê°€)**
   - âœ… ë³„ì  í´ë¦­ ê°€ëŠ¥
   - âœ… í˜¸ë²„ ì‹œ ë¯¸ë¦¬ë³´ê¸°
   - âœ… í´ë¦­ ì‹œ í‰ì  ë“±ë¡
   - âœ… "í‰ê°€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤" ì•Œë¦¼

3. **ë¡œê·¸ì¸ ìƒíƒœ (í‰ê°€ ì™„ë£Œ)**
   - âœ… "ë‚´ í‰ê°€: Nì " í‘œì‹œ
   - âœ… ë³„ì  í•˜ì´ë¼ì´íŠ¸ (ë…¸ë€ìƒ‰)
   - âœ… ì¬í‰ê°€ ê°€ëŠ¥ (ë‹¤ë¥¸ ë³„ í´ë¦­)
   - âœ… í‰ì  ì—…ë°ì´íŠ¸ ë°˜ì˜

---

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### ë°ì´í„°ë² ì´ìŠ¤
- `ratings.id`ì— ì¸ë±ìŠ¤ ìƒì„±
- `(user_id, video_id)` ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ í™œìš©

### API
- í‰ì  í†µê³„ëŠ” ìºì‹± ê°€ëŠ¥ (í–¥í›„ Redis ë„ì… ì‹œ)
- ì§‘ê³„ ì¿¼ë¦¬ ìµœì í™” (`func.avg`, `func.count` ì‚¬ìš©)

### í”„ë¡ íŠ¸ì—”ë“œ
- Hot Module Replacement (HMR) ì§€ì›
- ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš©ì„± ë†’ìŒ
- ë¶ˆí•„ìš”í•œ API í˜¸ì¶œ ìµœì†Œí™”

---

## ğŸ”„ ë°ì´í„° íë¦„

```
[ì‚¬ìš©ì]
  â†“ ë³„ì  í´ë¦­ (4ì )
[StarRating ì»´í¬ë„ŒíŠ¸]
  â†“ onRate(4)
[VideoPlayer.handleRate]
  â†“ POST /api/v1/videos/12/rating {"score": 4}
[ratings API]
  â†“ rating_service.create_or_update_rating()
[PostgreSQL ratings í…Œì´ë¸”]
  â†“ INSERT or UPDATE
[RatingResponse]
  â†“ 200 OK
[VideoPlayer.loadRatingStats]
  â†“ GET /api/v1/videos/12/rating/stats
  â†“ GET /api/v1/videos/12/rating
[í™”ë©´ ì—…ë°ì´íŠ¸]
  - avg_rating: 4.5 â†’ 4.6
  - rating_count: 9 â†’ 10
  - user_rating: null â†’ 4
```

---

## ğŸ“ í–¥í›„ ê°œì„  ì‚¬í•­

### Phase 2 ë‹¤ìŒ ê¸°ëŠ¥
- [ ] ì‹œì²­ ê¸°ë¡ ì‹œìŠ¤í…œ
- [ ] ë¹„ë””ì˜¤ í†µê³„ í˜ì´ì§€
- [ ] ì„±ëŠ¥ ìµœì í™” (ìºì‹±, ë¬´í•œ ìŠ¤í¬ë¡¤)

### í‰ì  ì‹œìŠ¤í…œ ê°œì„ ì•ˆ
- [ ] í‰ì  ë¶„í¬ ê·¸ë˜í”„ (1-5ì  ê° ê°œìˆ˜)
- [ ] í‰ì  ìˆ˜ì • ì´ë ¥ (audit log)
- [ ] í‰ì  ê¸°ë°˜ ì¶”ì²œ ì‹œìŠ¤í…œ
- [ ] ë°˜ì‘í˜• ë³„ì  ì• ë‹ˆë©”ì´ì…˜
- [ ] í‚¤ë³´ë“œ ì ‘ê·¼ì„± ê°œì„  (Tab, Enter)

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. IntegrityError: UNIQUE constraint failed
**ì›ì¸**: ë™ì‹œì— ê°™ì€ ì‚¬ìš©ìê°€ ê°™ì€ ë¹„ë””ì˜¤ì— í‰ì  ë“±ë¡
**í•´ê²°**: Serviceì—ì„œ race condition ì²˜ë¦¬ (try-exceptë¡œ ì¬ì‹œë„)

### 2. 404 Not Found (ë‚´ í‰ì  ì¡°íšŒ)
**ì›ì¸**: ì‚¬ìš©ìê°€ ì•„ì§ í‰ì ì„ ë“±ë¡í•˜ì§€ ì•ŠìŒ
**í•´ê²°**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ 404ë¥¼ ì •ìƒ ì¼€ì´ìŠ¤ë¡œ ì²˜ë¦¬

### 3. í‰ì  í†µê³„ê°€ ê°±ì‹ ë˜ì§€ ì•ŠìŒ
**ì›ì¸**: ìºì‹œ ë¬¸ì œ ë˜ëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸ ëˆ„ë½
**í•´ê²°**: í‰ì  ë“±ë¡ í›„ `loadRatingStats()` í˜¸ì¶œ

---

## ğŸ“Š ì½”ë“œ í†µê³„

### ë°±ì—”ë“œ
- **íŒŒì¼ ì¶”ê°€**: 3ê°œ
  - `models/rating.py` (38 lines)
  - `schemas/rating.py` (38 lines)
  - `services/rating_service.py` (160 lines)
  - `api/v1/ratings.py` (140 lines)
- **íŒŒì¼ ìˆ˜ì •**: 2ê°œ
  - `models/__init__.py` (2 lines)
  - `api/v1/router.py` (2 lines)
- **ë§ˆì´ê·¸ë ˆì´ì…˜**: 1ê°œ (45 lines)

### í”„ë¡ íŠ¸ì—”ë“œ
- **íŒŒì¼ ì¶”ê°€**: 1ê°œ
  - `components/rating/StarRating.tsx` (160 lines)
- **íŒŒì¼ ìˆ˜ì •**: 1ê°œ
  - `pages/VideoPlayer.tsx` (+85 lines)

### ì´ê³„
- **ìƒˆë¡œìš´ ì½”ë“œ**: ~650 lines
- **ìˆ˜ì •ëœ ì½”ë“œ**: ~90 lines
- **ì‘ì—… ì‹œê°„**: ì•½ 1ì‹œê°„

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ratings í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ë° ì ìš©
- [x] Rating ëª¨ë¸ ì •ì˜ (ì œì•½ ì¡°ê±´, ê´€ê³„ ì„¤ì •)
- [x] Rating Schema ì •ì˜ (ê²€ì¦ ê·œì¹™)
- [x] Rating Service êµ¬í˜„ (CRUD, í†µê³„)
- [x] Rating API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [x] API ë¼ìš°í„° ë“±ë¡
- [x] StarRating ì»´í¬ë„ŒíŠ¸ ìƒì„±
- [x] VideoPlayer í˜ì´ì§€ í†µí•©
- [x] ë°±ì—”ë“œ API í…ŒìŠ¤íŠ¸
- [x] í”„ë¡ íŠ¸ì—”ë“œ ë™ì‘ í™•ì¸
- [x] ë¬¸ì„œí™”

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy ORM](https://docs.sqlalchemy.org/en/20/)
- [Alembic Migrations](https://alembic.sqlalchemy.org/)
- [React TypeScript](https://react-typescript-cheatsheet.netlify.app/)
- [Tailwind CSS](https://tailwindcss.com/)

---

**ì‘ì„±ì¼**: 2026-01-13
**ì‘ì„±ì**: Claude Sonnet 4.5
**ë²„ì „**: v0.8
