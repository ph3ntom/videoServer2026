# 03. 시스템 아키텍처

> 라즈베리파이 단일 Docker 컨테이너 구조

## 전체 시스템 구조

```
┌──────────────────────────────────────────────────────────────┐
│                        클라이언트 (브라우저)                      │
│                     React SPA (정적 빌드)                       │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐    │
│  │  홈      │  검색    │  플레이어 │ 카테고리 │  관리자  │    │
│  │(그리드)  │(키워드+  │ (Video.js)│ (브라우징)│ (비디오  │    │
│  │          │ 태그조합)│          │          │  등록)   │    │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘    │
└──────────────────────────────────────────────────────────────┘
                            │
                         HTTP (HTTPS 추후)
                            │
┌──────────────────────────────────────────────────────────────┐
│           라즈베리파이 4B/5 (8GB RAM) - Docker 컨테이너         │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                    Nginx (포트 80/443)                  │  │
│  │  - React 정적 파일 서빙 (~50MB)                         │  │
│  │  - /api/* → FastAPI 리버스 프록시                       │  │
│  │  - gzip 압축, 정적 파일 캐싱                            │  │
│  └─────────────────────┬──────────────────────────────────┘  │
│                        │                                      │
│  ┌─────────────────────▼──────────────────────────────────┐  │
│  │                FastAPI (~200MB)                         │  │
│  │  ┌─────────────────────────────────────────────────┐   │  │
│  │  │ Middleware: CORS │ Auth │ Logging              │   │  │
│  │  └─────────────────────────────────────────────────┘   │  │
│  │                                                          │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │  │
│  │  │Auth      │  │Video     │  │Search    │  │Admin   │ │  │
│  │  │Service   │  │Service   │  │Service   │  │Service │ │  │
│  │  │          │  │          │  │          │  │        │ │  │
│  │  │-로그인    │  │-등록(A)  │  │-제목검색 │  │-태그   │ │  │
│  │  │-JWT발급  │  │-스트리밍 │  │-태그조합 │  │ 관리   │ │  │
│  │  │-RBAC     │  │-썸네일   │  │-카테고리 │  │-통계   │ │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └────────┘ │  │
│  └──────────────────────┬───────────────────────────────┘  │
│                         │                                   │
│  ┌──────────────────────▼───────────────────────────────┐  │
│  │            PostgreSQL (~100MB)                       │  │
│  │  - users, videos, tags, video_tags                   │  │
│  │  - video_thumbnails, categories, watch_history       │  │
│  │  - ratings (Phase 2)                                 │  │
│  │  - GIN 인덱스 (태그 검색), Full-Text (제목 검색)      │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────▼─────────┐                   ┌─────────▼────────┐
│  외장 하드 (4TB) │                   │   FFmpeg         │
│  /mnt/videos     │                   │   (온디맨드)      │
│  /mnt/thumbnails │                   │   - 썸네일 생성   │
│                  │                   │   - 장면 감지     │
│  (볼륨 마운트)    │                   │   (~50MB)        │
└──────────────────┘                   └──────────────────┘
```

## 백엔드 아키텍처 (FastAPI)

### 디렉토리 구조

```
backend/
├── app/
│   ├── main.py                 # FastAPI 앱 진입점
│   ├── config.py               # 설정 관리
│   ├── database.py             # DB 연결 및 세션
│   │
│   ├── api/                    # API 라우터
│   │   ├── __init__.py
│   │   ├── deps.py             # 의존성 (인증 등)
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py         # 인증 API
│   │   │   ├── users.py        # 사용자 API
│   │   │   ├── videos.py       # 비디오 API (공개)
│   │   │   ├── categories.py   # 카테고리 API
│   │   │   ├── search.py       # 검색 API (제목+태그)
│   │   │   ├── tags.py         # 추가: 태그 API
│   │   │   └── admin.py        # 관리자 API (비디오 등록, 태그 관리)
│   │
│   ├── core/                   # 핵심 기능
│   │   ├── __init__.py
│   │   ├── security.py         # 인증/보안 유틸
│   │   ├── config.py           # 설정 클래스
│   │   └── constants.py        # 상수
│   │
│   ├── models/                 # SQLAlchemy 모델
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── video.py
│   │   ├── tag.py            # 추가: 태그 모델
│   │   ├── video_tag.py      # 추가: N:M 관계
│   │   ├── video_thumbnail.py # 추가: 썸네일 모델
│   │   ├── category.py
│   │   ├── watch_history.py
│   │   └── rating.py         # Phase 2
│   │
│   ├── schemas/                # Pydantic 스키마
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── video.py
│   │   ├── tag.py            # 추가: 태그 스키마
│   │   ├── thumbnail.py      # 추가: 썸네일 스키마
│   │   ├── category.py
│   │   └── token.py
│   │
│   ├── repositories/           # 데이터 접근 계층
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── user.py
│   │   ├── video.py
│   │   ├── tag.py            # 추가: 태그 저장소
│   │   └── category.py
│   │
│   ├── services/               # 비즈니스 로직
│   │   ├── __init__.py
│   │   ├── auth_service.py
│   │   ├── user_service.py
│   │   ├── video_service.py
│   │   ├── upload_service.py
│   │   ├── streaming_service.py
│   │   ├── thumbnail_service.py    # 추가: 썸네일 생성
│   │   └── search_service.py       # 추가: 검색 로직
│   │
│   ├── middleware/             # 미들웨어
│   │   ├── __init__.py
│   │   ├── logging.py
│   │   └── error_handler.py
│   │
│   └── utils/                  # 유틸리티
│       ├── __init__.py
│       ├── video_processor.py  # FFmpeg 처리
│       ├── file_handler.py     # 파일 업로드/다운로드
│       └── validators.py       # 검증 함수
│
├── alembic/                    # DB 마이그레이션
│   ├── versions/
│   └── env.py
│
├── tests/                      # 테스트
│   ├── conftest.py
│   ├── test_api/
│   ├── test_services/
│   └── test_repositories/
│
├── uploads/                    # 업로드된 파일 (로컬 개발용)
│   ├── videos/
│   └── thumbnails/
│   # 프로덕션: /mnt/videos, /mnt/thumbnails (외장 하드 마운트)
│
├── requirements.txt
├── pyproject.toml
└── README.md
```

### 계층별 책임

#### 1. API Layer (라우터)
- HTTP 요청/응답 처리
- 요청 데이터 검증 (Pydantic)
- 인증/권한 확인
- 서비스 계층 호출

```python
# 예시: app/api/v1/videos.py
@router.post("/", response_model=VideoResponse)
async def create_video(
    video_data: VideoCreate,
    current_user: User = Depends(get_current_user),
    video_service: VideoService = Depends()
):
    return await video_service.create_video(video_data, current_user)
```

#### 2. Service Layer (비즈니스 로직)
- 비즈니스 규칙 구현
- 여러 Repository 조율
- 트랜잭션 관리
- 외부 서비스 통합

```python
# 예시: app/services/video_service.py
class VideoService:
    async def create_video(self, video_data: VideoCreate, user: User):
        # 1. 비디오 메타데이터 저장
        video = await self.video_repo.create(video_data, user.id)

        # 2. 썸네일 생성 (비동기 작업)
        await self.upload_service.generate_thumbnail(video.id)

        # 3. 트랜스코딩 작업 큐에 추가
        await self.queue_transcoding_task(video.id)

        return video
```

#### 3. Repository Layer (데이터 접근)
- 데이터베이스 CRUD 작업
- 쿼리 최적화
- ORM 상호작용

```python
# 예시: app/repositories/video.py
class VideoRepository(BaseRepository[Video]):
    async def find_by_category(self, category_id: int):
        return await self.db.execute(
            select(Video).where(Video.category_id == category_id)
        )
```

#### 4. Model Layer (데이터 모델)
- SQLAlchemy ORM 모델
- 데이터베이스 테이블 정의
- 관계 매핑

## 프론트엔드 아키텍처 (React)

### 디렉토리 구조

```
frontend/
├── public/
│   ├── index.html
│   └── favicon.ico
│
├── src/
│   ├── main.tsx               # 앱 진입점
│   ├── App.tsx                # 루트 컴포넌트
│   │
│   ├── pages/                 # 페이지 컴포넌트
│   │   ├── HomePage.tsx
│   │   ├── LoginPage.tsx
│   │   ├── VideoDetailPage.tsx
│   │   ├── ProfilePage.tsx
│   │   ├── SearchPage.tsx
│   │   └── AdminDashboard.tsx
│   │
│   ├── components/            # 재사용 컴포넌트
│   │   ├── common/           # 공통 컴포넌트
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Modal.tsx
│   │   │   └── Loading.tsx
│   │   │
│   │   ├── layout/           # 레이아웃
│   │   │   ├── Header.tsx
│   │   │   ├── Footer.tsx
│   │   │   └── Sidebar.tsx
│   │   │
│   │   ├── video/            # 비디오 관련
│   │   │   ├── VideoCard.tsx
│   │   │   ├── VideoPlayer.tsx
│   │   │   ├── VideoList.tsx
│   │   │   └── VideoUpload.tsx
│   │   │
│   │   └── auth/             # 인증 관련
│   │       ├── LoginForm.tsx
│   │       └── RegisterForm.tsx
│   │
│   ├── hooks/                # Custom Hooks
│   │   ├── useAuth.ts
│   │   ├── useVideo.ts
│   │   └── useInfiniteScroll.ts
│   │
│   ├── store/                # 상태 관리
│   │   ├── authStore.ts
│   │   ├── videoStore.ts
│   │   └── uiStore.ts
│   │
│   ├── services/             # API 서비스
│   │   ├── api.ts            # Axios 인스턴스
│   │   ├── authService.ts
│   │   ├── videoService.ts
│   │   └── userService.ts
│   │
│   ├── types/                # TypeScript 타입
│   │   ├── user.ts
│   │   ├── video.ts
│   │   └── api.ts
│   │
│   ├── utils/                # 유틸리티
│   │   ├── format.ts
│   │   ├── validation.ts
│   │   └── constants.ts
│   │
│   ├── routes/               # 라우팅
│   │   ├── index.tsx
│   │   └── ProtectedRoute.tsx
│   │
│   └── styles/               # 스타일
│       ├── globals.css
│       └── theme.ts
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

### 컴포넌트 설계 원칙

1. **단일 책임 원칙**: 각 컴포넌트는 하나의 명확한 역할
2. **재사용성**: 공통 컴포넌트는 props를 통해 커스터마이징
3. **Container/Presenter 패턴**:
   - Container: 데이터 페칭, 상태 관리
   - Presenter: UI 렌더링만 담당

## 데이터 흐름

### 비디오 업로드 플로우 (관리자 전용)

```
1. 관리자가 Admin 페이지에서 파일 선택
   - 제목, 설명, 카테고리 입력
   - 태그 선택 (체크박스)
   ↓
2. Frontend: 파일 검증 (크기, 형식: mp4/mkv/avi/mov)
   ↓
3. POST /api/v1/admin/videos/upload (multipart/form-data)
   Header: Authorization: Bearer <admin_token>
   ↓
4. Backend API Layer:
   - JWT 토큰 검증 (admin 권한 확인)
   - 파일 수신 및 임시 저장
   ↓
5. Video Service:
   - 비디오 파일을 /mnt/videos로 이동
   - FFmpeg로 메타데이터 추출 (duration, resolution, codec)
   - DB에 비디오 메타데이터 저장
   ↓
6. Thumbnail Service (백그라운드):
   - FFmpeg 장면 전환 감지 (scene detection)
   - 10-15개 썸네일 자동 생성
   - /mnt/thumbnails에 저장
   - video_thumbnails 테이블에 저장
   - 첫 번째 썸네일을 기본 선택
   ↓
7. Tag Service:
   - 선택된 태그를 video_tags 테이블에 저장
   ↓
8. Response: 비디오 ID 및 메타데이터 반환
   ↓
9. Frontend: 업로드 성공 알림 및 썸네일 선택 UI 표시
```

### 비디오 스트리밍 플로우

```
1. 사용자가 그리드 레이아웃에서 비디오 썸네일 클릭
   ↓
2. GET /api/v1/videos/{video_id}
   ↓
3. Backend: 비디오 메타데이터 반환 (제목, 설명, duration, 태그 등)
   ↓
4. Frontend: VideoPlayer 컴포넌트 (Video.js) 렌더링
   ↓
5. VideoPlayer가 GET /api/v1/videos/{video_id}/stream 요청
   Request Header: Range: bytes=0-
   ↓
6. Backend Streaming Service:
   - HTTP 206 Partial Content 응답
   - Accept-Ranges: bytes
   - Content-Type: video/mp4
   - 직접 파일 스트리밍 (트랜스코딩 없음)
   ↓
7. 사용자가 시청하는 동안:
   - 10초마다 시청 진행률 업데이트
   - PUT /api/v1/videos/{video_id}/watch-progress
   - Body: { progress: 120 } (초 단위)
   ↓
8. Phase 2: 시청 완료시 watch_history 테이블 업데이트
```

### 태그 조합 검색 플로우

```
1. 사용자가 검색 페이지에서 태그 선택
   - 체크박스로 태그 선택: [한국영화] [공상과학] [전쟁영화]
   - 연산자 선택: [포함] [포함] [제외]
   ↓
2. GET /api/v1/search/videos/advanced
   ?include_tags=korean-movie,sci-fi
   &exclude_tags=war-movie
   ↓
3. Backend Search Service:
   - PostgreSQL 복합 쿼리 실행
   - GIN 인덱스 활용
   ```sql
   SELECT DISTINCT v.*
   FROM videos v
   INNER JOIN video_tags vt1 ON v.id = vt1.video_id
   INNER JOIN tags t1 ON vt1.tag_id = t1.id
     AND t1.slug IN ('korean-movie', 'sci-fi')
   WHERE v.id NOT IN (
       SELECT vt2.video_id FROM video_tags vt2
       INNER JOIN tags t2 ON vt2.tag_id = t2.id
         AND t2.slug = 'war-movie'
   )
   GROUP BY v.id
   HAVING COUNT(DISTINCT t1.slug) = 2
   ```
   ↓
4. Response: 필터링된 비디오 목록 (썸네일 포함)
   ↓
5. Frontend: 그리드 레이아웃으로 결과 표시
```

### 썸네일 호버 미리보기 플로우

```
1. 사용자가 비디오 썸네일 위에 마우스 오버
   ↓
2. Frontend: 호버 이벤트 감지
   ↓
3. GET /api/v1/videos/{video_id}/thumbnails
   ↓
4. Backend: 해당 비디오의 모든 썸네일 URL 반환
   - 10-15개 썸네일 URL 배열
   ↓
5. Frontend: 1초 간격으로 썸네일 순환 표시
   - CSS transition으로 자연스러운 전환
   - 마우스 아웃시 기본 썸네일로 복귀
```

### 인증 플로우

```
1. 로그인 요청
   POST /api/v1/auth/login
   Body: { email, password }
   ↓
2. Backend: 자격 증명 검증
   - 이메일로 사용자 조회
   - 비밀번호 해시 비교
   ↓
3. JWT 토큰 생성
   - Access Token (15분)
   - Refresh Token (7일)
   ↓
4. Frontend: 토큰 저장
   - localStorage 또는 httpOnly Cookie
   - Zustand/Redux store 업데이트
   ↓
5. 이후 요청에 Authorization 헤더 포함
   Authorization: Bearer <access_token>
   ↓
6. Backend Middleware: 토큰 검증
   - 서명 확인
   - 만료 시간 확인
   - 사용자 정보 추출
```

## 보안 고려사항

### 인증 & 인가
- JWT 기반 인증
- Refresh Token 로테이션
- Role-based Access Control (RBAC)

### 데이터 보호
- 비밀번호 bcrypt 해싱 (salt rounds: 12)
- HTTPS only (프로덕션)
- SQL Injection 방지 (ORM 사용)
- XSS 방지 (입력 검증, 출력 이스케이프)

### 파일 업로드 보안
- 파일 타입 검증 (MIME type + 확장자)
- 파일 크기 제한
- 파일명 새니타이징
- 스캔 (바이러스/악성코드)

### API 보안
- Rate Limiting
- CORS 설정
- Request Validation

## 성능 최적화 (라즈베리파이 환경)

### 백엔드 최적화
1. **메모리 절약**:
   - FastAPI 단일 워커 프로세스
   - PostgreSQL 최소 설정 (shared_buffers: 256MB)
   - 커넥션 풀 제한 (max_connections: 20)

2. **쿼리 최적화**:
   - GIN 인덱스 (태그 검색)
   - Full-Text Search 인덱스 (제목 검색)
   - N+1 문제 방지 (joinedload, selectinload)

3. **비동기 처리**:
   - 썸네일 생성: 백그라운드 작업
   - FFmpeg 작업: 큐잉 시스템
   - 비동기 I/O (asyncio, asyncpg)

### 프론트엔드 최적화
1. **번들 크기 최소화**:
   - Code Splitting (React.lazy)
   - Tree Shaking (Vite)
   - 경량 라이브러리 선택 (Zustand ~1KB)

2. **렌더링 최적화**:
   - 이미지 Lazy Loading
   - Intersection Observer (썸네일 로딩)
   - Debouncing (검색 입력: 300ms)

3. **캐싱**:
   - React Query 캐싱 (5분)
   - 정적 파일 Nginx 캐싱

### 비디오 스트리밍 최적화
1. **직접 스트리밍**:
   - HTTP Range Requests (206)
   - 트랜스코딩 없음 (CPU 절약)
   - Progressive Download

2. **썸네일 최적화**:
   - WebP 형식 (JPEG 대비 30% 절약)
   - 해상도 제한 (320x180)
   - Nginx 정적 파일 캐싱

3. **네트워크 최적화**:
   - Nginx gzip 압축 (level 6)
   - 정적 파일 브라우저 캐싱 (7일)
   - Keep-Alive 연결
