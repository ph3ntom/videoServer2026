# Phase 2.9: 성능 최적화

**날짜**: 2026-01-15
**버전**: Phase 2.9
**상태**: ✅ 완료

---

## 📋 개요

백엔드 및 프론트엔드 성능을 향상시키기 위한 최적화 작업을 수행했습니다.

---

## 🎯 최적화 목표

1. **백엔드**: DB 쿼리 성능 향상
2. **프론트엔드**: 초기 로딩 속도 개선 및 렌더링 최적화

---

## 🔧 구현 내역

### 1. 백엔드 최적화

#### 1.1 DB 인덱스 추가

**파일**: `backend/alembic/versions/20260115_1400_a1b2c3d4e5f6_add_performance_indexes.py`

**추가된 인덱스**:

1. **`ix_videos_view_count`** - videos.view_count 단독 인덱스
   - 용도: 조회수순 정렬 쿼리 최적화
   - 영향: 인기 동영상 조회 성능 향상

2. **`ix_videos_status_view_count`** - (videos.status, videos.view_count) 복합 인덱스
   - 용도: 상태 필터링 + 조회수 정렬 최적화
   - 영향: `WHERE status = 'ready' ORDER BY view_count` 쿼리 성능 향상

3. **`ix_videos_status_created_at`** - (videos.status, videos.created_at) 복합 인덱스
   - 용도: 상태 필터링 + 최신순 정렬 최적화
   - 영향: 최신 동영상 조회 성능 향상

4. **`ix_ratings_video_id`** - ratings.video_id 단독 인덱스
   - 용도: 평균 평점 계산 JOIN 최적화
   - 영향: 평점순 정렬 및 평점 집계 쿼리 성능 향상

**적용 방법**:
```bash
cd backend
source venv/bin/activate
alembic upgrade head
```

**영향 받는 쿼리**:
- `GET /videos/paginated?sort_by=view_count` - 조회수순 정렬
- `GET /videos/paginated?sort_by=rating` - 평점순 정렬
- `GET /statistics/popular` - 인기 동영상 조회
- `GET /statistics/top-rated` - 높은 평점 동영상 조회

---

#### 1.2 N+1 쿼리 검토

**검토 결과**: ✅ 이미 최적화됨

모든 주요 서비스에서 **eager loading** 사용 중:

- **video_service.py**:
  ```python
  query = select(Video).options(
      selectinload(Video.uploader),
      selectinload(Video.tags)
  )
  ```

- **statistics_service.py**:
  ```python
  query = select(Video).options(
      joinedload(Video.uploader)
  )
  ```

- **watch_history_service.py**: joinedload 사용
- **tag_service.py**: eager loading 구현

**결론**: 백엔드에서 N+1 쿼리 문제는 이미 잘 해결되어 있음

---

### 2. 프론트엔드 최적화

#### 2.1 VideoCard 컴포넌트 메모이제이션

**파일**: `frontend/src/components/video/VideoCard.tsx`

**변경 사항**:

1. **React.memo로 컴포넌트 감싸기**
   ```typescript
   function VideoCard({ video }: VideoCardProps) {
     // ... component logic
   }

   export default memo(VideoCard);
   ```
   - 효과: 부모 컴포넌트 리렌더링 시 불필요한 VideoCard 리렌더링 방지

2. **useCallback으로 함수 메모이제이션**
   ```typescript
   const formatDuration = useCallback((seconds: number | null) => {
     // ...
   }, []);

   const formatDate = useCallback((dateString: string) => {
     // ...
   }, []);

   const handleMouseEnter = useCallback(() => {
     // ...
   }, [thumbnails.length]);

   const handleMouseLeave = useCallback(() => {
     // ...
   }, []);
   ```
   - 효과: 매 렌더링마다 함수 재생성 방지

3. **useMemo로 계산 값 메모이제이션**
   ```typescript
   const getThumbnailUrl = useMemo(() => {
     if (isHovering && thumbnails.length > 0) {
       const thumbnail = thumbnails[currentThumbnailIndex];
       return `${import.meta.env.VITE_API_BASE_URL}/api/v1/videos/${video.id}/thumbnails/${thumbnail.id}/image`;
     }
     return `${import.meta.env.VITE_API_BASE_URL}/api/v1/videos/${video.id}/thumbnail`;
   }, [isHovering, thumbnails, currentThumbnailIndex, video.id]);
   ```
   - 효과: URL 계산 결과 캐싱, 불필요한 재계산 방지

**성능 향상**:
- VideoCard 리렌더링 횟수 감소
- 함수 재생성으로 인한 메모리 할당 감소
- 자식 컴포넌트 props 안정성 향상

---

#### 2.2 Code Splitting (React.lazy)

**파일**: `frontend/src/App.tsx`

**변경 사항**:

1. **페이지 컴포넌트 lazy loading**
   ```typescript
   import { lazy, Suspense } from 'react'

   // 인증 페이지는 즉시 로드 (초기 화면)
   import Login from './pages/Login'
   import Register from './pages/Register'
   import VerifyEmail from './pages/VerifyEmail'

   // 보호된 페이지는 lazy load
   const Home = lazy(() => import('./pages/Home'))
   const Videos = lazy(() => import('./pages/Videos'))
   const VideoPlayer = lazy(() => import('./pages/VideoPlayer'))
   const UploadVideo = lazy(() => import('./pages/UploadVideo'))
   const SearchPage = lazy(() => import('./pages/SearchPage'))
   const ProfilePage = lazy(() => import('./pages/ProfilePage'))
   const PopularVideos = lazy(() => import('./pages/PopularVideos'))
   const TopRatedVideos = lazy(() => import('./pages/TopRatedVideos'))
   const AllVideos = lazy(() => import('./pages/AllVideos'))
   ```

2. **Suspense로 로딩 처리**
   ```typescript
   const PageLoader = () => (
     <div className="min-h-screen bg-gray-900 flex items-center justify-center">
       <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
     </div>
   )

   return (
     <ErrorBoundary>
       <Router>
         <Suspense fallback={<PageLoader />}>
           <Routes>
             {/* ... routes */}
           </Routes>
         </Suspense>
       </Router>
     </ErrorBoundary>
   )
   ```

**성능 향상**:
- **초기 번들 크기 감소**: 인증 페이지만 초기 로드
- **필요시 로드**: 각 페이지는 사용자가 접근할 때만 로드
- **병렬 다운로드**: 여러 청크를 병렬로 다운로드 가능
- **캐싱 효율성**: 변경되지 않은 청크는 브라우저 캐시 활용

---

## 📁 수정된 파일

### 백엔드 (1개)
- `backend/alembic/versions/20260115_1400_a1b2c3d4e5f6_add_performance_indexes.py` (신규) - DB 인덱스 마이그레이션

### 프론트엔드 (2개)
- `frontend/src/components/video/VideoCard.tsx` - React.memo, useCallback, useMemo 적용
- `frontend/src/App.tsx` - React.lazy, Suspense 적용

---

## 📊 예상 성능 향상

### 백엔드

1. **조회수순 정렬 쿼리**
   - 변경 전: Full table scan + sort
   - 변경 후: Index scan (ix_videos_status_view_count)
   - 예상 향상: **50-80% 빠름** (동영상 개수에 비례)

2. **평점순 정렬 쿼리**
   - 변경 전: Rating 테이블 full scan + join
   - 변경 후: Index scan (ix_ratings_video_id) + join
   - 예상 향상: **40-60% 빠름**

3. **최신순 정렬 쿼리**
   - 변경 전: created_at 단독 인덱스 사용
   - 변경 후: 복합 인덱스 (ix_videos_status_created_at) 사용
   - 예상 향상: **20-30% 빠름** (status 필터링 시)

### 프론트엔드

1. **초기 로딩 속도**
   - 변경 전: 모든 페이지 컴포넌트 번들에 포함
   - 변경 후: 인증 페이지만 초기 로드
   - 예상 향상: **초기 번들 크기 60-70% 감소**

2. **VideoCard 렌더링**
   - 변경 전: 부모 리렌더링마다 모든 카드 리렌더링
   - 변경 후: React.memo로 불필요한 리렌더링 방지
   - 예상 향상: **리렌더링 횟수 70-90% 감소**

3. **메모리 사용량**
   - 변경 전: 함수 객체 매번 재생성
   - 변경 후: useCallback으로 함수 재사용
   - 예상 향상: **메모리 할당 30-50% 감소**

---

## 🧪 테스트 체크리스트

### 백엔드
- [ ] 마이그레이션 성공적으로 적용됨
- [ ] 인덱스 생성 확인 (psql `\di` 명령어)
- [ ] 조회수순 정렬 API 테스트
- [ ] 평점순 정렬 API 테스트
- [ ] 인기 동영상 API 테스트
- [ ] 쿼리 실행 계획 확인 (EXPLAIN ANALYZE)

### 프론트엔드
- [ ] 앱 정상 로딩
- [ ] 로그인 페이지 즉시 표시
- [ ] 보호된 페이지 lazy load 확인
- [ ] VideoCard 호버 애니메이션 정상 작동
- [ ] 페이지 전환 시 스피너 표시
- [ ] 브라우저 개발자 도구 Network 탭에서 청크 분할 확인

---

## 💡 최적화 기법 요약

### 백엔드
1. **인덱스 최적화**
   - 자주 사용되는 정렬 컬럼에 인덱스 추가
   - 복합 인덱스로 WHERE + ORDER BY 쿼리 최적화
   - JOIN 성능 향상을 위한 외래 키 인덱스

2. **N+1 쿼리 방지**
   - selectinload, joinedload 사용
   - 필요한 관계만 eager loading

### 프론트엔드
1. **React 최적화**
   - React.memo: 컴포넌트 메모이제이션
   - useCallback: 함수 메모이제이션
   - useMemo: 계산 값 메모이제이션

2. **번들 최적화**
   - Code Splitting: 페이지별 청크 분할
   - Lazy Loading: 필요시 로드
   - Tree Shaking: 미사용 코드 제거 (Vite 자동)

---

## 🔜 추가 최적화 아이디어

### 백엔드
1. **Redis 캐싱** (선택적)
   - API 응답 캐싱
   - 조회수 카운터 캐싱
   - 세션 저장소

2. **데이터베이스 최적화**
   - 커넥션 풀링 튜닝
   - 쿼리 튜닝 (EXPLAIN ANALYZE 활용)
   - 파티셔닝 (대용량 데이터 시)

### 프론트엔드
1. **이미지 최적화** (이미 구현됨)
   - Lazy loading (Intersection Observer)
   - 썸네일 프리로딩

2. **추가 최적화**
   - Service Worker (오프라인 지원)
   - 프리페칭 (다음 페이지 미리 로드)
   - Virtual Scrolling (무한 스크롤 시)

---

## ✅ 완료 확인

- [x] DB 인덱스 마이그레이션 생성
- [x] 마이그레이션 적용 (alembic upgrade head)
- [x] N+1 쿼리 검토 완료
- [x] VideoCard React.memo 적용
- [x] VideoCard useCallback 적용
- [x] VideoCard useMemo 적용
- [x] App.tsx React.lazy 적용
- [x] App.tsx Suspense 추가
- [x] PageLoader 컴포넌트 구현

---

## 📝 참고 문서

- [PostgreSQL 인덱스 최적화](https://www.postgresql.org/docs/current/indexes.html)
- [SQLAlchemy Eager Loading](https://docs.sqlalchemy.org/en/20/orm/queryguide/relationships.html)
- [React.memo](https://react.dev/reference/react/memo)
- [useCallback](https://react.dev/reference/react/useCallback)
- [useMemo](https://react.dev/reference/react/useMemo)
- [React.lazy](https://react.dev/reference/react/lazy)
- [Code Splitting](https://react.dev/learn/code-splitting)

---

**작성일**: 2026-01-15
**작성자**: Claude Sonnet 4.5
**버전**: Phase 2.9
**상태**: ✅ 최적화 완료
