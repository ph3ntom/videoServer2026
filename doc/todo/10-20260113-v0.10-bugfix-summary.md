# v0.10 버그 수정 요약

**날짜**: 2026-01-13
**상태**: ✅ 완료
**우선순위**: Critical

---

## 🎯 작업 개요

v0.9에서 구현한 시청 기록 시스템과 통계 기능의 실제 브라우저 테스트 중 발견된 4개의 치명적 버그를 수정했습니다.

---

## 🐛 수정된 버그 목록

### 1. ✅ Watch History API 500 에러
**파일**: `backend/app/api/v1/watch_history.py`
- **문제**: `AttributeError: property 'progress_percentage' of 'WatchHistory' object has no setter`
- **수정**: 불필요한 property setter 코드 제거 (Lines 51-53)
- **결과**: 이어보기 기능 정상 작동

### 2. ✅ 조회수 증가 안됨
**파일**:
- `backend/app/api/v1/videos.py` - POST /videos/{video_id}/view 엔드포인트 추가
- `frontend/src/pages/VideoPlayer.tsx` - player.ready()에서 API 호출

- **문제**: Range request로 인해 조회수 증가 로직이 실행되지 않음
- **수정**: 별도 API 엔드포인트 생성 및 프론트엔드에서 명시적 호출
- **결과**: 조회수 정상 증가 (4 → 5 확인)

### 3. ✅ 높은 평점 섹션 표시 안됨
**파일**: `frontend/src/pages/Videos.tsx`
- **문제**: min_ratings=3 설정으로 필터링되어 표시할 동영상 없음
- **수정**: min_ratings=3 → 1로 변경 (Line 119)
- **결과**: 평점 섹션에 3개 동영상 표시

### 4. ✅ 이어보기 알림 페이지 새로고침 시 표시 안됨 (CRITICAL)
**파일**:
- `frontend/src/App.tsx` - loadUser() 초기화 추가 (CRITICAL FIX)
- `frontend/src/pages/VideoPlayer.tsx` - Watch history 체크 로직 분리

**문제**:
- 페이지 새로고침(F5) 시 이어보기 알림 표시 안됨
- 뒤로가기 후 재접근 시 알림 표시 안됨
- 메인 페이지를 통해서만 접근 가능

**근본 원인**:
- App.tsx에서 loadUser()를 호출하지 않아 user 상태가 null로 유지됨
- localStorage에 access_token이 있어도 상태가 복원되지 않음

**수정**:
1. **App.tsx**: 앱 마운트 시 loadUser() 호출하여 인증 상태 복원
2. **VideoPlayer.tsx**: Watch history 체크를 별도 useEffect로 분리, dependencies에 user 추가

**결과**:
- 새로고침 시 이어보기 알림 표시 ✅
- 뒤로가기 후 재접근 시 알림 표시 ✅
- 사용자 확인: "정상 작동한다" ✅

---

## 📊 새로 추가된 기능

### 통계 시스템 (Statistics API)
**파일**:
- `backend/app/api/v1/statistics.py` (신규)
- `backend/app/services/statistics_service.py` (신규)

**기능**:
1. `GET /statistics/popular` - 조회수 기준 인기 동영상
2. `GET /statistics/top-rated` - 평점 기준 높은 평점 동영상

### Videos 페이지 통계 섹션
**파일**: `frontend/src/pages/Videos.tsx`

**추가된 섹션**:
1. **인기 비디오** - 조회수 기준 8개 표시
2. **높은 평점** - 평균 평점 기준 8개 표시 (별점 배지)
3. **이어보기** - 사용자별 시청 중인 동영상 6개 표시

---

## 🧪 테스트 완료

- [x] Watch history 저장 정상 작동
- [x] 조회수 증가 확인 (4 → 5)
- [x] 높은 평점 섹션 표시 (3개 동영상)
- [x] 이어보기 알림 - 페이지 새로고침 ✅
- [x] 이어보기 알림 - 뒤로가기 후 재접근 ✅
- [x] 이어보기 알림 - 직접 URL 접근 ✅
- [x] 사용자 최종 확인: "정상 작동한다"

---

## 📁 수정된 파일

### 백엔드
- `backend/app/api/v1/watch_history.py` - Property setter 제거
- `backend/app/api/v1/videos.py` - View increment 엔드포인트 추가
- `backend/app/api/v1/router.py` - Router 수정
- `backend/app/api/v1/statistics.py` - 통계 API (신규)
- `backend/app/services/statistics_service.py` - 통계 서비스 (신규)

### 프론트엔드
- `frontend/src/App.tsx` - loadUser() 초기화 (CRITICAL)
- `frontend/src/pages/VideoPlayer.tsx` - Watch history 로직 분리, View increment
- `frontend/src/pages/Videos.tsx` - min_ratings 조정, 통계 섹션

---

## 💡 핵심 교훈

1. **인증 상태 초기화의 중요성**
   - SPA에서 새로고침 시 localStorage 확인하여 상태 복원 필수
   - App 마운트 시 loadUser() 호출

2. **useEffect Dependencies**
   - 비동기 상태(user)에 의존하는 로직은 dependency 배열에 포함

3. **비즈니스 로직과 스트림 요청 분리**
   - Range request와 무관하게 작동하도록 별도 엔드포인트 사용

4. **실제 데이터 기반 설정**
   - min_ratings 같은 필터값은 실제 데이터 상황을 고려

---

## 🔜 다음 작업

**Phase 2.7**: 정렬 & 페이지네이션 개선
- 인기 동영상/높은 평점: 8개 → 20개 (4x5 그리드)
- 전체 동영상: 페이지네이션 (20개/페이지)
- 정렬 옵션: 조회수순, 별점순, 최신순

**문서**: `doc/todo/08-20260113-정렬및페이지네이션개선.md`

---

**작성일**: 2026-01-13
**완료 시간**: 오후
**상태**: ✅ 모든 버그 수정 완료 및 테스트 완료
