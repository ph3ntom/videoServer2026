# Phase 3.2: HLS 스트리밍 구현

**날짜**: 2026-01-30
**상태**: ✅ 완료
**우선순위**: High

---

## 🎯 목표

YouTube/Netflix와 같은 적응형 비트레이트 스트리밍(Adaptive Bitrate Streaming) 구현
- 네트워크 상황에 따른 자동 화질 조정
- 수동 화질 선택 지원 (480p/720p/1080p)
- 버퍼링 없는 부드러운 화질 전환

---

## ✅ 완료된 작업

### 1. 백엔드: HLS 변환 서비스 구현

**신규 파일**: `backend/app/services/hls_service.py`

**핵심 기능**:
- FFmpeg 기반 비디오 → HLS 세그먼트 변환
- 화질별 playlist.m3u8 생성 (480p, 720p, 1080p)
- master.m3u8 마스터 플레이리스트 생성
- HLS 변환 상태 확인

**파일 구조**:
```
/storage/videos/UUID_hls/
  ├── master.m3u8 (마스터 플레이리스트)
  ├── 480p/
  │   ├── playlist.m3u8
  │   ├── segment0.ts
  │   ├── segment1.ts
  │   └── segment2.ts
  ├── 720p/
  │   ├── playlist.m3u8
  │   └── segments...
  └── 1080p/
      ├── playlist.m3u8
      └── segments...
```

### 2. 백엔드: HLS API 엔드포인트 추가

**파일**: `backend/app/api/v1/videos.py`

**추가된 엔드포인트**:
- `POST /videos/{id}/convert-hls` - HLS 변환 시작
- `GET /videos/{id}/hls/master.m3u8` - 마스터 플레이리스트
- `GET /videos/{id}/hls/{quality}/playlist.m3u8` - 화질별 플레이리스트
- `GET /videos/{id}/hls/{quality}/{segment}` - 세그먼트 파일 (.ts)
- `GET /videos/{id}/hls/status` - 변환 상태 확인

### 3. 백엔드: 트랜스코딩 서비스 추가

**신규 파일**: `backend/app/services/transcoding_service.py`

**핵심 기능**:
- 기존 화질 전환 로직 분리 및 정리
- 파일 유효성 검증 (ffprobe)
- 트랜스코딩 파일 캐싱
- 원본 해상도 체크 (불필요한 업스케일링 방지)

### 4. 프론트엔드: video.js HLS 지원

**파일**: `frontend/src/pages/VideoPlayer.tsx`

**핵심 기능**:
- HLS 자동 감지 및 재생
- master.m3u8 vs 특정 화질 playlist.m3u8 선택
- Adaptive bitrate streaming 지원
- 현재 재생 화질 실시간 모니터링

### 5. 프론트엔드: 화질 선택 UI 개선

**추가된 기능**:
- **자동 모드**: 네트워크 상황에 따라 자동 화질 조정
- **수동 모드**: 480p, 720p, 1080p 중 선택
- **HLS 변환 버튼**: 업로더가 HLS로 변환 시작
- **현재 재생 화질 표시**: "📺 현재 재생 중: 720p"
- **HLS 상태 표시**: 변환 완료/진행중/변환 가능

### 6. 프론트엔드: 패키지 추가

**파일**: `frontend/package.json`

**추가된 패키지**:
- `videojs-contrib-quality-levels` - HLS 화질 관리

---

## 📁 수정된 파일

### 백엔드 (3개)
- `backend/app/services/hls_service.py` (신규)
- `backend/app/services/transcoding_service.py` (신규)
- `backend/app/api/v1/videos.py` (수정)

### 프론트엔드 (3개)
- `frontend/src/pages/VideoPlayer.tsx` (수정)
- `frontend/package.json` (수정)
- `frontend/package-lock.json` (수정)

---

## 🎬 작동 방식

### HLS 변환 플로우

1. **변환 시작**: 사용자가 "HLS로 변환하기" 버튼 클릭
2. **백그라운드 변환**: FFmpeg가 480p/720p/1080p 세그먼트 생성
3. **플레이리스트 생성**: 각 화질별 playlist.m3u8 + master.m3u8 생성
4. **변환 완료**: HLS 상태가 "available"로 변경

### HLS 재생 플로우

1. **자동 모드**:
   - master.m3u8 로드
   - video.js가 네트워크 속도 측정
   - 최적 화질 자동 선택 (예: 빠른 네트워크 → 1080p)
   - 네트워크 변화 시 자동 전환

2. **수동 모드**:
   - 사용자가 480p 선택
   - 480p/playlist.m3u8 직접 로드
   - 해당 화질로 고정 재생

---

## 🧪 테스트 완료

### 백엔드
- [x] HLS 변환 성공 (비디오 ID 10)
- [x] master.m3u8 생성 확인
- [x] 480p/720p/1080p playlist 생성 확인
- [x] 세그먼트 파일 (.ts) 생성 확인
- [x] API 엔드포인트 동작 확인

### 프론트엔드
- [x] HLS 자동 재생 확인
- [x] 화질 선택 UI 동작 확인
- [x] 480p → 720p → 1080p 전환 확인
- [x] 현재 재생 화질 표시 확인
- [x] Network 탭에서 세그먼트 로딩 확인

---

## 💡 핵심 기술

### FFmpeg HLS 변환
```bash
ffmpeg -i input.mp4 \
  -vf scale=1280:720 \
  -c:v libx264 -preset medium -crf 23 \
  -b:v 2500k \
  -c:a aac -b:a 192k \
  -hls_time 6 \
  -hls_playlist_type vod \
  -hls_segment_filename "segment%d.ts" \
  -hls_flags independent_segments \
  720p/playlist.m3u8
```

### video.js HLS 설정
```typescript
videojs(element, {
  sources: [{
    src: '/videos/10/hls/master.m3u8',
    type: 'application/x-mpegURL'
  }],
  html5: {
    vhs: {
      overrideNative: true
    }
  }
})
```

---

## 📊 파일 크기 비교

**원본 비디오**: 12MB (bird.mp4)

**HLS 세그먼트**:
- 480p: ~1.5MB (3개 세그먼트)
- 720p: ~2.1MB (3개 세그먼트)
- 1080p: ~4.2MB (3개 세그먼트)

**총 저장 공간**: 원본 + 모든 HLS = ~20MB

---

## 🚀 성능 향상

| 항목 | 기존 방식 | HLS 방식 | 개선 |
|-----|----------|----------|-----|
| 화질 전환 | 페이지 새로고침 필요 | 버퍼링 없이 즉시 전환 | ✅ |
| 네트워크 적응 | 수동 선택만 가능 | 자동 조정 | ✅ |
| 초기 로딩 | 전체 파일 다운로드 | 세그먼트 단위 | ✅ |
| 시크 성능 | 느림 | 빠름 (세그먼트) | ✅ |

---

## ⚠️ 알려진 이슈

### 해결된 문제
1. ✅ 트랜스코딩 프로세스 중복 실행 → 백그라운드 태스크 관리 개선
2. ✅ 화질 전환 시 플레이어 재초기화 → useEffect 의존성 수정
3. ✅ 현재 화질 표시 업데이트 안됨 → 즉시 업데이트 로직 추가

### 남은 작업
- [ ] 다른 비디오들 HLS 변환
- [ ] 변환 진행률 표시 (선택사항)
- [ ] 4K 화질 지원 추가 (선택사항)

---

## 🔜 다음 작업

Phase 3.2 완료.
- Phase 3.1 (추천 시스템) 구현 또는
- Phase 3.3 (자막 지원) 구현

---

**작성일**: 2026-01-30
**완료 시간**: 오후
**버전**: v0.13
**상태**: ✅ HLS 스트리밍 완전 구현 완료
