# 인증 시스템 구현

## 작업 날짜
2026년 1월 6일

## 구현 내용

### 1. 개요
StreamFlix 프로젝트를 위한 JWT 기반 인증 시스템을 구현했습니다.

### 2. 주요 기능

#### 2.1 사용자 등록 (Registration)
- 엔드포인트: `POST /api/v1/auth/register`
- 기능: 새로운 사용자 계정 생성
- 검증 사항:
  - 이메일 중복 확인
  - 사용자명 중복 확인
  - 비밀번호 최소 8자 이상
  - 이메일 형식 검증

#### 2.2 사용자 로그인 (Login)
- 엔드포인트: `POST /api/v1/auth/login`
- 기능: 이메일과 비밀번호로 인증 후 토큰 발급
- 반환값:
  - Access Token (유효기간: 15분)
  - Refresh Token (유효기간: 7일)
  - Token Type: Bearer

#### 2.3 토큰 갱신 (Refresh Token)
- 엔드포인트: `POST /api/v1/auth/refresh`
- 기능: Refresh Token을 사용하여 새로운 Access Token 발급

#### 2.4 현재 사용자 정보 조회
- 엔드포인트: `GET /api/v1/auth/me`
- 기능: 인증된 사용자의 정보 조회
- 인증 필요: Bearer Token

### 3. 보안 구현

#### 3.1 비밀번호 해싱
- 알고리즘: bcrypt
- 솔트 자동 생성
- 단방향 암호화로 원본 비밀번호 복구 불가

#### 3.2 JWT 토큰
- 알고리즘: HS256
- Access Token 만료시간: 15분
- Refresh Token 만료시간: 7일
- 토큰 타입 검증 (access/refresh)

#### 3.3 역할 기반 접근 제어 (RBAC)
- USER: 일반 사용자
- PREMIUM: 프리미엄 사용자
- ADMIN: 관리자

### 4. 구현 파일

#### 4.1 스키마 (Schemas)
- `app/schemas/user.py`: 사용자 관련 Pydantic 스키마
  - UserCreate: 회원가입
  - UserLogin: 로그인
  - UserResponse: 사용자 정보 응답
  - UserUpdate: 사용자 정보 수정

- `app/schemas/token.py`: 토큰 관련 스키마
  - Token: 토큰 응답
  - TokenData: 토큰 페이로드 데이터

#### 4.2 보안 유틸리티
- `app/core/security.py`:
  - `get_password_hash()`: 비밀번호 해싱
  - `verify_password()`: 비밀번호 검증
  - `create_access_token()`: Access Token 생성
  - `create_refresh_token()`: Refresh Token 생성
  - `decode_token()`: JWT 토큰 디코딩 및 검증

#### 4.3 의존성 주입
- `app/api/deps.py`:
  - `oauth2_scheme`: OAuth2 Bearer 토큰 스키마
  - `get_current_user()`: 현재 인증된 사용자 조회
  - `get_current_active_user()`: 활성화된 사용자만 허용
  - `get_admin_user()`: 관리자 권한 검증

#### 4.4 서비스 레이어
- `app/services/user_service.py`:
  - `get_by_id()`: ID로 사용자 조회
  - `get_by_email()`: 이메일로 사용자 조회
  - `get_by_username()`: 사용자명으로 조회
  - `create()`: 사용자 생성
  - `update()`: 사용자 정보 수정
  - `authenticate()`: 이메일/비밀번호 인증
  - `update_last_login()`: 마지막 로그인 시간 업데이트

#### 4.5 API 엔드포인트
- `app/api/v1/auth.py`:
  - `POST /register`: 회원가입
  - `POST /login`: 로그인
  - `POST /refresh`: 토큰 갱신
  - `GET /me`: 현재 사용자 정보

### 5. 설치된 패키지
```bash
pip install python-jose[cryptography]  # JWT 처리
pip install passlib[bcrypt]             # 비밀번호 해싱
pip install pydantic[email]             # 이메일 검증
pip install python-multipart            # Form 데이터 처리
pip install bcrypt                      # bcrypt 해싱
```

### 6. 테스트 결과

#### 6.1 회원가입 테스트
```bash
curl -X POST "http://127.0.0.1:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "password123",
    "full_name": "Test User"
  }'
```
✅ 성공: 사용자 생성 완료

#### 6.2 로그인 테스트
```bash
curl -X POST "http://127.0.0.1:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=test@example.com&password=password123"
```
✅ 성공: Access Token 및 Refresh Token 발급

#### 6.3 인증된 엔드포인트 접근 테스트
```bash
curl -X GET "http://127.0.0.1:8000/api/v1/auth/me" \
  -H "Authorization: Bearer {access_token}"
```
✅ 성공: 사용자 정보 조회 완료

### 7. 데이터베이스 정보

#### PostgreSQL 연결 정보
- 호스트: localhost
- 포트: 5432
- 데이터베이스명: streamflix
- 사용자명: streamflix
- 비밀번호: streamflix2024!
- 연결 URL: `postgresql+asyncpg://streamflix:streamflix2024!@localhost:5432/streamflix`

### 8. 해결된 이슈

#### 8.1 이슈: email-validator 패키지 누락
- 증상: `ImportError: email-validator is not installed`
- 해결: `pip install pydantic[email]` 설치

#### 8.2 이슈: python-multipart 패키지 누락
- 증상: `RuntimeError: Form data requires "python-multipart"`
- 해결: `pip install python-multipart` 설치

#### 8.3 이슈: bcrypt 비밀번호 해싱 오류
- 증상: `ValueError: password cannot be longer than 72 bytes`
- 해결: passlib.context 대신 bcrypt 라이브러리 직접 사용

#### 8.4 이슈: JWT "Subject must be a string" 오류
- 증상: JWT 토큰 생성 시 오류 발생
- 원인: 토큰 페이로드의 sub 필드에 정수형 user_id 사용
- 해결: `str(user.id)`로 변환하여 문자열로 저장, 검증 시 `int()`로 다시 변환

#### 8.5 이슈: 중복된 get_db 함수
- 증상: get_db 함수가 database.py와 deps.py에 중복 정의
- 해결: deps.py의 중복 제거, database.py에서 import

### 9. 다음 단계
1. 이메일 인증 기능 추가
2. 비밀번호 재설정 기능 구현
3. 소셜 로그인 (OAuth2) 통합
4. 2단계 인증 (2FA) 추가
5. API Rate Limiting 구현
6. Refresh Token Rotation 전략 구현

### 10. 참고사항
- 프로덕션 환경에서는 SECRET_KEY를 안전하게 관리해야 합니다
- HTTPS 사용 필수
- 토큰 블랙리스트 기능 추가 고려
- 로그인 시도 제한 기능 추가 권장
