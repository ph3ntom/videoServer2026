# v0.6.1 - HTTP Range Request (ë¹„ë””ì˜¤ Seeking ì§€ì›)

**ë²„ì „:** v0.6.1
**ê°œë°œ ê¸°ê°„:** 2026-01-12
**ìƒíƒœ:** âœ… ì™„ë£Œ

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ë¬¸ì œ ë¶„ì„](#ë¬¸ì œ-ë¶„ì„)
3. [HTTP Range Request ê°œë…](#http-range-request-ê°œë…)
4. [êµ¬í˜„ ë‚´ìš©](#êµ¬í˜„-ë‚´ìš©)
5. [ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­](#ê¸°ìˆ ì -ì„¸ë¶€ì‚¬í•­)
6. [í…ŒìŠ¤íŠ¸](#í…ŒìŠ¤íŠ¸)
7. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)

---

## ê°œìš”

### ëª©ì 
ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ êµ¬ê°„ ì´ë™(seeking) ê¸°ëŠ¥ì„ ì§€ì›í•˜ì—¬ ì‚¬ìš©ìê°€ íƒ€ì„ë¼ì¸ì˜ ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

### ë¬¸ì œ ìƒí™©

**ì‚¬ìš©ì ê²½í—˜:**
```
1. ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘
2. ë¡œë”© ì™„ë£Œ (3-5ì´ˆ)
3. íƒ€ì„ë¼ì¸ í´ë¦­í•˜ì—¬ ì¤‘ê°„ìœ¼ë¡œ ì´ë™
4. âŒ ê²°ê³¼: 0:00ì´ˆë¡œ ë‹¤ì‹œ ëŒì•„ê°!
```

**ì—ëŸ¬ ë©”ì‹œì§€:**
```
Video.js player is ready
VIDEOJS: ERROR: (CODE:4 MEDIA_ERR_SRC_NOT_SUPPORTED)
The media could not be loaded...
```

### í•´ê²° ë°©ë²•

HTTP Range Requestë¥¼ êµ¬í˜„í•˜ì—¬ ë¹„ë””ì˜¤ íŒŒì¼ì˜ íŠ¹ì • ë¶€ë¶„ë§Œ ìš”ì²­/ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

---

## ë¬¸ì œ ë¶„ì„

### 1. ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹

```python
# ê¸°ì¡´ ì½”ë“œ (ë¬¸ì œ)
@router.get("/{video_id}/stream")
async def stream_video(video_id: int, db: AsyncSession = Depends(get_db)):
    def iterfile():
        with open(video.file_path, "rb") as f:
            yield from f  # ì „ì²´ íŒŒì¼ì„ ì²˜ìŒë¶€í„° ëê¹Œì§€

    return StreamingResponse(iterfile(), media_type="video/mp4")
```

**ë¬¸ì œì :**
- Range í—¤ë”ë¥¼ ë¬´ì‹œí•¨
- í•­ìƒ íŒŒì¼ì˜ ì²˜ìŒë¶€í„° ì „ì†¡
- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì˜ seeking ë¶ˆê°€ëŠ¥

### 2. ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì˜ ë™ì‘

```
ì‚¬ìš©ì: íƒ€ì„ë¼ì¸ ì¤‘ê°„ í´ë¦­ (ì˜ˆ: 10ì´ˆ)
  â†“
Video.js: "Range: bytes=5242880-" ìš”ì²­ ì „ì†¡
  â†“
ë°±ì—”ë“œ: Range ë¬´ì‹œí•˜ê³  0ë°”ì´íŠ¸ë¶€í„° ì „ì†¡
  â†“
Video.js: 0ì´ˆë¶€í„° ì¬ìƒ ì‹œì‘ ğŸ˜
```

### 3. HTTP Range Requestì˜ í•„ìš”ì„±

ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°ì—ì„œ Range Requestê°€ í•„ìˆ˜ì¸ ì´ìœ :

1. **Seeking (êµ¬ê°„ ì´ë™):** ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ë°”ë¡œ ì´ë™
2. **ëŒ€ì—­í­ ì ˆì•½:** í•„ìš”í•œ ë¶€ë¶„ë§Œ ì „ì†¡
3. **ë¹ ë¥¸ ì‘ë‹µ:** ì „ì²´ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  í•„ìš” ì—†ìŒ
4. **í‘œì¤€ ì¤€ìˆ˜:** ëª¨ë“  ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ê°€ ê¸°ëŒ€í•˜ëŠ” ë™ì‘

---

## HTTP Range Request ê°œë…

### 1. Range ìš”ì²­ íë¦„

```mermaid
sequenceDiagram
    participant Client as ë¹„ë””ì˜¤ í”Œë ˆì´ì–´
    participant Server as FastAPI ì„œë²„

    Note over Client: ì´ˆê¸° ì¬ìƒ
    Client->>Server: GET /stream (Range í—¤ë” ì—†ìŒ)
    Server->>Client: 200 OK<br/>Accept-Ranges: bytes<br/>Content-Length: 52428800

    Note over Client: êµ¬ê°„ ì´ë™ (10ì´ˆ)
    Client->>Server: GET /stream<br/>Range: bytes=5242880-
    Server->>Client: 206 Partial Content<br/>Content-Range: bytes 5242880-52428799/52428800
```

### 2. Range í—¤ë” í˜•ì‹

| Range í—¤ë” | ì˜ë¯¸ | ì‚¬ìš© ì˜ˆì‹œ |
|-----------|------|----------|
| `bytes=0-999` | ì²˜ìŒ 1000ë°”ì´íŠ¸ | í”„ë¦¬ë·° |
| `bytes=1000-1999` | 1000~1999 ë°”ì´íŠ¸ | íŠ¹ì • êµ¬ê°„ |
| `bytes=5000000-` | 5MBë¶€í„° ëê¹Œì§€ | Seeking (ê°€ì¥ í”í•¨) |
| `bytes=-1000` | ë§ˆì§€ë§‰ 1000ë°”ì´íŠ¸ | ê±°ì˜ ì‚¬ìš© ì•ˆ í•¨ |

### 3. HTTP ìƒíƒœ ì½”ë“œ

| ìƒíƒœ ì½”ë“œ | ì˜ë¯¸ | ì‚¬ìš© ì‹œì  |
|----------|------|----------|
| **200 OK** | ì „ì²´ íŒŒì¼ | Range í—¤ë” ì—†ì„ ë•Œ |
| **206 Partial Content** | ì¼ë¶€ ì „ì†¡ | Range í—¤ë” ìˆì„ ë•Œ |
| **416 Range Not Satisfiable** | ë²”ìœ„ ì˜¤ë¥˜ | ì˜ëª»ëœ Range ê°’ |

### 4. í•„ìˆ˜ ì‘ë‹µ í—¤ë”

```http
Accept-Ranges: bytes
# Range ìš”ì²­ì„ ì§€ì›í•¨ì„ ì•Œë¦¼

Content-Range: bytes 5242880-52428799/52428800
# í˜•ì‹: bytes {start}-{end}/{total}
# ì˜ë¯¸: 5MB~50MB êµ¬ê°„ì„ ì „ì†¡ (ì „ì²´ 50MB)

Content-Length: 47185920
# ì‹¤ì œ ì „ì†¡ë˜ëŠ” ë°ì´í„° í¬ê¸° (ì•½ 45MB)
```

---

## êµ¬í˜„ ë‚´ìš©

### ë³€ê²½ëœ íŒŒì¼

**`backend/app/api/v1/videos.py`**

#### 1. Import ì¶”ê°€

```python
from fastapi import Request  # âœ… ì¶”ê°€
```

#### 2. í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ë³€ê²½

```python
# Before
async def stream_video(
    video_id: int,
    db: AsyncSession = Depends(get_db)
):

# After
async def stream_video(
    video_id: int,
    request: Request,  # âœ… ì¶”ê°€
    db: AsyncSession = Depends(get_db)
):
```

#### 3. Range ìš”ì²­ ì²˜ë¦¬ ë¡œì§

```python
# íŒŒì¼ í¬ê¸° í™•ì¸
file_size = os.path.getsize(video.file_path)

# Range í—¤ë” íŒŒì‹±
range_header = request.headers.get("range")

if range_header:
    # "bytes=5242880-" â†’ start=5242880, end=file_size-1
    range_match = range_header.replace("bytes=", "").split("-")
    start = int(range_match[0]) if range_match[0] else 0
    end = int(range_match[1]) if range_match[1] else file_size - 1
    end = min(end, file_size - 1)  # ë²”ìœ„ ê²€ì¦

    content_length = end - start + 1

    # íŒŒì¼ì˜ íŠ¹ì • ë¶€ë¶„ë§Œ ì½ê¸°
    def iterfile_range():
        with open(video.file_path, "rb") as f:
            f.seek(start)  # ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™
            remaining = content_length
            chunk_size = 1024 * 1024  # 1MB

            while remaining > 0:
                chunk = f.read(min(chunk_size, remaining))
                if not chunk:
                    break
                remaining -= len(chunk)
                yield chunk

    return StreamingResponse(
        iterfile_range(),
        status_code=206,  # Partial Content
        media_type="video/mp4",
        headers={
            "Content-Range": f"bytes {start}-{end}/{file_size}",
            "Accept-Ranges": "bytes",
            "Content-Length": str(content_length),
        }
    )
```

#### 4. ì „ì²´ íŒŒì¼ ì‘ë‹µ ê°œì„ 

```python
# Range í—¤ë”ê°€ ì—†ì„ ë•Œ
def iterfile():
    with open(video.file_path, "rb") as f:
        chunk_size = 1024 * 1024  # 1MB ì²­í¬
        while True:
            chunk = f.read(chunk_size)
            if not chunk:
                break
            yield chunk

return StreamingResponse(
    iterfile(),
    media_type="video/mp4",
    headers={
        "Accept-Ranges": "bytes",  # Range ì§€ì› ì•Œë¦¼
        "Content-Length": str(file_size),
    }
)
```

---

## ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### 1. íŒŒì¼ Seek ì—°ì‚°

```python
with open(video.file_path, "rb") as f:
    f.seek(5242880)  # 5MB ìœ„ì¹˜ë¡œ ì´ë™
    chunk = f.read(1048576)  # 1MB ì½ê¸°
```

**ì‘ë™ ì›ë¦¬:**
- íŒŒì¼ í¬ì¸í„°ë¥¼ íŠ¹ì • ë°”ì´íŠ¸ ìœ„ì¹˜ë¡œ ì´ë™
- O(1) ì‹œê°„ ë³µì¡ë„ (ë§¤ìš° ë¹ ë¦„)
- ì „ì²´ íŒŒì¼ì„ ì½ì„ í•„ìš” ì—†ìŒ

### 2. ì²­í¬ ë‹¨ìœ„ ìŠ¤íŠ¸ë¦¬ë°

**ì´ì „ ì½”ë“œ (ë¬¸ì œ):**
```python
def iterfile():
    with open(file_path, "rb") as f:
        yield from f  # ë©”ëª¨ë¦¬ì— ì „ì²´ ë¡œë“œ (ìœ„í—˜!)
```

**ê°œì„ ëœ ì½”ë“œ:**
```python
def iterfile():
    with open(file_path, "rb") as f:
        chunk_size = 1024 * 1024  # 1MB
        while True:
            chunk = f.read(chunk_size)
            if not chunk:
                break
            yield chunk  # 1MBì”© ìŠ¤íŠ¸ë¦¬ë°
```

**ì¥ì :**
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¼ì • (ìµœëŒ€ 1MB)
- ëŒ€ìš©ëŸ‰ íŒŒì¼ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¼ë¶€ë§Œ ì¬ì „ì†¡

### 3. Range í—¤ë” íŒŒì‹±

```python
# ì…ë ¥: "bytes=5242880-10485759"
range_header.replace("bytes=", "")  # "5242880-10485759"
.split("-")  # ["5242880", "10485759"]

start = int(range_match[0]) if range_match[0] else 0
end = int(range_match[1]) if range_match[1] else file_size - 1

# ì˜ˆì™¸ ì¼€ì´ìŠ¤ ì²˜ë¦¬
# "bytes=5242880-" â†’ start=5242880, end=íŒŒì¼ë
# "bytes=-1000" â†’ start=0, end=1000 (ë¯¸ì§€ì›, ì—ëŸ¬ ì²˜ë¦¬ í•„ìš”)
```

### 4. ì¡°íšŒìˆ˜ ìµœì í™”

```python
# Range ìš”ì²­ ì‹œ ì¡°íšŒìˆ˜ ì¦ê°€ ì•ˆ í•¨
if not range_header:
    await video_service.increment_view_count(db, video)
```

**ì´ìœ :**
- ì´ˆê¸° ì¬ìƒ ì‹œì—ë§Œ ì¡°íšŒìˆ˜ 1 ì¦ê°€
- êµ¬ê°„ ì´ë™í•  ë•Œë§ˆë‹¤ ì¦ê°€í•˜ë©´ ë¶€ì •í™•
- 10ì´ˆì§œë¦¬ ì˜ìƒì—ì„œ 10ë²ˆ ì´ë™ â†’ ì¡°íšŒìˆ˜ 11ì´ ë˜ëŠ” ë¬¸ì œ ë°©ì§€

---

## í…ŒìŠ¤íŠ¸

### 1. ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:**

1. ë¹„ë””ì˜¤ ì—…ë¡œë“œ
   - http://localhost:5173/upload
   - í…ŒìŠ¤íŠ¸ìš© ë¹„ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ

2. ë¹„ë””ì˜¤ ì¬ìƒ
   - ì—…ë¡œë“œ ì™„ë£Œ í›„ ì¬ìƒ í˜ì´ì§€ ì´ë™
   - ë¹„ë””ì˜¤ ë¡œë”© ì™„ë£Œ ëŒ€ê¸° (3-5ì´ˆ)

3. **êµ¬ê°„ ì´ë™ í…ŒìŠ¤íŠ¸**
   - íƒ€ì„ë¼ì¸ ì¤‘ê°„ í´ë¦­ (ì˜ˆ: 50% ì§€ì )
   - âœ… **ì˜ˆìƒ ê²°ê³¼:** í´ë¦­í•œ ìœ„ì¹˜ì—ì„œ ì¦‰ì‹œ ì¬ìƒ
   - âŒ **ì´ì „ ë™ì‘:** 0:00ì´ˆë¡œ ëŒì•„ê°

4. **ì—¬ëŸ¬ ë²ˆ ì´ë™ í…ŒìŠ¤íŠ¸**
   - ì²˜ìŒ â†’ ì¤‘ê°„ â†’ ë â†’ ì²˜ìŒ
   - ëª¨ë“  ìœ„ì¹˜ì—ì„œ ì •ìƒ ì¬ìƒ í™•ì¸

### 2. ê°œë°œì ë„êµ¬ í™•ì¸

**F12 â†’ Network íƒ­:**

```
Name: stream
Status: 206 Partial Content âœ…
Type: video/mp4
Size: 45.0 MB

Request Headers:
  Range: bytes=5242880-

Response Headers:
  Content-Range: bytes 5242880-52428799/52428800
  Accept-Ranges: bytes
  Content-Length: 47185920
  Content-Type: video/mp4
```

### 3. curl ëª…ë ¹ì–´ í…ŒìŠ¤íŠ¸

**ì „ì²´ íŒŒì¼ ìš”ì²­:**
```bash
curl -I http://localhost:8000/api/v1/videos/1/stream

# ì˜ˆìƒ ì‘ë‹µ
HTTP/1.1 200 OK
Accept-Ranges: bytes
Content-Length: 52428800
Content-Type: video/mp4
```

**Range ìš”ì²­:**
```bash
curl -I -H "Range: bytes=1000-2000" \
  http://localhost:8000/api/v1/videos/1/stream

# ì˜ˆìƒ ì‘ë‹µ
HTTP/1.1 206 Partial Content
Content-Range: bytes 1000-2000/52428800
Content-Length: 1001
Accept-Ranges: bytes
```

**ëê¹Œì§€ ìš”ì²­:**
```bash
curl -H "Range: bytes=52428000-" \
  http://localhost:8000/api/v1/videos/1/stream \
  | wc -c

# ì˜ˆìƒ ì¶œë ¥: 800 (ë§ˆì§€ë§‰ 800ë°”ì´íŠ¸)
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

| ë°©ì‹ | ë©”ëª¨ë¦¬ ì‚¬ìš© | 50MB íŒŒì¼ |
|------|-----------|----------|
| **ì´ì „** | ì „ì²´ íŒŒì¼ | 50MB |
| **í˜„ì¬** | ì²­í¬ í¬ê¸° | 1MB |

**ê°œì„  íš¨ê³¼:**
- 50ë°° ë©”ëª¨ë¦¬ ì ˆì•½
- ë¼ì¦ˆë² ë¦¬íŒŒì´ í™˜ê²½ì—ì„œ ì•ˆì •ì  ë™ì‘

### 2. ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨

**êµ¬ê°„ ì´ë™ ì‹œ ì „ì†¡ëŸ‰:**

| ì‹œë‚˜ë¦¬ì˜¤ | ì´ì „ | í˜„ì¬ | ì ˆê°ë¥  |
|---------|------|------|--------|
| 10ì´ˆ â†’ 40ì´ˆ ì´ë™ | 50MB | 25MB | 50% |
| ì²˜ìŒ â†’ ë ì´ë™ | 50MB | ~1MB | 98% |
| ì—¬ëŸ¬ ë²ˆ ì´ë™ | 50MB Ã— N | í•„ìš”í•œë§Œí¼ | í¼ |

### 3. ì‘ë‹µ ì†ë„

```
ì´ì „: ì „ì²´ íŒŒì¼ ì „ì†¡ ì‹œì‘ â†’ 10ì´ˆ â†’ ì›í•˜ëŠ” ìœ„ì¹˜ ë„ë‹¬
í˜„ì¬: Range ìš”ì²­ â†’ 0.1ì´ˆ â†’ ì¦‰ì‹œ ì¬ìƒ
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ì—¬ì „íˆ 0ì´ˆë¡œ ëŒì•„ê°

**ì›ì¸:** ë¸Œë¼ìš°ì € ìºì‹œê°€ ì´ì „ ì‘ë‹µ ì‚¬ìš©

**í•´ê²°:**
```
1. Ctrl+Shift+R (ê°•ì œ ìƒˆë¡œê³ ì¹¨)
2. ê°œë°œì ë„êµ¬ â†’ Network â†’ "Disable cache" ì²´í¬
3. ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ í…ŒìŠ¤íŠ¸
```

### ë¬¸ì œ 2: 206 ì‘ë‹µì´ ì•ˆ ì˜´

**ê°€ëŠ¥í•œ ì›ì¸:**

1. **ì„œë²„ê°€ ì¬ì‹œì‘ ì•ˆ ë¨**
   ```bash
   ps aux | grep uvicorn
   # PID í™•ì¸ í›„ killí•˜ê³  ì¬ì‹œì‘
   ```

2. **Video.jsê°€ Range ìš”ì²­ ì•ˆ í•¨**
   - ë¹„ë””ì˜¤ í¬ë§· í™•ì¸ (mp4 ê¶Œì¥)
   - Video.js ë²„ì „ í™•ì¸

3. **CORS ë¬¸ì œ**
   ```
   Access-Control-Allow-Headersì— Range í¬í•¨ í™•ì¸
   ```

### ë¬¸ì œ 3: Range íŒŒì‹± ì˜¤ë¥˜

**ì¦ìƒ:** 500 Internal Server Error

**ì›ì¸:** ì˜ëª»ëœ Range í—¤ë” í˜•ì‹

**í•´ê²°:**
```python
# ì˜ˆì™¸ ì²˜ë¦¬ ì¶”ê°€
try:
    start = int(range_match[0]) if range_match[0] else 0
    end = int(range_match[1]) if range_match[1] else file_size - 1
except (ValueError, IndexError):
    raise HTTPException(
        status_code=400,
        detail="Invalid Range header"
    )
```

---

## í–¥í›„ ê°œì„  ê³„íš

### Phase 2 ì—…ê·¸ë ˆì´ë“œ

1. **Multi-Range ì§€ì›**
   ```
   Range: bytes=0-999, 5000-5999
   â†’ ì—¬ëŸ¬ êµ¬ê°„ ë™ì‹œ ìš”ì²­ (ê±°ì˜ ì‚¬ìš© ì•ˆ í•¨)
   ```

2. **If-Range ì¡°ê±´ë¶€ ìš”ì²­**
   ```
   If-Range: "etag-12345"
   â†’ íŒŒì¼ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ Range ì‚¬ìš©
   ```

3. **Content-Encoding ìµœì í™”**
   - gzip ì••ì¶• (ë¹„ë””ì˜¤ëŠ” ì´ë¯¸ ì••ì¶•ë˜ì–´ ìˆì–´ íš¨ê³¼ ì ìŒ)

4. **CDN í†µí•©**
   - CloudFront, Cloudflare ë“±
   - Range ìš”ì²­ ìºì‹±

---

## ê´€ë ¨ ë¬¸ì„œ

- [06_ê°œë°œ_ë¡œë“œë§µ.md](../06_ê°œë°œ_ë¡œë“œë§µ.md) - Phase 1: 1.3 ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
- [2.v0.2-video-upload-streaming.md](./2.v0.2-video-upload-streaming.md) - ì´ˆê¸° ìŠ¤íŠ¸ë¦¬ë° êµ¬í˜„
- [todo/04-20260112-HTTP-Range-Request.md](../todo/04-20260112-HTTP-Range-Request.md)

---

## ì°¸ê³  ìë£Œ

- [MDN: HTTP Range Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests)
- [RFC 7233: HTTP/1.1 Range Requests](https://datatracker.ietf.org/doc/html/rfc7233)
- [Video.js Documentation](https://videojs.com/)
- [FastAPI StreamingResponse](https://fastapi.tiangolo.com/advanced/custom-response/#streamingresponse)

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ ë‚´ìš© |
|-----|------|----------|
| 2026-01-12 | v0.6.1 | HTTP Range Request êµ¬í˜„ ì™„ë£Œ |
