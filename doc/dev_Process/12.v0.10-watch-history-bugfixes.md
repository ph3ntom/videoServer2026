# v0.10: 시청 기록 시스템 버그 수정 및 개선

**날짜**: 2026-01-13
**버전**: v0.10
**상태**: ✅ 완료

---

## 📋 개요

v0.9에서 구현한 시청 기록(Watch History) 시스템과 통계 기능 테스트 중 발견된 버그들을 수정하고 사용자 경험을 개선했습니다.

---

## 🐛 발견된 버그 목록

### 1. Watch History API 500 에러
- **증상**: 시청 기록 저장 시 500 Internal Server Error 발생
- **에러 메시지**: `AttributeError: property 'progress_percentage' of 'WatchHistory' object has no setter`
- **영향**: 이어보기 기능 완전히 작동 불가

### 2. 조회수 증가 안됨
- **증상**: 동영상을 시청해도 view_count가 증가하지 않음
- **원인**: 모든 스트림 요청이 Range 요청(206)이라 increment 로직이 실행되지 않음
- **영향**: 인기 동영상 통계가 정확하지 않음

### 3. 높은 평점 섹션 표시 안됨
- **증상**: Videos 페이지에서 "높은 평점" 섹션이 비어있음
- **원인**: min_ratings=3 설정으로 필터링했으나 실제 데이터에 3개 이상 평점이 있는 동영상이 없음
- **영향**: 사용자가 평점 기반 추천을 볼 수 없음

### 4. 이어보기 알림이 페이지 새로고침 시 표시 안됨
- **증상**:
  - 동영상 재생 중 새로고침(F5) 시 이어보기 알림 표시 안됨
  - 뒤로가기 후 재접근 시 이어보기 알림 표시 안됨
  - 메인 페이지로 나갔다가 다시 접근해야만 알림 표시됨
- **원인**: App.tsx에서 loadUser()를 호출하지 않아 페이지 새로고침 시 user 상태가 null로 남음
- **영향**: 사용자 경험 저하, 이어보기 기능의 실용성 감소

---

## 🔧 수정 내역

### 1. Watch History API 수정 ✅

**파일**: `backend/app/api/v1/watch_history.py`

**문제 코드** (Lines 51-53):
```python
# Add progress_percentage to response
if hasattr(history, 'progress_percentage'):
    history.progress_percentage = history.progress_percentage
```

**수정**:
- 불필요한 property setter 코드 제거
- `progress_percentage`는 `@property`로 정의된 계산 필드이므로 setter가 없음
- API 응답 시 자동으로 계산되어 반환됨

**결과**: ✅ Watch history 저장 정상 작동

---

### 2. 조회수 증가 로직 개선 ✅

#### 백엔드: 전용 API 엔드포인트 추가

**파일**: `backend/app/api/v1/videos.py`

**새로운 엔드포인트 추가**:
```python
@router.post("/{video_id}/view", status_code=status.HTTP_204_NO_CONTENT)
async def increment_view(
    video_id: int,
    db: AsyncSession = Depends(get_db)
):
    """
    Increment view count for a video

    This endpoint should be called once when the video player starts playing.
    """
    video = await video_service.get_by_id(db, video_id)
    if not video:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Video not found"
        )

    await video_service.increment_view_count(db, video)
    return None
```

**라우터 등록** (`backend/app/api/v1/router.py`):
```python
api_router.include_router(videos.router, prefix="/videos", tags=["videos"])
```

#### 프론트엔드: Player 초기화 시 조회수 증가

**파일**: `frontend/src/pages/VideoPlayer.tsx`

**변경 사항** (Lines 160-170):
```typescript
player.ready(async () => {
  console.log('Video.js player is ready');

  // Increment view count
  try {
    await apiClient.post(`/videos/${video.id}/view`);
    console.log('View count incremented');
  } catch (err) {
    console.error('Failed to increment view count:', err);
  }
});
```

**결과**: ✅ 동영상 재생 시 조회수 정상 증가 (4 → 5 확인)

---

### 3. 높은 평점 섹션 표시 개선 ✅

**파일**: `frontend/src/pages/Videos.tsx`

**변경 전** (Line 119):
```typescript
const response = await apiClient.get('/statistics/top-rated?limit=8&min_ratings=3');
```

**변경 후**:
```typescript
const response = await apiClient.get('/statistics/top-rated?limit=8&min_ratings=1');
```

**변경 이유**:
- 테스트 데이터에 평점이 3개 이상인 동영상이 없음
- min_ratings=1로 낮춰서 1개 이상 평점이 있는 동영상 표시
- 실제 서비스에서 데이터가 쌓이면 조정 가능

**결과**: ✅ 높은 평점 섹션에 3개 동영상 표시 (평점: 5.0, 3.0, 3.0)

---

### 4. 이어보기 알림 UX 개선 ✅ (CRITICAL FIX)

#### 문제 분석

**사용자 요구사항**:
> "이어보기 알림을 확인하려면 메인페이지로 나갔다 다시 접근 해야한다.
> 만약 동영상 상세페이지에서 실행하다 새로고침을 눌러도 이어보기 여부 알림이 나와야하고
> 뒤로가기 후 재 접근 해도 이어보기 여부 알림이 나와야 된다."

**디버깅 과정**:
1. 콘솔 로그 추가하여 user 상태 확인
2. 발견: `Watch history check skipped: {hasVideo: true, hasUser: false}`
3. user가 로그인 상태임에도 null로 표시됨
4. localStorage에 access_token은 존재함
5. **Root Cause**: App.tsx에서 loadUser()를 호출하지 않음

#### 수정 1: App.tsx - 사용자 상태 초기화 (CRITICAL)

**파일**: `frontend/src/App.tsx`

**추가된 코드** (Lines 16-22):
```typescript
function App() {
  const loadUser = useAuthStore((state) => state.loadUser)

  // Load user on app mount (page refresh)
  useEffect(() => {
    loadUser()
  }, [loadUser])

  return (
    <ErrorBoundary>
      <Router>
        {/* ... routes ... */}
```

**핵심 개선사항**:
- 앱 마운트 시 localStorage의 access_token을 확인하여 사용자 정보 로드
- 페이지 새로고침 시에도 로그인 상태 유지
- 모든 인증이 필요한 기능(이어보기, 평점 등)이 정상 작동

#### 수정 2: VideoPlayer.tsx - Watch History 체크 로직 분리

**파일**: `frontend/src/pages/VideoPlayer.tsx`

**변경 사항** (Lines 107-145):
```typescript
// Check watch history and show resume prompt
useEffect(() => {
  const checkWatchHistory = async () => {
    if (!video || !user) {
      console.log('Watch history check skipped:', { hasVideo: !!video, hasUser: !!user });
      return;
    }

    console.log('Checking watch history for video:', video.id);

    try {
      const historyResponse = await apiClient.get(`/videos/${video.id}/watch-history`);
      const watchHistory = historyResponse.data;

      console.log('Watch history loaded:', watchHistory);

      // Show resume prompt if watch position is significant
      if (watchHistory.watch_position > 5 && watchHistory.progress_percentage < 95) {
        console.log('Showing resume prompt at position:', watchHistory.watch_position);
        setResumePosition(watchHistory.watch_position);
        setShowResumePrompt(true);
      } else {
        console.log('Resume conditions not met:', {
          position: watchHistory.watch_position,
          progress: watchHistory.progress_percentage
        });
      }
    } catch (err: any) {
      if (err.response?.status !== 404) {
        console.error('Failed to load watch history:', err);
      } else {
        console.log('No watch history found (404)');
      }
    }
  };

  checkWatchHistory();
}, [video?.id, user]);
```

**개선 포인트**:
- Watch history 체크를 별도 useEffect로 분리
- Dependencies: `[video?.id, user]`
  - video ID 변경 시 재실행
  - **user 상태 변경 시 재실행** ← 핵심!
- 페이지 새로고침 시:
  1. 컴포넌트 마운트 (user = null)
  2. App.tsx의 loadUser() 실행
  3. user 상태 업데이트
  4. useEffect 재실행 → watch history 체크

**디버그 로그 추가** (Lines 94-97):
```typescript
// Debug: Log user state changes
useEffect(() => {
  console.log('User state changed:', user);
}, [user]);
```

**결과**: ✅ 사용자 확인 "정상 작동한다"
- 새로고침 시 이어보기 알림 표시 ✅
- 뒤로가기 후 재접근 시 알림 표시 ✅
- 직접 URL 접근 시 알림 표시 ✅

---

## 📊 통계 시스템 추가 (v0.10)

이번 버전에서 새롭게 추가된 통계 API 시스템:

### 백엔드: Statistics API

**파일**: `backend/app/api/v1/statistics.py`

**엔드포인트**:
1. `GET /statistics/popular` - 조회수 기준 인기 동영상
2. `GET /statistics/top-rated` - 평점 기준 높은 평점 동영상

**서비스**: `backend/app/services/statistics_service.py`
- 조회수 정렬
- 평균 평점 계산 및 정렬
- 최소 평점 개수 필터링

### 프론트엔드: Videos 페이지 통계 섹션

**파일**: `frontend/src/pages/Videos.tsx`

**추가된 섹션**:
1. **인기 비디오** - 조회수 기준 8개 표시
2. **높은 평점** - 평균 평점 기준 8개 표시 (별점 배지 포함)
3. **이어보기** - 사용자별 시청 중인 동영상 6개 표시

---

## 🧪 테스트 결과

### 테스트 환경
- **브라우저**: Chrome/Safari
- **계정**: admin@streamflix.com
- **테스트 시나리오**: 실제 사용자 시나리오 기반 테스트

### 테스트 케이스

#### 1. Watch History 저장 ✅
- 동영상 시청 중 5초마다 자동 저장
- 500 에러 없이 정상 저장
- 진행률(progress_percentage) 정확히 계산됨

#### 2. 조회수 증가 ✅
- 동영상 재생 시작 시 1회 증가
- 실제 테스트: 4 → 5로 증가 확인
- Range request 여부와 무관하게 작동

#### 3. 높은 평점 섹션 ✅
- 평점이 있는 동영상 3개 표시
- 배지에 평점(5.0, 3.0, 3.0) 및 평점 개수 표시
- min_ratings=1 적용

#### 4. 이어보기 알림 ✅
**시나리오 1: 페이지 새로고침**
- 동영상 시청 중 F5 새로고침
- 결과: ✅ 이어보기 알림 정상 표시

**시나리오 2: 뒤로가기 후 재접근**
- 동영상 재생 중 뒤로가기
- 다시 동일한 동영상 접근
- 결과: ✅ 이어보기 알림 정상 표시

**시나리오 3: 직접 URL 접근**
- 브라우저 주소창에 동영상 URL 직접 입력
- 결과: ✅ 이어보기 알림 정상 표시

**시나리오 4: 메인 페이지를 통한 접근**
- 기존 동작과 동일하게 작동
- 결과: ✅ 정상

---

## 🔍 디버깅 상세

### localStorage 키 확인
- ❌ `auth-storage` (Zustand persist key, 사용 안함)
- ✅ `access_token` (실제 인증 토큰)
- ✅ `refresh_token` (갱신 토큰)

### 인증 플로우
```
1. 로그인 → access_token/refresh_token localStorage 저장
2. 페이지 새로고침 → App.tsx useEffect 실행
3. loadUser() 호출 → access_token 확인
4. API 요청 → /auth/me
5. user 상태 업데이트 → authStore
6. VideoPlayer useEffect 재실행 → watch history 체크
```

---

## 📁 수정된 파일 목록

### 백엔드
1. `backend/app/api/v1/watch_history.py` - Property setter 코드 제거
2. `backend/app/api/v1/videos.py` - View increment 엔드포인트 추가
3. `backend/app/api/v1/statistics.py` - 통계 API 추가 (신규)
4. `backend/app/services/statistics_service.py` - 통계 서비스 추가 (신규)
5. `backend/app/api/v1/router.py` - Statistics 라우터 등록

### 프론트엔드
1. `frontend/src/App.tsx` - loadUser() 초기화 추가 (CRITICAL)
2. `frontend/src/pages/VideoPlayer.tsx` - Watch history 체크 로직 분리, View increment 호출
3. `frontend/src/pages/Videos.tsx` - min_ratings 조정, 통계 섹션 추가

---

## 💡 교훈 및 개선점

### 1. 페이지 새로고침과 인증 상태
- **문제**: SPA에서 새로고침 시 상태가 초기화됨
- **해결**: 앱 마운트 시 localStorage 확인하여 사용자 상태 복원
- **교훈**: 인증이 필요한 기능은 항상 user 상태를 dependency로 포함

### 2. useEffect Dependencies 중요성
- **문제**: Watch history 체크가 user 상태 변경을 감지하지 못함
- **해결**: `[video?.id, user]` dependencies 추가
- **교훈**: 비동기 상태(user)에 의존하는 로직은 반드시 dependency 배열에 포함

### 3. Range Request와 조회수
- **문제**: 비디오 스트리밍은 대부분 Range request
- **해결**: 조회수 증가를 별도 엔드포인트로 분리
- **교훈**: 스트림 요청과 비즈니스 로직을 분리

### 4. 데이터 기반 설정값
- **문제**: min_ratings=3으로 설정했으나 실제 데이터는 부족
- **해결**: 실제 데이터에 맞춰 min_ratings=1로 조정
- **교훈**: 설정값은 실제 데이터를 기반으로 결정

---

## 🎯 다음 Phase 계획

### Phase 2.7: 정렬 & 페이지네이션 개선
- 인기 동영상: 8개 → 20개 (4x5 그리드)
- 높은 평점: 8개 → 20개 (4x5 그리드)
- 전체 동영상: 페이지네이션 (20개/페이지)
- 정렬 옵션: 조회수순, 별점순, 최신순

**문서**: `doc/todo/08-20260113-정렬및페이지네이션개선.md`

---

## ✅ 완료 확인

- [x] Watch history API 500 에러 수정
- [x] 조회수 증가 로직 구현
- [x] 높은 평점 섹션 표시
- [x] 이어보기 알림 UX 개선 (새로고침/뒤로가기)
- [x] App.tsx loadUser() 초기화 (CRITICAL FIX)
- [x] 브라우저 실제 테스트 완료
- [x] 사용자 확인: "정상 작동한다"

---

**작성일**: 2026-01-13
**작성자**: Claude Sonnet 4.5
**버전**: v0.10
**상태**: ✅ 완료 및 테스트 완료
