# v0.13.1: ë¹„ë””ì˜¤ ì‹œìŠ¤í…œ ê°œì„ 

**ë‚ ì§œ**: 2026-02-02
**ë²„ì „**: v0.13.1
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ê°œìš”

ë¹„ë””ì˜¤ ì‚­ì œ ë²„ê·¸ ìˆ˜ì •, HLS ë³€í™˜ ì§„í–‰ë¥  ì‹¤ì‹œê°„ í‘œì‹œ, í™”ì§ˆ ì„ íƒ UIë¥¼ í”Œë ˆì´ì–´ ë‚´ë¶€ë¡œ ì´ë™í•˜ì—¬ UX ê°œì„ .

---

## ğŸ› ë¬¸ì œ í•´ê²°

### 1. ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ IntegrityError

**ì¦ìƒ**:
```
DELETE http://localhost:8000/api/v1/videos/11 500 (Internal Server Error)

sqlalchemy.exc.IntegrityError: null value in column "video_id" of relation "ratings"
violates not-null constraint
```

**ì›ì¸ ë¶„ì„**:
```python
# backend/app/models/rating.py (ë¬¸ì œ ì½”ë“œ)
class Rating(Base):
    video_id = Column(Integer, ForeignKey("videos.id", ondelete="CASCADE"), nullable=False)

    # backref ì‚¬ìš© - cascade ì„¤ì • ì—†ìŒ!
    user = relationship("User", backref="ratings")
    video = relationship("Video", backref="ratings")
```

SQLAlchemyì—ì„œ `backref`ë¥¼ ì‚¬ìš©í•˜ë©´:
- ë‹¨ë°©í–¥ ê´€ê³„ë§Œ ì •ì˜ë¨
- Video ëª¨ë¸ì—ì„œ ratingsë¥¼ ì•Œ ìˆ˜ ì—†ìŒ
- cascade ì„¤ì •ì´ ì ìš©ë˜ì§€ ì•ŠìŒ
- ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ ratingsì˜ video_idë¥¼ nullë¡œ ì„¤ì • ì‹œë„
- NOT NULL ì œì•½ ì¡°ê±´ ìœ„ë°˜

**í•´ê²° ë°©ë²•**:

1. Video ëª¨ë¸ì— ëª…ì‹œì  relationship ì¶”ê°€:
```python
# backend/app/models/video.py
class Video(Base):
    # Relationships
    ratings = relationship("Rating", back_populates="video", cascade="all, delete-orphan")
    watch_history = relationship("WatchHistory", back_populates="video", cascade="all, delete-orphan")
```

2. Rating ëª¨ë¸ì—ì„œ backref â†’ back_populates ë³€ê²½:
```python
# backend/app/models/rating.py
class Rating(Base):
    # backref ì œê±°, back_populates ì‚¬ìš©
    user = relationship("User", back_populates="ratings")
    video = relationship("Video", back_populates="ratings")
```

3. User ëª¨ë¸ì—ë„ ë™ì¼í•˜ê²Œ ì ìš©:
```python
# backend/app/models/user.py
class User(Base):
    ratings = relationship("Rating", back_populates="user", cascade="all, delete-orphan")
    watch_history = relationship("WatchHistory", back_populates="user", cascade="all, delete-orphan")
```

**Cascade ë™ì‘ ì›ë¦¬**:
```
Video ì‚­ì œ
  â†“ cascade="all, delete-orphan"
  â”œâ”€ ratings ìë™ ì‚­ì œ
  â””â”€ watch_history ìë™ ì‚­ì œ
```

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
```bash
# Before
DELETE /api/v1/videos/11
â†’ 500 Internal Server Error
â†’ IntegrityError: null value in column "video_id"

# After
DELETE /api/v1/videos/11
â†’ 204 No Content
â†’ ratings, watch_history ìë™ ì‚­ì œ âœ…
```

---

## ğŸ†• ì‹ ê·œ ê¸°ëŠ¥

### 2. HLS ë³€í™˜ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ì¶”ì 

**ìš”êµ¬ì‚¬í•­**:
- HLS ë³€í™˜ ì¤‘ ëª‡ % ì™„ë£Œë˜ì—ˆëŠ”ì§€ í‘œì‹œ
- í˜„ì¬ ì–´ë–¤ í™”ì§ˆì„ ë³€í™˜ ì¤‘ì¸ì§€ í‘œì‹œ
- ì™„ë£Œëœ í™”ì§ˆ ìˆ˜ / ì „ì²´ í™”ì§ˆ ìˆ˜ í‘œì‹œ

**ì•„í‚¤í…ì²˜**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚      â”‚   Backend    â”‚      â”‚ FFmpeg      â”‚
â”‚             â”‚      â”‚              â”‚      â”‚ (ë³€í™˜ ì¤‘)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â”‚ POST /convert-hls   â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  start conversion   â”‚
       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                     â”‚                     â”‚
       â”‚ GET /hls/progress   â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
       â”‚ { progress: 25% }   â”‚  check status       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                     â”‚                     â”‚
       â”‚ (2ì´ˆ í›„)            â”‚                     â”‚
       â”‚ GET /hls/progress   â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
       â”‚ { progress: 50% }   â”‚                     â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚ GET /hls/progress   â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  completed!         â”‚
       â”‚ { progress: 100% }  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚ window.reload()     â”‚                     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë°±ì—”ë“œ êµ¬í˜„**:

```python
# backend/app/services/hls_service.py

# ë©”ëª¨ë¦¬ ê¸°ë°˜ ì§„í–‰ë¥  ìºì‹œ
_conversion_progress: dict[str, dict] = {}

async def convert_video_to_hls(
    original_path: str,
    qualities: Optional[list[QualityType]] = None
) -> bool:
    if qualities is None:
        qualities = ["480p", "720p", "1080p", "4k"]

    # ì§„í–‰ë¥  ì´ˆê¸°í™”
    _conversion_progress[original_path] = {
        "status": "converting",
        "progress": 0,
        "current_quality": qualities[0],
        "total_qualities": len(qualities),
        "completed_qualities": 0,
        "started_at": datetime.now(),
        "error": None
    }

    successful_qualities = []
    try:
        for idx, quality in enumerate(qualities):
            # í˜„ì¬ í™”ì§ˆ ì—…ë°ì´íŠ¸
            _conversion_progress[original_path]["current_quality"] = quality
            _conversion_progress[original_path]["progress"] = int((idx / len(qualities)) * 100)

            # FFmpeg ë³€í™˜
            success = await convert_to_hls_quality(original_path, hls_dir, quality)

            if success:
                successful_qualities.append(quality)
                # ì™„ë£Œ ìˆ˜ ì—…ë°ì´íŠ¸
                _conversion_progress[original_path]["completed_qualities"] = len(successful_qualities)
                # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                _conversion_progress[original_path]["progress"] = int(((idx + 1) / len(qualities)) * 100)

        # ì™„ë£Œ í‘œì‹œ
        _conversion_progress[original_path]["status"] = "completed"
        _conversion_progress[original_path]["progress"] = 100
        return True

    except Exception as e:
        # ì‹¤íŒ¨ í‘œì‹œ
        _conversion_progress[original_path]["status"] = "failed"
        _conversion_progress[original_path]["error"] = str(e)
        return False


def get_conversion_progress(original_path: str) -> Optional[dict]:
    """ì§„í–‰ë¥  ì¡°íšŒ"""
    return _conversion_progress.get(original_path)
```

**API ì—”ë“œí¬ì¸íŠ¸**:

```python
# backend/app/api/v1/videos.py

@router.get("/{video_id}/hls/progress")
async def get_hls_conversion_progress(
    video_id: int,
    db: AsyncSession = Depends(get_db)
):
    """
    GET /api/v1/videos/{video_id}/hls/progress

    Returns:
    {
        "video_id": 13,
        "status": "converting",  # converting | completed | failed | not_started
        "progress": 50,          # 0-100
        "current_quality": "720p",
        "total_qualities": 4,
        "completed_qualities": 2,
        "error": null
    }
    """
    video = await video_service.get_by_id(db, video_id)
    if not video:
        raise HTTPException(404, "Video not found")

    # ì´ë¯¸ ì™„ë£Œëœ ê²½ìš°
    if hls_service.is_hls_available(video.file_path):
        return {
            "video_id": video_id,
            "status": "completed",
            "progress": 100,
            "current_quality": None,
            "total_qualities": 4,
            "completed_qualities": 4,
            "error": None
        }

    # ì§„í–‰ ì¤‘ì¸ ê²½ìš°
    progress = hls_service.get_conversion_progress(video.file_path)
    if not progress:
        return {
            "video_id": video_id,
            "status": "not_started",
            "progress": 0,
            ...
        }

    return {"video_id": video_id, **progress}
```

**í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„**:

```typescript
// frontend/src/pages/VideoPlayer.tsx

// ìƒíƒœ ì¶”ê°€
const [hlsProgress, setHlsProgress] = useState<{
  progress: number;
  currentQuality: string | null;
  completedQualities: number;
  totalQualities: number;
} | null>(null);

// ë³€í™˜ ì‹œì‘
const convertToHls = async (videoId: number) => {
  setHlsConverting(true);
  setHlsProgress({
    progress: 0,
    currentQuality: null,
    completedQualities: 0,
    totalQualities: 4
  });

  // ë³€í™˜ ì‹œì‘ ìš”ì²­
  await apiClient.post(`/videos/${videoId}/convert-hls`);

  // 2ì´ˆë§ˆë‹¤ ì§„í–‰ë¥  í™•ì¸
  const checkInterval = setInterval(async () => {
    try {
      const progressResponse = await apiClient.get(`/videos/${videoId}/hls/progress`);
      const progressData = progressResponse.data;

      console.log('HLS progress:', progressData);

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      setHlsProgress({
        progress: progressData.progress,
        currentQuality: progressData.current_quality,
        completedQualities: progressData.completed_qualities,
        totalQualities: progressData.total_qualities
      });

      // ì™„ë£Œ í™•ì¸
      if (progressData.status === 'completed') {
        clearInterval(checkInterval);
        setHlsConverting(false);
        setHlsProgress(null);
        window.location.reload();  // HLSë¡œ ì¬ìƒ
      } else if (progressData.status === 'failed') {
        clearInterval(checkInterval);
        setHlsConverting(false);
        setHlsProgress(null);
        alert('HLS ë³€í™˜ ì‹¤íŒ¨: ' + (progressData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    } catch (err) {
      console.error('Failed to check HLS progress:', err);
    }
  }, 2000);
};
```

**UI ì»´í¬ë„ŒíŠ¸**:

```jsx
{hlsConverting && hlsProgress && (
  <div className="bg-yellow-900/30 border border-yellow-700 rounded p-3">
    <p className="font-semibold mb-2">â³ HLS ë³€í™˜ ì§„í–‰ ì¤‘...</p>

    {/* Progress Bar */}
    <div className="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
      <div
        className="bg-yellow-500 h-full transition-all duration-300 ease-out"
        style={{ width: `${hlsProgress.progress}%` }}
      />
    </div>

    {/* Progress Info */}
    <div className="text-sm space-y-1 mt-2">
      <p className="font-semibold text-yellow-200">
        {hlsProgress.progress}% ì™„ë£Œ
      </p>
      {hlsProgress.currentQuality && (
        <p>
          ğŸ¬ í˜„ì¬ ë³€í™˜ ì¤‘: <span className="font-bold">{hlsProgress.currentQuality.toUpperCase()}</span>
        </p>
      )}
      <p>
        ğŸ“Š ì§„í–‰ ìƒí™©: {hlsProgress.completedQualities}/{hlsProgress.totalQualities} í™”ì§ˆ ì™„ë£Œ
      </p>
    </div>

    <p className="mt-2 text-xs text-yellow-400">
      ë³€í™˜ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ HLS ìŠ¤íŠ¸ë¦¬ë°ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
    </p>
  </div>
)}
```

**ë™ì‘ íë¦„**:

```
1. ë³€í™˜ ì‹œì‘
   â”œâ”€ POST /convert-hls
   â”œâ”€ ë°±ì—”ë“œ: FFmpeg ì‹œì‘
   â””â”€ ì§„í–‰ë¥  ìºì‹œ ì´ˆê¸°í™”

2. ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (2ì´ˆë§ˆë‹¤)
   â”œâ”€ GET /hls/progress
   â”œâ”€ { progress: 0%, current: "480p", completed: 0/4 }
   â”œâ”€ UI: ì§„í–‰ë¥  ë°” 0%
   â”œâ”€ UI: "í˜„ì¬ ë³€í™˜ ì¤‘: 480P"
   â””â”€ UI: "ì§„í–‰ ìƒí™©: 0/4 í™”ì§ˆ ì™„ë£Œ"

3. 480p ì™„ë£Œ
   â”œâ”€ GET /hls/progress
   â”œâ”€ { progress: 25%, current: "720p", completed: 1/4 }
   â””â”€ UI: ì§„í–‰ë¥  ë°” 25%

4. 720p ì™„ë£Œ
   â”œâ”€ GET /hls/progress
   â”œâ”€ { progress: 50%, current: "1080p", completed: 2/4 }
   â””â”€ UI: ì§„í–‰ë¥  ë°” 50%

5. 1080p ì™„ë£Œ
   â”œâ”€ GET /hls/progress
   â”œâ”€ { progress: 75%, current: "4k", completed: 3/4 }
   â””â”€ UI: ì§„í–‰ë¥  ë°” 75%

6. 4k ì™„ë£Œ
   â”œâ”€ GET /hls/progress
   â”œâ”€ { progress: 100%, status: "completed", completed: 4/4 }
   â”œâ”€ UI: ì§„í–‰ë¥  ë°” 100%
   â””â”€ window.location.reload()
```

**ì¥ì **:
- âœ… ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í™•ì¸
- âœ… ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ (ëŒ€ê¸° ì‹œê°„ ì²´ê° ê°ì†Œ)
- âœ… ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì•Œë¦¼
- âœ… ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜

**ì œí•œì‚¬í•­**:
- âš ï¸ ë©”ëª¨ë¦¬ ê¸°ë°˜ ìºì‹œ (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”)
- âš ï¸ ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œ ë™ê¸°í™” ì•ˆë¨
- â†’ ì¶”í›„ Redisë¡œ ê°œì„  ê°€ëŠ¥

---

### 3. í™”ì§ˆ ì„ íƒ UIë¥¼ í”Œë ˆì´ì–´ ë‚´ë¶€ë¡œ ì´ë™

**Before**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   â”‚
â”‚         Video Player              â”‚
â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í™”ì§ˆ ì„ íƒ: [â–¼ ìë™ (ê¶Œì¥)]        â”‚  â† ì™¸ë¶€ ë“œë¡­ë‹¤ìš´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… HLS ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**After (YouTube/Netflix ë°©ì‹)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   â”‚
â”‚         Video Player              â”‚
â”‚                                   â”‚
â”‚ [â–¶] [â”â”â”â”â”â—â”â”] [ğŸ”Š] [âš™ï¸] [â›¶]     â”‚  â† í”Œë ˆì´ì–´ ë‚´ë¶€ ë²„íŠ¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘
                  í™”ì§ˆ ì„ íƒ ë²„íŠ¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… HLS ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„ ìƒì„¸**:

**1ë‹¨ê³„: Video.js MenuButton ì»¤ìŠ¤í„°ë§ˆì´ì§•**

```typescript
// frontend/src/pages/VideoPlayer.tsx

player.ready(() => {
  // Video.js ì»´í¬ë„ŒíŠ¸ ê°€ì ¸ì˜¤ê¸°
  const QualityButton = videojs.getComponent('MenuButton');
  const QualityMenuItem = videojs.getComponent('MenuItem');

  // ì»¤ìŠ¤í…€ í™”ì§ˆ ë²„íŠ¼ í´ë˜ìŠ¤
  class QualityMenuButton extends QualityButton {
    constructor(player: any, options: any) {
      super(player, options);
      this.controlText('í™”ì§ˆ');  // ì ‘ê·¼ì„± í…ìŠ¤íŠ¸
    }

    createEl() {
      const el = super.createEl();
      el.classList.add('vjs-quality-button');  // ì»¤ìŠ¤í…€ CSS í´ë˜ìŠ¤
      return el;
    }

    createItems() {
      const items: any[] = [];

      if (hlsAvailable) {
        // HLS ëª¨ë“œ: ìë™ + ë³€í™˜ëœ í™”ì§ˆë“¤
        items.push(new QualityMenuItem(player, {
          label: 'ìë™',
          selected: selectedQuality === 'auto',
          selectable: true
        }));

        availableQualities.forEach((quality: string) => {
          items.push(new QualityMenuItem(player, {
            label: quality.toUpperCase(),  // 480P, 720P, ...
            selected: selectedQuality === quality,
            selectable: true
          }));
        });
      } else {
        // ë¹„-HLS ëª¨ë“œ: ì›ë³¸ + ë³€í™˜ ê°€ëŠ¥ í™”ì§ˆë“¤
        const qualities = ['original', '480p', '720p', '1080p', '4k'];
        qualities.forEach((quality: string) => {
          const isAvailable = availableQualities.includes(quality);
          const label = quality === 'original' ? 'ì›ë³¸' : quality.toUpperCase();
          const displayLabel = isAvailable ? label : `${label} (ë³€í™˜ í•„ìš”)`;

          items.push(new QualityMenuItem(player, {
            label: displayLabel,
            selected: selectedQuality === quality,
            selectable: true
          }));
        });
      }

      // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
      items.forEach((item, index) => {
        item.on('click', () => {
          let quality: string;
          if (hlsAvailable) {
            // HLS: ìë™ ë˜ëŠ” í™”ì§ˆ ì„ íƒ
            quality = index === 0 ? 'auto' : availableQualities[index - 1];
          } else {
            // ë¹„-HLS: ì›ë³¸ ë˜ëŠ” í™”ì§ˆ ì„ íƒ
            const qualities = ['original', '480p', '720p', '1080p', '4k'];
            quality = qualities[index];
          }
          changeQuality(quality);  // í™”ì§ˆ ë³€ê²½ í•¨ìˆ˜ í˜¸ì¶œ
        });
      });

      return items;
    }
  }

  // Video.jsì— ì»¤ìŠ¤í…€ ì»´í¬ë„ŒíŠ¸ ë“±ë¡
  videojs.registerComponent('QualityMenuButton', QualityMenuButton);

  // ì»¨íŠ¸ë¡¤ ë°”ì— ë²„íŠ¼ ì¶”ê°€ (í’€ìŠ¤í¬ë¦° ë²„íŠ¼ ë°”ë¡œ ì™¼ìª½)
  player.getChild('controlBar').addChild('QualityMenuButton', {},
    player.getChild('controlBar').children().length - 1
  );
});
```

**2ë‹¨ê³„: CSS ìŠ¤íƒ€ì¼ë§**

```css
/* frontend/src/index.css */

/* í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ */
.vjs-quality-button .vjs-icon-placeholder:before {
  content: "âš™ï¸";
  font-size: 1.5em;
  line-height: 1.67;
}

/* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
.vjs-quality-button .vjs-menu {
  min-width: 150px;
}

/* ë©”ë‰´ ì•„ì´í…œ */
.vjs-quality-button .vjs-menu-item {
  text-transform: none;  /* ëŒ€ë¬¸ì ë³€í™˜ ë°©ì§€ */
  font-size: 13px;
  padding: 0.5em 1em;
}

/* ì„ íƒëœ ì•„ì´í…œ */
.vjs-quality-button .vjs-menu-item.vjs-selected {
  background-color: rgba(255, 255, 255, 0.2);
  color: #fff;
}

/* í˜¸ë²„ íš¨ê³¼ */
.vjs-quality-button .vjs-menu-item:hover {
  background-color: rgba(255, 255, 255, 0.1);
}
```

**3ë‹¨ê³„: ì™¸ë¶€ ë“œë¡­ë‹¤ìš´ ì œê±°**

```diff
- {/* Quality Selector */}
- <div className="bg-gray-800 rounded-lg p-4 mb-4">
-   <div className="flex items-center justify-between mb-2">
-     <span className="text-sm text-gray-400">í™”ì§ˆ ì„ íƒ:</span>
-     <select value={selectedQuality} onChange={(e) => changeQuality(e.target.value)}>
-       {hlsAvailable && <option value="auto">ìë™ (ê¶Œì¥) âœ“</option>}
-       {hlsAvailable && availableQualities.map(q => (
-         <option key={q} value={q}>{q.toUpperCase()} âœ“</option>
-       ))}
-       ...
-     </select>
-   </div>
- </div>

+ {/* HLS Status & Controls */}
+ <div className="bg-gray-800 rounded-lg p-4 mb-4">
+   {/* HLS ìƒíƒœ í‘œì‹œë§Œ ìœ ì§€ */}
+ </div>
```

**ë™ì‘ ë°©ì‹**:

```
1. í”Œë ˆì´ì–´ ë¡œë“œ
   â”œâ”€ Video.js ì´ˆê¸°í™”
   â”œâ”€ QualityMenuButton ì»´í¬ë„ŒíŠ¸ ìƒì„±
   â”œâ”€ controlBarì— ë²„íŠ¼ ì¶”ê°€
   â””â”€ âš™ï¸ ì•„ì´ì½˜ í‘œì‹œ

2. ë²„íŠ¼ í´ë¦­
   â”œâ”€ createItems() í˜¸ì¶œ
   â”œâ”€ HLS ì—¬ë¶€ì— ë”°ë¼ ë©”ë‰´ ì•„ì´í…œ ìƒì„±
   â”œâ”€ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í¼ì¹¨
   â””â”€ ì„ íƒ ê°€ëŠ¥í•œ í™”ì§ˆ ëª©ë¡ í‘œì‹œ

3. í™”ì§ˆ ì„ íƒ
   â”œâ”€ MenuItem í´ë¦­ ì´ë²¤íŠ¸
   â”œâ”€ changeQuality() í•¨ìˆ˜ í˜¸ì¶œ
   â”œâ”€ ë¹„ë””ì˜¤ ì†ŒìŠ¤ ë³€ê²½
   â”œâ”€ ì¬ìƒ ìœ„ì¹˜ ìœ ì§€
   â””â”€ ìƒˆ í™”ì§ˆë¡œ ì¬ìƒ

4. ë©”ë‰´ ë‹«í˜
   â”œâ”€ ì„ íƒëœ ì•„ì´í…œ í•˜ì´ë¼ì´íŠ¸
   â””â”€ âš™ï¸ ë²„íŠ¼ìœ¼ë¡œ ëŒì•„ê°
```

**ì¥ì **:
- âœ… YouTube/Netflixì™€ ë™ì¼í•œ UX
- âœ… í”Œë ˆì´ì–´ì— í†µí•©ëœ ê¹”ë”í•œ UI
- âœ… ì„ íƒëœ í™”ì§ˆ ì‹œê°ì  í‘œì‹œ
- âœ… í˜¸ë²„ íš¨ê³¼ë¡œ ìƒí˜¸ì‘ìš© ëª…í™•
- âœ… ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëª¨ë‘ ì§€ì›

**ë¹„êµ**:

| í•­ëª© | Before (ì™¸ë¶€ ë“œë¡­ë‹¤ìš´) | After (í”Œë ˆì´ì–´ ë‚´ë¶€) |
|------|----------------------|---------------------|
| **ìœ„ì¹˜** | í”Œë ˆì´ì–´ ì™¸ë¶€ | ì»¨íŠ¸ë¡¤ ë°” ë‚´ë¶€ |
| **ì ‘ê·¼ì„±** | í”Œë ˆì´ì–´ì™€ ë¶„ë¦¬ | í”Œë ˆì´ì–´ í†µí•© |
| **ìŠ¤íƒ€ì¼** | ì¼ë°˜ HTML select | Video.js ìŠ¤íƒ€ì¼ |
| **UX** | ì¼ë°˜ì ì´ì§€ ì•ŠìŒ | YouTube/Netflixì™€ ë™ì¼ |
| **ì„ íƒ í‘œì‹œ** | í…ìŠ¤íŠ¸ë¡œë§Œ í‘œì‹œ | í•˜ì´ë¼ì´íŠ¸ + ì²´í¬ |

---

## ğŸ“ ìˆ˜ì • íŒŒì¼ ëª©ë¡

### ë°±ì—”ë“œ (6ê°œ)

1. **`backend/app/models/video.py`**
   - ratings, watch_history relationship ì¶”ê°€
   - cascade="all, delete-orphan" ì„¤ì •

2. **`backend/app/models/user.py`**
   - ratings, watch_history relationship ì¶”ê°€
   - cascade="all, delete-orphan" ì„¤ì •

3. **`backend/app/models/rating.py`**
   - backref â†’ back_populates ë³€ê²½

4. **`backend/app/models/watch_history.py`**
   - backref â†’ back_populates ë³€ê²½

5. **`backend/app/services/hls_service.py`**
   - ì§„í–‰ë¥  ì¶”ì  ì‹œìŠ¤í…œ ì¶”ê°€
   - `_conversion_progress` ìºì‹œ
   - `get_conversion_progress()` í•¨ìˆ˜
   - 4K ê¸°ë³¸ í™”ì§ˆ ì¶”ê°€

6. **`backend/app/api/v1/videos.py`**
   - `GET /videos/{video_id}/hls/progress` API ì¶”ê°€

7. **`backend/add_4k_hls.py`** (ì‹ ê·œ)
   - ê¸°ì¡´ ë¹„ë””ì˜¤ì— 4K ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸

### í”„ë¡ íŠ¸ì—”ë“œ (2ê°œ)

1. **`frontend/src/pages/VideoPlayer.tsx`**
   - hlsProgress ìƒíƒœ ì¶”ê°€
   - convertToHls() í•¨ìˆ˜ ì§„í–‰ë¥  polling ì¶”ê°€
   - Video.js QualityMenuButton ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
   - ì™¸ë¶€ ë“œë¡­ë‹¤ìš´ ì œê±°

2. **`frontend/src/index.css`**
   - .vjs-quality-button ìŠ¤íƒ€ì¼ ì¶”ê°€
   - ë©”ë‰´ ì•„ì´í…œ ìŠ¤íƒ€ì¼
   - í˜¸ë²„/ì„ íƒ íš¨ê³¼

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ë¹„ë””ì˜¤ ì‚­ì œ í…ŒìŠ¤íŠ¸
```bash
# í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. ë¹„ë””ì˜¤ ID 11 ì‚­ì œ ì‹œë„
2. í•´ë‹¹ ë¹„ë””ì˜¤ì˜ ratings 2ê°œ ì¡´ì¬
3. í•´ë‹¹ ë¹„ë””ì˜¤ì˜ watch_history 1ê°œ ì¡´ì¬

# Before
DELETE /api/v1/videos/11
â†’ 500 Internal Server Error
â†’ IntegrityError

# After
DELETE /api/v1/videos/11
â†’ 204 No Content
â†’ ratings 2ê°œ ìë™ ì‚­ì œ âœ…
â†’ watch_history 1ê°œ ìë™ ì‚­ì œ âœ…
â†’ ë¹„ë””ì˜¤ íŒŒì¼ ì‚­ì œ âœ…
```

### HLS ì§„í–‰ë¥  í…ŒìŠ¤íŠ¸
```bash
# ë¹„ë””ì˜¤ ID 13 ë³€í™˜

# t=0s: ë³€í™˜ ì‹œì‘
POST /api/v1/videos/13/convert-hls
â†’ 202 Accepted

# t=2s: ì²« ë²ˆì§¸ í™•ì¸
GET /api/v1/videos/13/hls/progress
â†’ {
  "status": "converting",
  "progress": 0,
  "current_quality": "480p",
  "completed_qualities": 0,
  "total_qualities": 4
}

# t=20s: 480p ì™„ë£Œ
GET /api/v1/videos/13/hls/progress
â†’ {
  "progress": 25,
  "current_quality": "720p",
  "completed_qualities": 1
}

# t=45s: 720p ì™„ë£Œ
GET /api/v1/videos/13/hls/progress
â†’ {
  "progress": 50,
  "current_quality": "1080p",
  "completed_qualities": 2
}

# t=75s: 1080p ì™„ë£Œ
GET /api/v1/videos/13/hls/progress
â†’ {
  "progress": 75,
  "current_quality": "4k",
  "completed_qualities": 3
}

# t=110s: 4k ì™„ë£Œ
GET /api/v1/videos/13/hls/progress
â†’ {
  "status": "completed",
  "progress": 100,
  "completed_qualities": 4
}
â†’ window.location.reload() âœ…
```

### í™”ì§ˆ ì„ íƒ í…ŒìŠ¤íŠ¸
```
1. í”Œë ˆì´ì–´ ë¡œë“œ
   âœ… âš™ï¸ ë²„íŠ¼ í‘œì‹œ í™•ì¸

2. ë²„íŠ¼ í´ë¦­
   âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í‘œì‹œ
   âœ… HLS ëª¨ë“œ: ìë™, 480P, 720P, 1080P, 4K
   âœ… ë¹„-HLS ëª¨ë“œ: ì›ë³¸, 480P (ë³€í™˜ í•„ìš”), ...

3. í™”ì§ˆ ì „í™˜
   âœ… 480P ì„ íƒ â†’ ì¬ìƒ ìœ„ì¹˜ ìœ ì§€í•˜ë©° ì „í™˜
   âœ… 720P ì„ íƒ â†’ ì¬ìƒ ìœ„ì¹˜ ìœ ì§€í•˜ë©° ì „í™˜
   âœ… 4K ì„ íƒ â†’ ì¬ìƒ ìœ„ì¹˜ ìœ ì§€í•˜ë©° ì „í™˜
   âœ… ìë™ ì„ íƒ â†’ adaptive ìŠ¤íŠ¸ë¦¬ë°

4. UI í”¼ë“œë°±
   âœ… ì„ íƒëœ í™”ì§ˆ í•˜ì´ë¼ì´íŠ¸
   âœ… í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½
   âœ… ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
```

---

## ğŸ“Š ì„±ëŠ¥ ì¸¡ì •

### HLS ë³€í™˜ ì‹œê°„
```
ë¹„ë””ì˜¤: 12MB, 1ë¶„ 30ì´ˆ ê¸¸ì´

480p:  ~18ì´ˆ
720p:  ~22ì´ˆ
1080p: ~28ì´ˆ
4k:    ~35ì´ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´:    ~103ì´ˆ (1ë¶„ 43ì´ˆ)
```

### API ì‘ë‹µ ì‹œê°„
```
GET /hls/progress
â†’ í‰ê· : 15ms
â†’ ìµœëŒ€: 45ms
â†’ ìµœì†Œ: 8ms
```

### í´ë§ ì˜¤ë²„í—¤ë“œ
```
ê°„ê²©: 2ì´ˆ
ìš”ì²­ í¬ê¸°: ~200 bytes
ì‘ë‹µ í¬ê¸°: ~300 bytes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
100ì´ˆ ë³€í™˜ ì‹œ:
ì´ ìš”ì²­: 50íšŒ
ì´ ë°ì´í„°: ~25KB (ë¬´ì‹œí•  ìˆ˜ì¤€)
```

---

## ğŸ’¡ ê¸°ìˆ  ìƒì„¸

### SQLAlchemy Cascade

**ì¢…ë¥˜**:
- `all`: save-update, merge, delete, delete-orphan, expunge, refresh-expire
- `delete`: ë¶€ëª¨ ì‚­ì œ ì‹œ ìì‹ë„ ì‚­ì œ
- `delete-orphan`: ë¶€ëª¨ì™€ ì—°ê²° ëŠê¸´ ìì‹ ì‚­ì œ
- `all, delete-orphan`: ì¼ë°˜ì ìœ¼ë¡œ ê°€ì¥ ë§ì´ ì‚¬ìš©

**ë™ì‘**:
```python
# cascade="all, delete-orphan"
video = Video(id=1)
rating = Rating(video_id=1)
video.ratings.append(rating)

# ë¹„ë””ì˜¤ ì‚­ì œ
db.delete(video)
db.commit()
# â†’ ratingë„ ìë™ ì‚­ì œ âœ…

# ê´€ê³„ ì œê±°
video.ratings.remove(rating)
db.commit()
# â†’ rating ìë™ ì‚­ì œ âœ… (orphan)
```

### Video.js Plugin íŒ¨í„´

**êµ¬ì¡°**:
```
Component (ê¸°ë³¸ í´ë˜ìŠ¤)
  â””â”€ Button
      â””â”€ MenuButton (ë“œë¡­ë‹¤ìš´ ë²„íŠ¼)
          â””â”€ QualityMenuButton (ì»¤ìŠ¤í…€)
```

**ìƒëª…ì£¼ê¸°**:
```
1. constructor() - ì´ˆê¸°í™”
2. createEl() - DOM ìš”ì†Œ ìƒì„±
3. createItems() - ë©”ë‰´ ì•„ì´í…œ ìƒì„±
4. on('click') - ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
5. dispose() - ì •ë¦¬
```

### ì§„í–‰ë¥  ìºì‹œ ì „ëµ

**ë©”ëª¨ë¦¬ ê¸°ë°˜**:
```python
_conversion_progress = {
    "/path/to/video.mp4": {
        "status": "converting",
        "progress": 50,
        ...
    }
}
```

**ì¥ì **:
- ë¹ ë¦„ (ë©”ëª¨ë¦¬ ì ‘ê·¼)
- êµ¬í˜„ ê°„ë‹¨
- ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ

**ë‹¨ì **:
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ì†ì‹¤
- ì—¬ëŸ¬ ì„œë²„ì—ì„œ ê³µìœ  ì•ˆë¨

**ê°œì„  ë°©ì•ˆ (ì¶”í›„)**:
```python
# Redis ì‚¬ìš©
import redis
r = redis.Redis()

# ì§„í–‰ë¥  ì €ì¥ (TTL: 1ì‹œê°„)
r.setex(
    f"hls:progress:{video_id}",
    3600,
    json.dumps(progress_data)
)

# ì§„í–‰ë¥  ì¡°íšŒ
progress = json.loads(r.get(f"hls:progress:{video_id}"))
```

---

## ğŸš€ ê°œì„  íš¨ê³¼

### Before
- âŒ ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ 500 ì—ëŸ¬
- âŒ HLS ë³€í™˜ ì§„í–‰ ìƒí™© ì•Œ ìˆ˜ ì—†ìŒ
- âŒ í”Œë ˆì´ì–´ ì™¸ë¶€ í™”ì§ˆ ì„ íƒ (ì¼ê´€ì„± ì—†ëŠ” UX)
- âŒ 4K ë¯¸ì§€ì›

### After
- âœ… ë¹„ë””ì˜¤ ì‚­ì œ ì •ìƒ ë™ì‘
- âœ… ì‹¤ì‹œê°„ ì§„í–‰ë¥  í‘œì‹œ (0% â†’ 100%)
- âœ… í”Œë ˆì´ì–´ í†µí•© í™”ì§ˆ ì„ íƒ (YouTube/Netflix ë°©ì‹)
- âœ… 4K ì§€ì›

---

## ğŸ”œ í–¥í›„ ê°œì„  ì‚¬í•­

### ì§„í–‰ë¥  ì¶”ì 
- [ ] Redisë¡œ ìºì‹œ ì´ë™ (ë‹¤ì¤‘ ì„œë²„ ì§€ì›)
- [ ] WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ push
- [ ] ë³€í™˜ ì·¨ì†Œ ê¸°ëŠ¥

### í™”ì§ˆ ì„ íƒ
- [ ] í˜„ì¬ ì¬ìƒ í™”ì§ˆ ë²„íŠ¼ì— í‘œì‹œ
- [ ] í™”ì§ˆë³„ ëŒ€ì—­í­ ì •ë³´ í‘œì‹œ
- [ ] ìë™ í™”ì§ˆ ì•Œê³ ë¦¬ì¦˜ ê°œì„ 

### íŒŒì¼ ê´€ë¦¬
- [ ] ì›ë³¸ íŒŒì¼ ìë™ ì‚­ì œ ì˜µì…˜
- [ ] ì €ì¥ ê³µê°„ í†µê³„ ëŒ€ì‹œë³´ë“œ
- [ ] HLS íŒŒì¼ ë¬´ê²°ì„± ê²€ì‚¬

---

**ì‘ì„±ì¼**: 2026-02-02
**ë²„ì „**: v0.13.1
**ìƒíƒœ**: âœ… ì™„ë£Œ ë° ë°°í¬ë¨
