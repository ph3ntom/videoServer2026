# v0.2 - ë¹„ë””ì˜¤ ì—…ë¡œë“œ ë° ìŠ¤íŠ¸ë¦¬ë° (Video Upload & Streaming)

## ğŸ“‹ ê¸°ëŠ¥ ê°œìš”

ë¹„ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ, ë©”íƒ€ë°ì´í„° ì¶”ì¶œ, ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë¹„ë””ì˜¤ ê´€ë¦¬ ì‹œìŠ¤í…œ

### ì£¼ìš” ê¸°ëŠ¥
- ë¹„ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ (ìµœëŒ€ 5GB)
- FFmpegë¥¼ í†µí•œ ë©”íƒ€ë°ì´í„° ìë™ ì¶”ì¶œ (í•´ìƒë„, ê¸¸ì´, ì½”ë± ë“±)
- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë° (HTTP Progressive Download)
- ë¹„ë””ì˜¤ ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
- ë¹„ë””ì˜¤ ìˆ˜ì •/ì‚­ì œ (ì—…ë¡œë”ë§Œ ê°€ëŠ¥)
- ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

### 1. ë¹„ë””ì˜¤ ì—…ë¡œë“œ
```http
POST /api/v1/videos/upload
Authorization: Bearer {access_token}
Content-Type: multipart/form-data

file: (binary)
title: "ë¹„ë””ì˜¤ ì œëª©"
description: "ë¹„ë””ì˜¤ ì„¤ëª…" (optional)
```

**ì‘ë‹µ**
```json
{
  "id": 1,
  "title": "ë¹„ë””ì˜¤ ì œëª©",
  "description": "ë¹„ë””ì˜¤ ì„¤ëª…",
  "file_path": "/tmp/videos/uuid.mp4",
  "file_size": 104857600,
  "thumbnail_path": "/tmp/videos/thumbnails/1/thumb_001.webp",
  "duration": 120,
  "width": 1920,
  "height": 1080,
  "status": "READY",
  "view_count": 0,
  "created_at": "2026-01-07T00:00:00Z",
  "user_id": 1
}
```

### 2. ë¹„ë””ì˜¤ ëª©ë¡ ì¡°íšŒ
```http
GET /api/v1/videos/?skip=0&limit=20
```

**ì‘ë‹µ**
```json
[
  {
    "id": 1,
    "title": "ë¹„ë””ì˜¤ ì œëª©",
    "description": "ë¹„ë””ì˜¤ ì„¤ëª…",
    "file_size": 104857600,
    "thumbnail_path": "/tmp/videos/thumbnails/1/thumb_001.webp",
    "duration": 120,
    "width": 1920,
    "height": 1080,
    "status": "READY",
    "view_count": 0,
    "created_at": "2026-01-07T00:00:00Z",
    "uploader_username": "username"
  }
]
```

### 3. ë¹„ë””ì˜¤ ìƒì„¸ ì¡°íšŒ
```http
GET /api/v1/videos/{video_id}
```

### 4. ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
```http
GET /api/v1/videos/{video_id}/stream
```

**ì‘ë‹µ**: HTTP Streaming Response (video/mp4)

### 5. ë‚´ ë¹„ë””ì˜¤ ëª©ë¡
```http
GET /api/v1/videos/my-videos?skip=0&limit=20
Authorization: Bearer {access_token}
```

### 6. ë¹„ë””ì˜¤ ìˆ˜ì •
```http
PUT /api/v1/videos/{video_id}
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "title": "ìƒˆ ì œëª©",
  "description": "ìƒˆ ì„¤ëª…"
}
```

### 7. ë¹„ë””ì˜¤ ì‚­ì œ
```http
DELETE /api/v1/videos/{video_id}
Authorization: Bearer {access_token}
```

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

```mermaid
erDiagram
    users {
        int id PK
        string email UK
        string username UK
    }

    videos {
        int id PK
        int user_id FK
        string title
        text description
        string file_path
        bigint file_size
        string thumbnail_path
        int duration
        int width
        int height
        enum status
        int view_count
        datetime created_at
        datetime updated_at
    }

    users ||--o{ videos : "uploads"
```

### videos í…Œì´ë¸”
| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| id | Integer | PK | ë¹„ë””ì˜¤ ID |
| user_id | Integer | FK(users.id), NOT NULL | ì—…ë¡œë” ID |
| title | String(255) | NOT NULL | ì œëª© |
| description | Text | NULL | ì„¤ëª… |
| file_path | String(500) | NOT NULL | íŒŒì¼ ê²½ë¡œ |
| file_size | BigInteger | NULL | íŒŒì¼ í¬ê¸° (bytes) |
| thumbnail_path | String(500) | NULL | ì¸ë„¤ì¼ ê²½ë¡œ |
| duration | Integer | NULL | ì¬ìƒ ì‹œê°„ (ì´ˆ) |
| width | Integer | NULL | ê°€ë¡œ í•´ìƒë„ |
| height | Integer | NULL | ì„¸ë¡œ í•´ìƒë„ |
| status | Enum | NOT NULL | ìƒíƒœ (PROCESSING, READY, ERROR) |
| view_count | Integer | DEFAULT 0 | ì¡°íšŒìˆ˜ |
| created_at | DateTime | NOT NULL | ìƒì„± ì‹œê° |
| updated_at | DateTime | NOT NULL | ìˆ˜ì • ì‹œê° |

### VideoStatus Enum
```python
class VideoStatus(str, Enum):
    PROCESSING = "processing"  # ì—…ë¡œë“œ í›„ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì¤‘
    READY = "ready"           # ì¬ìƒ ê°€ëŠ¥
    ERROR = "error"           # ì²˜ë¦¬ ì‹¤íŒ¨
```

---

## ğŸ”„ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

### ë¹„ë””ì˜¤ ì—…ë¡œë“œ í”Œë¡œìš°

```mermaid
sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant Storage
    participant FFmpeg
    participant DB

    User->>Frontend: ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ
    Frontend->>API: POST /videos/upload (multipart)

    API->>API: íŒŒì¼ í˜•ì‹ ê²€ì¦
    API->>API: íŒŒì¼ í¬ê¸° ê²€ì¦ (< 5GB)
    API->>Storage: íŒŒì¼ ì €ì¥ (UUID íŒŒì¼ëª…)

    API->>DB: Video ë ˆì½”ë“œ ìƒì„± (status=PROCESSING)
    DB-->>API: video_id

    API->>FFmpeg: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    FFmpeg-->>API: duration, width, height, codec

    API->>DB: Video ì—…ë°ì´íŠ¸ (metadata, status=READY)

    API->>FFmpeg: ì¸ë„¤ì¼ ìƒì„± (12ê°œ)
    FFmpeg-->>Storage: ì¸ë„¤ì¼ íŒŒì¼ ì €ì¥

    API->>DB: Thumbnail ë ˆì½”ë“œ ìƒì„±
    API->>DB: Video.thumbnail_path ì—…ë°ì´íŠ¸

    API-->>Frontend: Video ì •ë³´ ë°˜í™˜
    Frontend-->>User: ì—…ë¡œë“œ ì™„ë£Œ í‘œì‹œ
```

### ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë° í”Œë¡œìš°

```mermaid
sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant Storage
    participant DB

    User->>Frontend: ë¹„ë””ì˜¤ ì¬ìƒ ë²„íŠ¼ í´ë¦­
    Frontend->>API: GET /videos/{id}/stream

    API->>DB: ë¹„ë””ì˜¤ ì¡°íšŒ
    DB-->>API: Video ì •ë³´

    API->>API: ìƒíƒœ ê²€ì¦ (status=READY)
    API->>Storage: íŒŒì¼ ì¡´ì¬ í™•ì¸

    API->>DB: view_count + 1

    API->>Storage: íŒŒì¼ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
    Storage-->>Frontend: Video Stream (chunked)

    Frontend->>Frontend: Video.js ì¬ìƒ
    Frontend-->>User: ë¹„ë””ì˜¤ ì¬ìƒ
```

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```mermaid
graph TB
    subgraph "Frontend"
        A[Upload Page]
        B[Videos List]
        C[Video Player]
        D[Video.js]
    end

    subgraph "Backend API"
        E[Video Router]
        F[Video Service]
        G[File Validator]
    end

    subgraph "Processing"
        H[FFmpeg Metadata Extractor]
        I[Thumbnail Generator]
    end

    subgraph "Storage"
        J[Local Filesystem<br/>/tmp/videos/]
        K[Thumbnails<br/>/tmp/videos/thumbnails/]
    end

    subgraph "Database"
        L[(videos)]
        M[(video_thumbnails)]
    end

    A --> E
    B --> E
    C --> E
    C --> D

    E --> F
    F --> G
    F --> H
    F --> I
    F --> J
    F --> K
    F --> L
    F --> M

    H --> J
    I --> K
```

---

## ğŸ¬ FFmpeg ë©”íƒ€ë°ì´í„° ì¶”ì¶œ

### ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´

```bash
# ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
ffprobe -v error \
  -show_entries format=duration:stream=width,height,codec_name \
  -of json \
  video.mp4
```

### ì¶”ì¶œí•˜ëŠ” ì •ë³´
- `duration`: ì¬ìƒ ì‹œê°„ (ì´ˆ)
- `width`: ê°€ë¡œ í•´ìƒë„
- `height`: ì„¸ë¡œ í•´ìƒë„
- `codec_name`: ë¹„ë””ì˜¤ ì½”ë±

### ì½”ë“œ ìœ„ì¹˜
- **íŒŒì¼**: `backend/app/services/video_service.py`
- **í•¨ìˆ˜**: `update_video_metadata()`

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ videos.py                # ë¹„ë””ì˜¤ ë¼ìš°í„°
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ video.py                     # Video ëª¨ë¸
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ video.py                     # Video ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ video_service.py             # ë¹„ë””ì˜¤ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ config.py                    # ì„¤ì • (ì—…ë¡œë“œ ê²½ë¡œ ë“±)
â”‚
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Upload.tsx                   # ì—…ë¡œë“œ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ Videos.tsx                   # ë¹„ë””ì˜¤ ëª©ë¡
â”‚   â”‚   â””â”€â”€ VideoDetail.tsx              # ë¹„ë””ì˜¤ ìƒì„¸
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ video/
â”‚           â””â”€â”€ VideoPlayer.tsx          # Video.js í”Œë ˆì´ì–´
â”‚
/tmp/videos/                              # ë¹„ë””ì˜¤ ì €ì¥ì†Œ
â”œâ”€â”€ {uuid}.mp4
â”œâ”€â”€ {uuid}.mkv
â””â”€â”€ thumbnails/
    â””â”€â”€ {video_id}/
        â”œâ”€â”€ thumb_001.webp
        â””â”€â”€ ...
```

---

## ğŸ› ï¸ ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ

### ì„¤ì • ë³€ê²½

#### 1. ì—…ë¡œë“œ íŒŒì¼ í¬ê¸° ì œí•œ
```python
# backend/app/core/config.py
MAX_UPLOAD_SIZE = 5 * 1024 * 1024 * 1024  # 5GB
```

#### 2. í—ˆìš© íŒŒì¼ í˜•ì‹
```python
# backend/app/core/config.py
ALLOWED_VIDEO_EXTENSIONS = ".mp4,.mkv,.avi,.mov,.webm"
```

#### 3. ì—…ë¡œë“œ ë””ë ‰í† ë¦¬
```python
# backend/app/core/config.py
UPLOAD_DIR = "/tmp/videos"
```

### ë¬¸ì œ í•´ê²°

#### 1. FFmpeg ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨
- FFmpeg ì„¤ì¹˜ í™•ì¸: `ffmpeg -version`
- FFprobe ì„¤ì¹˜ í™•ì¸: `ffprobe -version`
- íŒŒì¼ ê¶Œí•œ í™•ì¸
- íŒŒì¼ í˜•ì‹ í˜¸í™˜ì„± í™•ì¸

**ë¡œê·¸ í™•ì¸**:
```python
# backend/app/services/video_service.py
print(f"FFmpeg error: {result.stderr}")
```

#### 2. ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ì•ˆë¨
- ë¹„ë””ì˜¤ ìƒíƒœ í™•ì¸ (status=READY)
- íŒŒì¼ ì¡´ì¬ í™•ì¸
- CORS ì„¤ì • í™•ì¸
- ë¸Œë¼ìš°ì € ì½”ë± ì§€ì› í™•ì¸

#### 3. ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨
- Nginx/ì›¹ì„œë²„ ì—…ë¡œë“œ í¬ê¸° ì œí•œ í™•ì¸
- íƒ€ì„ì•„ì›ƒ ì„¤ì • í™•ì¸
- ë””ìŠ¤í¬ ê³µê°„ í™•ì¸

### ì„±ëŠ¥ ìµœì í™”

#### 1. ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
**í˜„ì¬**: Progressive Download
**ê°œì„  ë°©ì•ˆ**:
- HLS/DASH ì ìš© (í–¥í›„)
- Range Request ì§€ì› (Seek ê¸°ëŠ¥)

#### 2. ì¸ë„¤ì¼ ìƒì„±
- ë¹„ë™ê¸° ì²˜ë¦¬ (Celery ë„ì… ê³ ë ¤)
- í˜„ì¬ëŠ” ì—…ë¡œë“œ ì‹œ ë™ê¸°ì ìœ¼ë¡œ ìƒì„±

#### 3. íŒŒì¼ ì €ì¥ì†Œ
**í˜„ì¬**: Local Filesystem
**ê°œì„  ë°©ì•ˆ**:
- S3/Object Storage ë„ì…
- CDN ì—°ë™

### ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”

#### ì¸ë±ìŠ¤
```sql
-- ì‚¬ìš©ìë³„ ë¹„ë””ì˜¤ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_videos_user_id ON videos(user_id);

-- ìƒíƒœë³„ ë¹„ë””ì˜¤ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_videos_status ON videos(status);

-- ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬ ìµœì í™”
CREATE INDEX idx_videos_created_at ON videos(created_at DESC);
```

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. íŒŒì¼ ì—…ë¡œë“œ ê²€ì¦
- íŒŒì¼ í™•ì¥ì ê²€ì¦
- MIME íƒ€ì… ê²€ì¦
- íŒŒì¼ í¬ê¸° ì œí•œ (5GB)
- íŒŒì¼ëª… UUID ë³€í™˜ (ê²½ë¡œ íƒìƒ‰ ê³µê²© ë°©ì§€)

### 2. ê¶Œí•œ ê²€ì¦
- ë¹„ë””ì˜¤ ìˆ˜ì •/ì‚­ì œ: ì—…ë¡œë”ë§Œ ê°€ëŠ¥
- JWT í† í° ê²€ì¦

### 3. íŒŒì¼ ì‹œìŠ¤í…œ ë³´ì•ˆ
- ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨
- ì‹¤í–‰ ê¶Œí•œ ì œê±°

---

## ğŸ“Š ì§€ì›í•˜ëŠ” ë¹„ë””ì˜¤ í˜•ì‹

| í˜•ì‹ | í™•ì¥ì | ì½”ë± | ë¸Œë¼ìš°ì € ì§€ì› |
|------|--------|------|--------------|
| MP4 | .mp4 | H.264, H.265 | âœ… ì „ì²´ |
| WebM | .webm | VP8, VP9, AV1 | âœ… ì „ì²´ |
| MKV | .mkv | ë‹¤ì–‘ | âš ï¸ ë³€í™˜ í•„ìš” |
| AVI | .avi | ë‹¤ì–‘ | âš ï¸ ë³€í™˜ í•„ìš” |
| MOV | .mov | ë‹¤ì–‘ | âš ï¸ Safarië§Œ |

**ê¶Œì¥**: MP4 (H.264) - ìµœìƒì˜ í˜¸í™˜ì„±

---

## ğŸ”„ ì—…ë°ì´íŠ¸ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© |
|------|------|-----------|
| v0.2 | 2026-01-07 | ë¹„ë””ì˜¤ ì—…ë¡œë“œ ë° ìŠ¤íŠ¸ë¦¬ë° ì‹œìŠ¤í…œ êµ¬í˜„ |
