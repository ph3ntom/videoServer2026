# 04. 데이터베이스 스키마

> 라즈베리파이 최적화: 핵심 테이블만 유지, 불필요한 테이블 제거

## ERD (Entity Relationship Diagram)

```
┌─────────────────────┐         ┌─────────────────────┐
│       users         │         │     categories      │
├─────────────────────┤         ├─────────────────────┤
│ id (PK)             │         │ id (PK)             │
│ email (UNIQUE)      │         │ name                │
│ username (UNIQUE)   │         │ slug (UNIQUE)       │
│ hashed_password     │         │ description         │
│ full_name           │         │ created_at          │
│ role (ENUM)         │         └─────────────────────┘
│ is_active           │                   │
│ created_at          │                   │
│ updated_at          │                   │ N:1
└──────┬──────────────┘         ┌─────────▼───────────┐
       │                        │  video_categories   │
       │ 1:N (admin만)          ├─────────────────────┤
       │                        │ video_id (PK, FK)   │
┌──────▼──────────────┐  ◄──────│ category_id (PK, FK)│
│      videos         │  N:M    └─────────────────────┘
├─────────────────────┤
│ id (PK)             │         ┌─────────────────────┐
│ user_id (FK)        │◄───┐    │       tags          │
│ title               │    │    ├─────────────────────┤
│ description         │    │    │ id (PK)             │
│ file_path           │    │    │ name (UNIQUE)       │
│ duration            │    │    │ slug (UNIQUE)       │
│ file_size           │    │    │ type (ENUM)         │
│ video_codec         │    │    │ description         │
│ resolution          │    │    │ created_at          │
│ status (ENUM)       │    │    └──────┬──────────────┘
│ view_count          │    │           │
│ created_at          │    │           │ N:M
│ updated_at          │    │    ┌──────▼──────────────┐
│ published_at        │    └────┤    video_tags       │
└──────┬──────────────┘         ├─────────────────────┤
       │                        │ video_id (PK, FK)   │
       │ 1:N                    │ tag_id (PK, FK)     │
       │                        │ created_at          │
┌──────▼──────────────┐         └─────────────────────┘
│ video_thumbnails    │
├─────────────────────┤         ┌─────────────────────┐
│ id (PK)             │         │  watch_history      │
│ video_id (FK)       │         │    (Phase 2)        │
│ file_path           │         ├─────────────────────┤
│ timestamp (seconds) │         │ id (PK)             │
│ is_selected         │         │ user_id (FK)        │
│ is_auto_generated   │         │ video_id (FK)       │
│ created_at          │         │ progress (seconds)  │
└─────────────────────┘         │ completed           │
                                │ last_watched_at     │
                                │ created_at          │
                                └─────────────────────┘

                                ┌─────────────────────┐
                                │     ratings         │
                                │    (Phase 2)        │
                                ├─────────────────────┤
                                │ id (PK)             │
                                │ user_id (FK)        │
                                │ video_id (FK)       │
                                │ score (1-5)         │
                                │ created_at          │
                                └─────────────────────┘
```

## 테이블 상세 정의

### 1. users (사용자)

사용자 계정 정보를 저장하는 테이블

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin', 'premium')),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
```

**컬럼 설명:**
- `id`: 기본 키
- `email`: 로그인용 이메일 (중복 불가)
- `username`: 사용자명 (중복 불가)
- `hashed_password`: bcrypt 해싱된 비밀번호
- `full_name`: 실명 또는 표시명
- `role`: 사용자 역할
  - `user`: 일반 사용자 (비디오 시청, 검색만 가능)
  - `admin`: 관리자 (비디오 업로드, 태그 관리, 모든 권한)
  - `premium`: 프리미엄 사용자 (Phase 3, 프리미엄 콘텐츠 접근)
- `is_active`: 계정 활성화 여부
- `created_at`: 계정 생성 시각
- `updated_at`: 마지막 수정 시각

### 2. videos (비디오)

업로드된 비디오 정보를 저장하는 테이블

```sql
CREATE TABLE videos (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_path VARCHAR(500) NOT NULL,
    thumbnail_path VARCHAR(500),
    duration INTEGER,  -- 초 단위
    file_size BIGINT,  -- 바이트 단위
    video_codec VARCHAR(50),
    audio_codec VARCHAR(50),
    resolution VARCHAR(20),  -- 예: 1920x1080
    bitrate INTEGER,
    fps DECIMAL(5,2),
    status VARCHAR(20) DEFAULT 'processing' CHECK (
        status IN ('processing', 'ready', 'failed', 'deleted')
    ),
    view_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);

CREATE INDEX idx_videos_user_id ON videos(user_id);
CREATE INDEX idx_videos_status ON videos(status);
CREATE INDEX idx_videos_published_at ON videos(published_at DESC);
CREATE INDEX idx_videos_view_count ON videos(view_count DESC);

-- Full-Text Search 인덱스 (한국어 지원)
-- PostgreSQL 13+에서 CJK 언어 지원
CREATE INDEX idx_videos_title_search ON videos USING gin(to_tsvector('simple', title));
```

**컬럼 설명:**
- `id`: 기본 키
- `user_id`: 업로더 (외래 키 → users)
- `title`: 비디오 제목
- `description`: 비디오 설명
- `file_path`: 서버 내 파일 경로
- `thumbnail_path`: 썸네일 이미지 경로
- `duration`: 비디오 길이 (초)
- `file_size`: 파일 크기 (바이트)
- `video_codec`: 비디오 코덱 (예: H.264)
- `audio_codec`: 오디오 코덱 (예: AAC)
- `resolution`: 해상도
- `bitrate`: 비트레이트 (kbps)
- `fps`: 프레임 레이트
- `status`: 처리 상태 (processing: 처리 중, ready: 준비 완료, failed: 실패, deleted: 삭제됨)
- `view_count`: 조회수
- `published_at`: 게시 시각 (NULL이면 비공개)

### 3. categories (카테고리)

비디오 분류를 위한 카테고리 테이블 (계층적 구조 지원)

```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES categories(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_slug ON categories(slug);
CREATE INDEX idx_categories_parent_id ON categories(parent_id);
```

**컬럼 설명:**
- `id`: 기본 키
- `name`: 카테고리 이름 (예: "영화", "드라마")
- `slug`: URL 친화적 식별자 (예: "movies", "drama")
- `description`: 카테고리 설명
- `parent_id`: 상위 카테고리 (NULL이면 최상위 카테고리)

### 4. video_categories (비디오-카테고리 연결)

비디오와 카테고리의 다대다 관계를 위한 중간 테이블

```sql
CREATE TABLE video_categories (
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    category_id INTEGER NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
    PRIMARY KEY (video_id, category_id)
);

CREATE INDEX idx_video_categories_category_id ON video_categories(category_id);
```

### 5. watch_history (시청 기록)

사용자의 비디오 시청 기록 및 진행 상태

```sql
CREATE TABLE watch_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    progress INTEGER DEFAULT 0,  -- 시청한 시간 (초)
    completed BOOLEAN DEFAULT FALSE,
    last_watched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, video_id)
);

CREATE INDEX idx_watch_history_user_id ON watch_history(user_id);
CREATE INDEX idx_watch_history_last_watched_at ON watch_history(last_watched_at DESC);
```

**컬럼 설명:**
- `id`: 기본 키
- `user_id`: 사용자 (외래 키 → users)
- `video_id`: 비디오 (외래 키 → videos)
- `progress`: 마지막 시청 위치 (초)
- `completed`: 시청 완료 여부
- `last_watched_at`: 마지막 시청 시각

### 6. ratings (평점) - Phase 2

사용자의 비디오 평점 (Phase 2에서 추가 예정)

```sql
CREATE TABLE ratings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    score INTEGER NOT NULL CHECK (score >= 1 AND score <= 5),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, video_id)
);

CREATE INDEX idx_ratings_video_id ON ratings(video_id);
```

**제거된 테이블 (불필요):**
- ❌ `user_favorites` (찜하기): 초기 버전에 불필요
- ❌ `comments` (댓글): 제거된 기능
- ❌ `playlists`: 제거된 기능
- ❌ `notifications`: 제거된 기능

### 7. subtitles (자막) - Phase 3

다국어 자막 지원

```sql
CREATE TABLE subtitles (
    id SERIAL PRIMARY KEY,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    language_code VARCHAR(10) NOT NULL,  -- 예: ko, en, ja
    language_name VARCHAR(50),
    file_path VARCHAR(500) NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(video_id, language_code)
);

CREATE INDEX idx_subtitles_video_id ON subtitles(video_id);
```

### 8. video_qualities (비디오 화질) - Phase 3

다중 화질 지원을 위한 테이블 (480p, 720p, 1080p, 4K)

```sql
CREATE TABLE video_qualities (
    id SERIAL PRIMARY KEY,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    quality VARCHAR(20) NOT NULL,  -- 예: 480p, 720p, 1080p, 4K
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT,
    bitrate INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(video_id, quality)
);

CREATE INDEX idx_video_qualities_video_id ON video_qualities(video_id);
```

## 핵심 테이블 (MVP)

### 9. tags (태그) - 핵심 기능

비디오 분류를 위한 태그 시스템 (카테고리보다 세분화된 분류)

```sql
CREATE TABLE tags (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    slug VARCHAR(50) NOT NULL UNIQUE,
    type VARCHAR(20) DEFAULT 'general' CHECK (
        type IN ('country', 'genre', 'mood', 'general')
    ),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tags_name ON tags(name);
CREATE INDEX idx_tags_type ON tags(type);
CREATE INDEX idx_tags_slug ON tags(slug);
```

**컬럼 설명:**
- `id`: 기본 키
- `name`: 태그 이름 (예: "한국영화", "공상과학", "전쟁영화")
- `slug`: URL 친화적 식별자 (예: "korean-movie", "sci-fi")
- `type`: 태그 유형
  - `country`: 국가/지역 (예: 한국영화, 미국영화)
  - `genre`: 장르 (예: 공상과학, 액션, 로맨스)
  - `mood`: 분위기 (예: 감동적인, 무서운, 웃긴)
  - `general`: 일반 태그
- `description`: 태그 설명
- `created_at`: 생성 시각

### 10. video_tags (비디오-태그 연결) - 핵심 기능

비디오와 태그의 다대다 관계

```sql
CREATE TABLE video_tags (
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (video_id, tag_id)
);

CREATE INDEX idx_video_tags_tag_id ON video_tags(tag_id);
CREATE INDEX idx_video_tags_video_id ON video_tags(video_id);

-- GIN 인덱스로 태그 조합 검색 최적화
CREATE INDEX idx_video_tags_gin ON video_tags USING gin(tag_id);
```

**사용 예시:**
```sql
-- "한국영화 + 공상과학 - 전쟁영화" 검색
SELECT DISTINCT v.*
FROM videos v
INNER JOIN video_tags vt1 ON v.id = vt1.video_id
INNER JOIN tags t1 ON vt1.tag_id = t1.id AND t1.slug = 'korean-movie'
INNER JOIN video_tags vt2 ON v.id = vt2.video_id
INNER JOIN tags t2 ON vt2.tag_id = t2.id AND t2.slug = 'sci-fi'
WHERE v.id NOT IN (
    SELECT vt3.video_id
    FROM video_tags vt3
    INNER JOIN tags t3 ON vt3.tag_id = t3.id AND t3.slug = 'war-movie'
);
```

### 11. video_thumbnails (비디오 썸네일) - 핵심 기능

비디오에서 추출한 여러 썸네일 옵션 저장

```sql
CREATE TABLE video_thumbnails (
    id SERIAL PRIMARY KEY,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    file_path VARCHAR(500) NOT NULL,
    timestamp INTEGER NOT NULL,  -- 비디오 내 위치 (초)
    width INTEGER DEFAULT 320,
    height INTEGER DEFAULT 180,
    is_selected BOOLEAN DEFAULT FALSE,  -- 선택된 썸네일 여부
    is_auto_generated BOOLEAN DEFAULT TRUE,  -- 자동 생성 vs 수동 업로드
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_video_thumbnails_video_id ON video_thumbnails(video_id);
CREATE INDEX idx_video_thumbnails_is_selected ON video_thumbnails(video_id, is_selected);
```

**컬럼 설명:**
- `id`: 기본 키
- `video_id`: 비디오 (외래 키 → videos)
- `file_path`: 썸네일 이미지 파일 경로 (WebP 형식 권장)
- `timestamp`: 비디오에서 추출한 시간 (초 단위)
- `width`, `height`: 이미지 크기 (기본 320x180)
- `is_selected`: 현재 선택된 썸네일인지 여부 (비디오당 하나만 true)
- `is_auto_generated`: 자동 생성된 것인지, 관리자가 수동 업로드한 것인지
- `created_at`: 생성 시각

**사용 시나리오:**
1. 비디오 업로드 시 FFmpeg **장면 전환 감지**로 10-15개의 썸네일 자동 생성
2. 관리자가 원하는 썸네일 선택 또는 외부 이미지 업로드
3. 프론트엔드에서 썸네일 호버 시 **1초 간격**으로 여러 썸네일을 순차적으로 보여주는 미리보기 기능

## 뷰 (Views)

### video_stats (비디오 통계) - Phase 2

비디오별 통계 정보를 집계한 뷰 (Phase 2에서 추가)

```sql
CREATE VIEW video_stats AS
SELECT
    v.id,
    v.title,
    v.view_count,
    AVG(r.score) as avg_rating,
    COUNT(DISTINCT r.user_id) as rating_count,
    COUNT(DISTINCT wh.user_id) as watch_count
FROM videos v
LEFT JOIN ratings r ON v.id = r.video_id
LEFT JOIN watch_history wh ON v.id = wh.video_id
GROUP BY v.id, v.title, v.view_count;
```

**제거된 컬럼:**
- ❌ `favorite_count`: user_favorites 테이블 제거로 삭제
- ❌ `comment_count`: comments 테이블 제거로 삭제

## 인덱스 전략

### 자주 쿼리되는 컬럼
- `users.email`, `users.username`: 로그인
- `users.role`: 권한 확인 (admin 필터링)
- `videos.user_id`: 관리자별 비디오 목록
- `videos.status`: 공개 비디오 필터링
- `videos.published_at`: 최신 비디오 정렬
- `videos.view_count`: 인기 비디오 정렬
- `tags.type`: 태그 유형별 필터링

### 풀텍스트 검색 (1순위)
- `videos.title`: GIN 인덱스를 사용한 한국어 검색 (simple 파서)

### 태그 조합 검색 (2순위)
- `video_tags`: GIN 인덱스로 최적화
- `tags.slug`: 태그 식별자 검색

### 복합 인덱스 (Phase 2)
```sql
-- 사용자별 최근 시청 기록
CREATE INDEX idx_watch_history_user_recent
ON watch_history(user_id, last_watched_at DESC);

-- 비디오별 평점 조회
CREATE INDEX idx_ratings_video_score
ON ratings(video_id, score DESC);
```

## 데이터 무결성 규칙

### CASCADE 정책
- 사용자 삭제 시 → 해당 사용자의 모든 데이터 삭제
- 비디오 삭제 시 → 관련 댓글, 평점, 시청 기록 등 삭제
- 카테고리 삭제 시 → 하위 카테고리 및 연결 삭제

### CHECK 제약
- `users.role`: 정의된 역할만 허용
- `videos.status`: 정의된 상태만 허용
- `ratings.score`: 1-5 범위만 허용

### UNIQUE 제약
- 사용자당 비디오별 시청 기록, 평점, 찜하기는 하나만

## 샘플 데이터

### 초기 카테고리
```sql
INSERT INTO categories (name, slug, description) VALUES
('영화', 'movies', '장편 영화 콘텐츠'),
('드라마', 'drama', 'TV 드라마 시리즈'),
('다큐멘터리', 'documentary', '다큐멘터리 콘텐츠'),
('애니메이션', 'animation', '애니메이션 콘텐츠'),
('스포츠', 'sports', '스포츠 관련 콘텐츠');
```

### 초기 태그 (예시)
```sql
-- 국가/지역 태그
INSERT INTO tags (name, slug, type, description) VALUES
('한국영화', 'korean-movie', 'country', '한국에서 제작된 영화'),
('미국영화', 'american-movie', 'country', '미국에서 제작된 영화'),
('일본영화', 'japanese-movie', 'country', '일본에서 제작된 영화'),
('유럽영화', 'european-movie', 'country', '유럽에서 제작된 영화');

-- 장르 태그
INSERT INTO tags (name, slug, type, description) VALUES
('공상과학', 'sci-fi', 'genre', 'SF 장르'),
('액션', 'action', 'genre', '액션 장르'),
('로맨스', 'romance', 'genre', '로맨스 장르'),
('코미디', 'comedy', 'genre', '코미디 장르'),
('스릴러', 'thriller', 'genre', '스릴러 장르'),
('공포', 'horror', 'genre', '공포 장르'),
('드라마', 'drama-genre', 'genre', '드라마 장르'),
('전쟁영화', 'war-movie', 'genre', '전쟁을 주제로 한 영화'),
('범죄', 'crime', 'genre', '범죄 장르'),
('판타지', 'fantasy', 'genre', '판타지 장르');

-- 분위기 태그
INSERT INTO tags (name, slug, type, description) VALUES
('감동적인', 'emotional', 'mood', '감동적인 분위기'),
('무서운', 'scary', 'mood', '무서운 분위기'),
('웃긴', 'funny', 'mood', '유머러스한 분위기'),
('긴장감', 'suspenseful', 'mood', '긴장감 넘치는 분위기');
```

## 마이그레이션 전략

1. **Alembic 사용**: SQLAlchemy 기반 마이그레이션
2. **버전 관리**: 모든 스키마 변경은 마이그레이션 파일로 관리
3. **롤백 가능**: 각 마이그레이션은 upgrade/downgrade 함수 제공
4. **데이터 보존**: 컬럼 삭제 시 데이터 백업/마이그레이션
