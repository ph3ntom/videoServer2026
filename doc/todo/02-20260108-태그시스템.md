# 태그 시스템 구현 (Tag System)

## 작업 날짜
2026년 1월 8일

## 구현 내용

### 1. 개요
StreamFlix 프로젝트에 비디오 카테고리화 및 필터링을 위한 태그 시스템을 구현했습니다.
사용자가 직접 새로운 태그를 생성하고, 비디오에 태그를 추가/수정/삭제할 수 있으며, 태그별로 비디오를 필터링할 수 있습니다.

### 2. 주요 기능

#### 2.1 태그 관리 (Tag CRUD)

##### 태그 생성
- **엔드포인트**: `POST /api/v1/tags/`
- **인증 필요**: ✅
- **기능**: 새로운 태그 생성
- **특징**:
  - 자동 slug 생성 (URL-friendly)
  - 중복 태그 방지 (기존 태그 반환)
  - 색상 커스터마이징 (Hex 코드)
  - 한글 지원
- **Request Body**:
  ```json
  {
    "name": "f-nine",
    "description": "F9 그룹 관련 태그",
    "color": "#FF6B6B"
  }
  ```
- **Response**:
  ```json
  {
    "id": 5,
    "name": "f-nine",
    "slug": "f-nine",
    "color": "#FF6B6B"
  }
  ```

##### 태그 조회
- **엔드포인트**: `GET /api/v1/tags/`
- **인증 필요**: ❌
- **Query Parameters**:
  - `skip`: 페이지네이션 오프셋 (기본: 0)
  - `limit`: 최대 결과 개수 (기본: 100)
  - `search`: 검색 쿼리 (optional)

##### 인기 태그 조회
- **엔드포인트**: `GET /api/v1/tags/popular`
- **인증 필요**: ❌
- **Query Parameters**:
  - `limit`: 결과 개수 (기본: 10, 최대: 50)
- **정렬**: 비디오 개수 내림차순

##### 태그 검색 (자동완성)
- **엔드포인트**: `GET /api/v1/tags/search?q={query}`
- **인증 필요**: ❌
- **기능**: 태그 이름 또는 설명에서 검색
- **검색 방식**: ILIKE (대소문자 무시, 부분 일치)

##### 태그 수정/삭제
- **엔드포인트**: `PUT /api/v1/tags/{id}`, `DELETE /api/v1/tags/{id}`
- **인증 필요**: ✅

---

#### 2.2 비디오-태그 관계 관리

##### 비디오 태그 조회
- **엔드포인트**: `GET /api/v1/videos/{id}/tags`
- **인증 필요**: ❌
- **Response**: 비디오에 연결된 태그 목록

##### 비디오에 태그 추가
- **엔드포인트**: `POST /api/v1/videos/{id}/tags`
- **인증 필요**: ✅ (소유자만)
- **권한**: 비디오 소유자만 가능 (403 Forbidden)
- **Request Body**:
  ```json
  {
    "tag_ids": [1, 3, 5]
  }
  ```

##### 비디오 태그 전체 교체
- **엔드포인트**: `PUT /api/v1/videos/{id}/tags`
- **인증 필요**: ✅ (소유자만)
- **기능**: 기존 태그 전체 삭제 후 새로운 태그로 교체

##### 특정 태그 삭제
- **엔드포인트**: `DELETE /api/v1/videos/{id}/tags/{tag_id}`
- **인증 필요**: ✅ (소유자만)

---

#### 2.3 비디오 필터링

##### 태그별 비디오 필터링
- **엔드포인트**: `GET /api/v1/videos/?tag_ids={tag_id}`
- **인증 필요**: ❌
- **기능**: 특정 태그를 가진 비디오만 조회
- **SQL**: INNER JOIN + DISTINCT
- **예시**: `/api/v1/videos/?tag_ids=1` → tag_id 1인 비디오만

---

### 3. 데이터베이스 구조

#### 3.1 `tags` 테이블

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|---------|------|
| id | INTEGER | PK, AUTO_INCREMENT | 태그 고유 ID |
| name | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | 태그 이름 |
| slug | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | URL-friendly 슬러그 |
| description | TEXT | NULL | 태그 설명 |
| color | VARCHAR(7) | NOT NULL, DEFAULT '#3B82F6' | Hex 색상 코드 |
| created_at | DATETIME | NOT NULL | 생성 일시 |
| updated_at | DATETIME | NOT NULL | 수정 일시 |

**인덱스**:
- `idx_tags_name`: name 컬럼
- `idx_tags_slug`: slug 컬럼

**Validation**:
- name: 1-100자, 알파벳/숫자/한글/하이픈/공백만 허용
- color: Hex 형식 (#RRGGBB)
- description: 최대 500자

#### 3.2 `video_tags` 테이블 (Many-to-Many)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|---------|------|
| video_id | INTEGER | FK (videos.id), PK | 비디오 ID |
| tag_id | INTEGER | FK (tags.id), PK | 태그 ID |

**복합 Primary Key**: (video_id, tag_id)

**Relationship**:
```python
# Tag 모델
videos = relationship("Video", secondary="video_tags", back_populates="tags")

# Video 모델
tags = relationship("Tag", secondary="video_tags", back_populates="videos")
```

---

### 4. 백엔드 구현 파일

#### 4.1 모델 (Models)
- **파일**: `backend/app/models/tag.py`
- **클래스**: `Tag`
- **주요 메서드**:
  - `@property video_count`: 비디오 개수 계산

#### 4.2 스키마 (Schemas)
- **파일**: `backend/app/schemas/tag.py`
- **클래스**:
  - `TagBase`: 기본 태그 스키마
  - `TagCreate`: 태그 생성 (name, description, color)
  - `TagUpdate`: 태그 수정
  - `TagResponse`: 태그 응답 (video_count 포함)
  - `TagSimple`: 간단한 태그 정보 (id, name, slug, color)
  - `VideoTagCreate`: 비디오에 태그 추가 (tag_ids)
  - `VideoTagUpdate`: 비디오 태그 전체 교체 (tag_ids)

#### 4.3 서비스 레이어
- **파일**: `backend/app/services/tag_service.py`
- **클래스**: `TagService`
- **주요 메서드**:
  - `generate_slug(name)`: Slug 자동 생성
  - `create(db, tag_data)`: 태그 생성 (중복 시 기존 태그 반환)
  - `get_all(db, skip, limit, search)`: 전체 태그 조회 (검색 지원)
  - `get_by_id(db, tag_id)`: ID로 태그 조회
  - `get_by_slug(db, slug)`: Slug로 태그 조회
  - `search(db, query)`: 태그 검색 (name, description)
  - `get_popular(db, limit)`: 인기 태그 조회 (video_count 기준)
  - `update(db, tag, tag_data)`: 태그 수정
  - `delete(db, tag)`: 태그 삭제
  - `add_tags_to_video(db, video, tag_ids)`: 비디오에 태그 추가
  - `set_video_tags(db, video, tag_ids)`: 비디오 태그 전체 교체
  - `remove_tags_from_video(db, video, tag_ids)`: 비디오에서 태그 제거

**Slug 생성 알고리즘**:
```python
def generate_slug(name: str) -> str:
    slug = name.lower()
    slug = re.sub(r'[^\w\s-]', '', slug)  # 특수문자 제거
    slug = re.sub(r'[-\s]+', '-', slug)   # 공백/하이픈 정규화
    slug = slug.strip('-')                # 앞뒤 하이픈 제거
    return slug

# 예시:
# "K-POP" → "k-pop"
# "f nine" → "f-nine"
# "댄스 커버" → "댄스-커버"
```

#### 4.4 API 라우터
- **파일**: `backend/app/api/v1/tags.py`
- **주요 엔드포인트**:
  - `POST /`: 태그 생성
  - `GET /`: 전체 태그 조회
  - `GET /popular`: 인기 태그
  - `GET /search`: 태그 검색
  - `GET /{id}`: 태그 상세
  - `GET /slug/{slug}`: Slug로 조회
  - `PUT /{id}`: 태그 수정
  - `DELETE /{id}`: 태그 삭제

#### 4.5 비디오 API 수정
- **파일**: `backend/app/api/v1/videos.py`
- **추가된 엔드포인트**:
  - `GET /{video_id}/tags`: 비디오 태그 조회
  - `POST /{video_id}/tags`: 태그 추가
  - `PUT /{video_id}/tags`: 태그 전체 교체
  - `DELETE /{video_id}/tags/{tag_id}`: 특정 태그 삭제

#### 4.6 비디오 서비스 수정
- **파일**: `backend/app/services/video_service.py`
- **수정사항**:
  - `get_all()` 메서드에 `tag_ids` 파라미터 추가
  - 태그 필터링 로직 구현 (SQL JOIN)

---

### 5. 프론트엔드 구현

#### 5.1 TagSelector 컴포넌트
- **파일**: `frontend/src/components/tag/TagSelector.tsx` (358줄)
- **Props**:
  ```typescript
  interface TagSelectorProps {
    selectedTags: Tag[];
    onTagsChange: (tags: Tag[]) => void;
    maxTags?: number;  // 기본값: 10
  }
  ```

##### 주요 기능

**1. 태그 검색 및 자동완성**
- 실시간 검색 (API: `/tags/search?q=`)
- 드롭다운으로 결과 표시
- Click-outside 감지로 자동 닫기

**2. 선택된 태그 표시**
- 색상별 배지 (Badge)
- X 버튼으로 제거
- 최대 개수 제한 (기본 10개)

**3. 새 태그 생성 모달** ⭐
- 검색 결과 없을 시 "새 태그 만들기" 버튼 표시
- 모달 팝업으로 생성 폼 제공
- **입력 필드**:
  - 태그 이름 (필수)
  - 색상 선택 (Color Picker + 8가지 Preset)
  - 설명 (선택사항)
  - 실시간 미리보기
- **Preset 색상**:
  ```typescript
  const presetColors = [
    '#FF6B6B',  // 빨강
    '#4ECDC4',  // 민트
    '#95E1D3',  // 연두
    '#F7DC6F',  // 노랑
    '#3B82F6',  // 파랑
    '#8B5CF6',  // 보라
    '#EC4899',  // 핑크
    '#10B981'   // 초록
  ];
  ```
- **자동 추가**: 생성된 태그가 자동으로 selectedTags에 추가

**상태 관리**:
```typescript
const [searchQuery, setSearchQuery] = useState('');
const [searchResults, setSearchResults] = useState<Tag[]>([]);
const [isDropdownOpen, setIsDropdownOpen] = useState(false);
const [isCreatingTag, setIsCreatingTag] = useState(false);
const [newTagName, setNewTagName] = useState('');
const [newTagColor, setNewTagColor] = useState('#3B82F6');
const [newTagDescription, setNewTagDescription] = useState('');
```

---

#### 5.2 비디오 업로드 페이지
- **파일**: `frontend/src/pages/UploadVideo.tsx`
- **수정 위치**: 153-157줄
- **추가된 기능**:
  - TagSelector 컴포넌트 통합
  - 업로드 완료 후 태그 자동 저장
- **코드**:
  ```typescript
  <TagSelector
    selectedTags={selectedTags}
    onTagsChange={setSelectedTags}
    maxTags={10}
  />

  // 업로드 완료 후
  const videoId = response.data.id;
  if (selectedTags.length > 0) {
    await apiClient.post(`/videos/${videoId}/tags`, {
      tag_ids: selectedTags.map(tag => tag.id)
    });
  }
  ```

---

#### 5.3 비디오 상세 페이지 (태그 편집)
- **파일**: `frontend/src/pages/VideoPlayer.tsx`
- **수정 위치**: 350-410줄
- **추가된 기능**:
  - 태그 목록 표시
  - "편집" 버튼 (소유자만)
  - TagSelector로 태그 추가/삭제
  - "저장", "취소" 버튼
- **권한 체크**:
  ```typescript
  const isOwner = video.user_id === currentUser?.id;
  ```
- **저장 로직**:
  ```typescript
  const handleSaveTags = async () => {
    await apiClient.put(`/videos/${video.id}/tags`, {
      tag_ids: tempTags.map(tag => tag.id)
    });
    setTags(tempTags);
    setEditingTags(false);
    alert('태그가 저장되었습니다');
  };
  ```

**상태 관리**:
```typescript
const [tags, setTags] = useState<Tag[]>([]);
const [editingTags, setEditingTags] = useState(false);
const [tempTags, setTempTags] = useState<Tag[]>([]);
const [savingTags, setSavingTags] = useState(false);
```

---

#### 5.4 비디오 리스트 페이지 (태그 필터링)
- **파일**: `frontend/src/pages/Videos.tsx`
- **수정 위치**: 88-124줄
- **추가된 기능**:
  - 인기 태그 상위 10개 표시
  - "전체" 버튼으로 필터 해제
  - 태그별 비디오 개수 표시
  - 선택된 태그 강조 표시
- **로직**:
  ```typescript
  // 인기 태그 로드
  const loadPopularTags = async () => {
    const response = await apiClient.get('/tags/popular?limit=10');
    setTags(response.data);
  };

  // 태그 필터링
  const loadVideos = async () => {
    const params = selectedTag ? `?tag_ids=${selectedTag}` : '';
    const response = await apiClient.get(`/videos/${params}`);
    setVideos(response.data);
  };

  // 태그 클릭
  const handleTagClick = (tagId: number) => {
    setSelectedTag(selectedTag === tagId ? null : tagId);
  };
  ```

**UI 스타일**:
- 선택된 태그: ring-2 효과, 진한 색상
- 미선택 태그: 40% 투명도

---

### 6. 기술적 세부사항

#### 6.1 Many-to-Many 관계 구현

**Association Table**:
```python
video_tags = Table(
    'video_tags',
    Base.metadata,
    Column('video_id', Integer, ForeignKey('videos.id'), primary_key=True),
    Column('tag_id', Integer, ForeignKey('tags.id'), primary_key=True)
)
```

**SQLAlchemy Relationship**:
```python
# Tag 모델
videos = relationship("Video", secondary="video_tags", back_populates="tags")

# Video 모델
tags = relationship("Tag", secondary="video_tags", back_populates="videos")
```

---

#### 6.2 Async SQLAlchemy 쿼리

**Relationship 로딩**:
```python
# ✅ 올바른 방법
result = await db.execute(
    select(Video)
    .options(selectinload(Video.tags))
    .where(Video.id == video_id)
)
video = result.scalar_one_or_none()

# ❌ 잘못된 방법 (MissingGreenlet 에러)
video = await db.get(Video, video_id)
tags = video.tags  # Lazy loading은 async에서 불가!
```

---

#### 6.3 태그 필터링 SQL

```python
if tag_ids:
    query = (
        query
        .join(video_tags, Video.id == video_tags.c.video_id)
        .where(video_tags.c.tag_id.in_(tag_ids))
        .distinct()
    )
```

**SQL 예시**:
```sql
SELECT DISTINCT videos.*
FROM videos
INNER JOIN video_tags ON videos.id = video_tags.video_id
WHERE video_tags.tag_id IN (1, 3, 5)
ORDER BY videos.created_at DESC;
```

---

#### 6.4 Click-Outside 감지 (React)

```typescript
useEffect(() => {
  const handleClickOutside = (event: MouseEvent) => {
    if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
      setIsDropdownOpen(false);
    }
  };

  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, []);
```

---

### 7. 트러블슈팅

#### 문제 1: ResponseValidationError - video_count

**에러**:
```
ResponseValidationError: 'video_count'
MissingGreenlet: greenlet_spawn has not been called
```

**원인**:
- Tag 모델의 `@property video_count`가 `len(self.videos)` 호출
- Pydantic validation 중에는 async relationship 로드 불가

**해결책**:
```python
# 변경 전
@router.post("/", response_model=TagResponse, ...)  # ❌ video_count 포함

# 변경 후
@router.post("/", response_model=TagSimple, ...)  # ✅ video_count 없음
```

**설명**:
- TagResponse: video_count 필드 포함
- TagSimple: id, name, slug, color만 반환
- 새 태그는 어차피 video_count = 0
- Relationship 로드 불필요

---

#### 문제 2: CORS vs 500 에러 구분

**표면 에러**:
```
Access to XMLHttpRequest blocked by CORS policy
```

**실제 원인**: 백엔드 500 에러

**구분 방법**:

| CORS 에러 | 500 에러 |
|-----------|----------|
| OPTIONS 요청 실패 | OPTIONS 성공 (200 OK) |
| 백엔드 로그 없음 | 백엔드 ERROR 로그 |
| 브라우저에만 표시 | 백엔드 Traceback |

---

### 8. 테스트 시나리오

#### 8.1 태그 생성 테스트
1. 비디오 업로드 페이지 접속
2. 태그 검색창에 "f-nine" 입력
3. "새 태그 만들기" 버튼 클릭
4. 색상 #FF6B6B 선택
5. "생성" 버튼 클릭

**예상 결과**:
- ✅ 태그가 DB에 저장
- ✅ selectedTags에 자동 추가
- ✅ 모달 닫힘

---

#### 8.2 태그 편집 테스트
1. 비디오 상세 페이지 접속 (소유자)
2. "편집" 버튼 클릭
3. 태그 추가/삭제
4. "저장" 버튼 클릭

**예상 결과**:
- ✅ PUT `/videos/{id}/tags` 호출
- ✅ DB 업데이트
- ✅ UI 즉시 반영

---

#### 8.3 태그 필터링 테스트
1. 비디오 리스트 페이지 접속
2. "K-POP (15)" 태그 클릭

**예상 결과**:
- ✅ K-POP 태그 비디오만 표시
- ✅ 선택 태그 강조
- ✅ "전체" 버튼으로 해제 가능

---

#### 8.4 중복 태그 방지 테스트
1. "Music" 태그 생성 시도 (이미 존재)

**예상 결과**:
- ✅ 에러 없이 기존 태그 반환
- ✅ selectedTags에 추가

---

### 9. 문서 및 명세

#### 9.1 개발 문서
- **위치**: `doc/dev_Process/6.v0.5-tag-system.md`
- **내용**:
  - 데이터베이스 스키마 (ERD)
  - API 명세서 (Request/Response)
  - 시퀀스 다이어그램
  - 플로우차트
  - 상태 다이어그램
  - 트러블슈팅

#### 9.2 README 업데이트
- **파일**: `doc/dev_Process/0.README.md`
- **추가된 내용**:
  - v0.5 태그 시스템 소개
  - 태그 API 엔드포인트 목록
  - 프로젝트 구조 (tags.py, tag_service.py, TagSelector.tsx)
  - 개발 로드맵 업데이트
  - 주요 파일 위치 안내

---

### 10. 완료 체크리스트

#### Backend
- [x] Tag 모델 생성 (`models/tag.py`)
- [x] video_tags Association Table 생성
- [x] Tag 스키마 생성 (`schemas/tag.py`)
- [x] Tag 서비스 구현 (`services/tag_service.py`)
- [x] Tag API 라우터 구현 (`api/v1/tags.py`)
- [x] Video API에 태그 엔드포인트 추가
- [x] Video Service에 태그 필터링 추가
- [x] Slug 자동 생성 로직
- [x] 중복 태그 방지 로직
- [x] 인기 태그 조회 (video_count 기준)
- [x] 태그 검색 (ILIKE)

#### Frontend
- [x] TagSelector 컴포넌트 생성
- [x] 태그 검색 및 자동완성
- [x] 새 태그 생성 모달
- [x] 색상 선택 (Color Picker + Preset)
- [x] 실시간 미리보기
- [x] 업로드 페이지 태그 선택 추가
- [x] 상세 페이지 태그 편집 추가
- [x] 리스트 페이지 태그 필터링 추가
- [x] Click-outside 감지
- [x] 권한 체크 (소유자만 편집)

#### Documentation
- [x] 6.v0.5-tag-system.md 작성
- [x] 0.README.md 업데이트
- [x] API 명세 추가
- [x] 다이어그램 작성
- [x] Todo 문서 작성

#### Testing
- [x] 태그 생성 API 테스트
- [x] 태그 검색 테스트
- [x] 태그 필터링 테스트
- [x] 중복 태그 방지 테스트
- [x] ResponseValidationError 수정
- [x] 프론트엔드 HMR 확인

---

### 11. 성과 및 특징

#### 주요 성과
1. **완전한 태그 시스템 구축**
   - 백엔드 API 9개 엔드포인트
   - 프론트엔드 3개 페이지 통합
   - Many-to-Many 관계 구현

2. **사용자 경험 개선**
   - 새 태그 즉석 생성
   - 실시간 미리보기
   - 색상 커스터마이징
   - 직관적인 UI/UX

3. **성능 최적화**
   - 인덱싱 (name, slug)
   - N+1 쿼리 방지 (selectinload)
   - 효율적인 SQL JOIN

#### 기술적 특징
1. **Slug 자동 생성**
   - SEO-friendly URL
   - 한글 지원
   - 특수문자 자동 제거

2. **중복 방지**
   - 에러 대신 기존 태그 반환
   - 사용자 경험 개선

3. **색상 시스템**
   - Hex 코드 검증
   - 8가지 Preset 색상
   - UI 일관성 유지

4. **권한 관리**
   - 소유자만 태그 편집
   - 백엔드 권한 검증
   - 403 Forbidden 응답

---

### 12. 향후 개선 사항

#### 단기 (v0.6)
- [ ] 태그 계층 구조 (부모-자식)
- [ ] 태그 통계 페이지
- [ ] 태그 관리자 페이지

#### 중기 (v0.7)
- [ ] 태그 자동 추천 (AI)
- [ ] 태그 트렌딩
- [ ] 태그 병합 기능

#### 장기 (v1.0)
- [ ] 다국어 태그 지원
- [ ] 태그 동의어 처리
- [ ] 태그 분석 대시보드

---

## 마무리

태그 시스템 v0.5가 성공적으로 완료되었습니다.

**핵심 성과**:
- ✅ 완전한 CRUD 기능
- ✅ 새 태그 생성 모달
- ✅ 비디오 필터링
- ✅ 색상 커스터마이징
- ✅ 한글 지원
- ✅ 권한 관리

**다음 단계**: 비디오 검색 기능 구현 (v0.6)

---

**작성일**: 2026년 1월 8일
**작성자**: Claude Sonnet 4.5
**버전**: v0.5
