# v0.5 - íƒœê·¸ ì‹œìŠ¤í…œ (Tag System)

**ë²„ì „:** v0.5
**ê°œë°œ ê¸°ê°„:** 2026-01-08
**ìƒíƒœ:** âœ… ì™„ë£Œ

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
3. [ë°±ì—”ë“œ API](#ë°±ì—”ë“œ-api)
4. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„](#í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„)
5. [ì£¼ìš” ê¸°ëŠ¥](#ì£¼ìš”-ê¸°ëŠ¥)
6. [ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­](#ê¸°ìˆ ì -ì„¸ë¶€ì‚¬í•­)
7. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ê°œìš”

### ëª©ì 
ë¹„ë””ì˜¤ì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì¹´í…Œê³ ë¦¬í™” ë° ê²€ìƒ‰/í•„í„°ë§ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ì‹œìŠ¤í…œ êµ¬ì¶•

### ì£¼ìš” ìš”êµ¬ì‚¬í•­
- âœ… íƒœê·¸ CRUD ê¸°ëŠ¥
- âœ… ë¹„ë””ì˜¤-íƒœê·¸ ë‹¤ëŒ€ë‹¤(Many-to-Many) ê´€ê³„
- âœ… íƒœê·¸ ê²€ìƒ‰ ë° ìë™ì™„ì„±
- âœ… ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì‹œ íƒœê·¸ ì„ íƒ
- âœ… ë¹„ë””ì˜¤ ìƒì„¸ í˜ì´ì§€ì—ì„œ íƒœê·¸ í¸ì§‘
- âœ… íƒœê·¸ë³„ ë¹„ë””ì˜¤ í•„í„°ë§
- âœ… **ìƒˆ íƒœê·¸ ìƒì„± ê¸°ëŠ¥ (ëª¨ë‹¬)**
- âœ… ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### ê¸°ìˆ  ìŠ¤íƒ
- **Backend:** FastAPI, SQLAlchemy 2.0 (Async), Pydantic
- **Frontend:** React 18, TypeScript, TailwindCSS
- **Database:** PostgreSQL (Many-to-Many relationship)

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ERD

```mermaid
erDiagram
    tags ||--o{ video_tags : "has"
    videos ||--o{ video_tags : "has"

    tags {
        int id PK
        string name UK "íƒœê·¸ ì´ë¦„ (Unique)"
        string slug UK "URL-friendly ì‹ë³„ì"
        text description "íƒœê·¸ ì„¤ëª… (optional)"
        string color "Hex ìƒ‰ìƒ ì½”ë“œ"
        datetime created_at
        datetime updated_at
    }

    video_tags {
        int video_id FK
        int tag_id FK
    }

    videos {
        int id PK
        string title
        int user_id FK
        string status
        datetime created_at
    }
```

### í…Œì´ë¸” ì •ì˜

#### 1. `tags` í…Œì´ë¸”

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|------|------|---------|------|
| id | INTEGER | PK, AUTO_INCREMENT | íƒœê·¸ ê³ ìœ  ID |
| name | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | íƒœê·¸ ì´ë¦„ |
| slug | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | URL-friendly ìŠ¬ëŸ¬ê·¸ |
| description | TEXT | NULL | íƒœê·¸ ì„¤ëª… |
| color | VARCHAR(7) | NOT NULL, DEFAULT '#3B82F6' | Hex ìƒ‰ìƒ ì½”ë“œ |
| created_at | DATETIME | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | DATETIME | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì¸ë±ìŠ¤:**
- `idx_tags_name`: name ì»¬ëŸ¼
- `idx_tags_slug`: slug ì»¬ëŸ¼

**ì œì•½ì¡°ê±´:**
- name: ì•ŒíŒŒë²³, ìˆ«ì, í•œê¸€, í•˜ì´í”ˆ(-), ê³µë°±ë§Œ í—ˆìš©
- color: Hex ìƒ‰ìƒ í˜•ì‹ (#RRGGBB)

#### 2. `video_tags` í…Œì´ë¸” (Association Table)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|------|------|---------|------|
| video_id | INTEGER | FK (videos.id), PK | ë¹„ë””ì˜¤ ID |
| tag_id | INTEGER | FK (tags.id), PK | íƒœê·¸ ID |

**ë³µí•© Primary Key:** (video_id, tag_id)

---

## ë°±ì—”ë“œ API

### API ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡

#### íƒœê·¸ ê´€ë¦¬

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì¸ì¦ | ì„¤ëª… |
|--------|-----------|------|------|
| POST | `/api/v1/tags/` | âœ… | ìƒˆ íƒœê·¸ ìƒì„± |
| GET | `/api/v1/tags/` | âŒ | ì „ì²´ íƒœê·¸ ì¡°íšŒ (ê²€ìƒ‰ ì§€ì›) |
| GET | `/api/v1/tags/popular` | âŒ | ì¸ê¸° íƒœê·¸ ì¡°íšŒ (ë¹„ë””ì˜¤ ê°œìˆ˜ìˆœ) |
| GET | `/api/v1/tags/search?q=` | âŒ | íƒœê·¸ ê²€ìƒ‰ (ìë™ì™„ì„±) |
| GET | `/api/v1/tags/{id}` | âŒ | íƒœê·¸ ìƒì„¸ ì¡°íšŒ |
| GET | `/api/v1/tags/slug/{slug}` | âŒ | Slugë¡œ íƒœê·¸ ì¡°íšŒ |
| PUT | `/api/v1/tags/{id}` | âœ… | íƒœê·¸ ìˆ˜ì • |
| DELETE | `/api/v1/tags/{id}` | âœ… | íƒœê·¸ ì‚­ì œ |

#### ë¹„ë””ì˜¤-íƒœê·¸ ê´€ê³„

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì¸ì¦ | ì„¤ëª… |
|--------|-----------|------|------|
| GET | `/api/v1/videos/{id}/tags` | âŒ | ë¹„ë””ì˜¤ íƒœê·¸ ì¡°íšŒ |
| POST | `/api/v1/videos/{id}/tags` | âœ… (ì†Œìœ ì) | íƒœê·¸ ì¶”ê°€ |
| PUT | `/api/v1/videos/{id}/tags` | âœ… (ì†Œìœ ì) | íƒœê·¸ ì „ì²´ êµì²´ |
| DELETE | `/api/v1/videos/{id}/tags/{tag_id}` | âœ… (ì†Œìœ ì) | íŠ¹ì • íƒœê·¸ ì‚­ì œ |

#### ë¹„ë””ì˜¤ í•„í„°ë§

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | íŒŒë¼ë¯¸í„° | ì„¤ëª… |
|--------|-----------|---------|------|
| GET | `/api/v1/videos/` | `?tag_ids=1,2,3` | íƒœê·¸ë³„ ë¹„ë””ì˜¤ í•„í„°ë§ |

### API ìƒì„¸ ëª…ì„¸

#### 1. POST `/api/v1/tags/` - íƒœê·¸ ìƒì„±

**Request:**
```json
{
  "name": "f-nine",
  "description": "F9 ê·¸ë£¹ ê´€ë ¨ íƒœê·¸",
  "color": "#FF6B6B"
}
```

**Response:** `201 Created`
```json
{
  "id": 5,
  "name": "f-nine",
  "slug": "f-nine",
  "color": "#FF6B6B"
}
```

**Validation:**
- name: 1-100ì, ì•ŒíŒŒë²³/ìˆ«ì/í•œê¸€/í•˜ì´í”ˆ/ê³µë°±ë§Œ í—ˆìš©
- color: Hex ìƒ‰ìƒ í˜•ì‹ (#RRGGBB)
- description: ìµœëŒ€ 500ì (optional)

**ì—ëŸ¬:**
- `400`: ì¤‘ë³µëœ íƒœê·¸ ì´ë¦„ â†’ ê¸°ì¡´ íƒœê·¸ ë°˜í™˜
- `422`: ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨

---

#### 2. GET `/api/v1/tags/` - ì „ì²´ íƒœê·¸ ì¡°íšŒ

**Query Parameters:**
- `skip`: í˜ì´ì§€ë„¤ì´ì…˜ ì˜¤í”„ì…‹ (ê¸°ë³¸: 0)
- `limit`: ìµœëŒ€ ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸: 100, ìµœëŒ€: 100)
- `search`: ê²€ìƒ‰ ì¿¼ë¦¬ (optional)

**Response:** `200 OK`
```json
[
  {
    "id": 1,
    "name": "Music",
    "slug": "music",
    "description": "Music videos",
    "color": "#FF6B6B",
    "created_at": "2026-01-07T06:03:38.507737",
    "updated_at": "2026-01-07T06:03:38.507741",
    "video_count": 5
  }
]
```

---

#### 3. GET `/api/v1/tags/popular?limit=10` - ì¸ê¸° íƒœê·¸

**Query Parameters:**
- `limit`: ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸: 10, ìµœëŒ€: 50)

**Response:** `200 OK`
```json
[
  {
    "id": 3,
    "name": "K-POP",
    "slug": "k-pop",
    "color": "#95E1D3",
    "video_count": 15
  }
]
```

**ì •ë ¬:** video_count DESC

---

#### 4. GET `/api/v1/tags/search?q=k` - íƒœê·¸ ê²€ìƒ‰

**Query Parameters:**
- `q`: ê²€ìƒ‰ì–´ (í•„ìˆ˜)

**Response:** `200 OK`
```json
[
  {
    "id": 3,
    "name": "K-POP",
    "slug": "k-pop",
    "color": "#95E1D3"
  }
]
```

**ê²€ìƒ‰ ë²”ìœ„:** name, description (ILIKE)

---

#### 5. PUT `/api/v1/videos/{id}/tags` - ë¹„ë””ì˜¤ íƒœê·¸ ì—…ë°ì´íŠ¸

**Request:**
```json
{
  "tag_ids": [1, 3, 5]
}
```

**Response:** `200 OK`
```json
[
  {
    "id": 1,
    "name": "Music",
    "slug": "music",
    "color": "#FF6B6B"
  }
]
```

**ê¶Œí•œ:** ë¹„ë””ì˜¤ ì†Œìœ ìë§Œ ê°€ëŠ¥ (403 Forbidden)

---

#### 6. GET `/api/v1/videos/?tag_ids=1` - íƒœê·¸ í•„í„°ë§

**Query Parameters:**
- `tag_ids`: íƒœê·¸ ID (ë‹¨ì¼ ë˜ëŠ” ë‹¤ì¤‘)

**Response:** `200 OK`
```json
[
  {
    "id": 8,
    "title": "ì§ìº ",
    "tags": [
      {"id": 1, "name": "Music", "color": "#FF6B6B"}
    ]
  }
]
```

**SQL:** INNER JOIN + DISTINCT

---

## í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ tag/
â”‚       â””â”€â”€ TagSelector.tsx      â† íƒœê·¸ ì„ íƒ/ìƒì„± ì»´í¬ë„ŒíŠ¸
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ UploadVideo.tsx          â† ì—…ë¡œë“œ ì‹œ íƒœê·¸ ì„ íƒ
â”‚   â”œâ”€â”€ VideoPlayer.tsx          â† ìƒì„¸ í˜ì´ì§€ íƒœê·¸ í¸ì§‘
â”‚   â””â”€â”€ Videos.tsx               â† ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ íƒœê·¸ í•„í„°
â””â”€â”€ services/
    â””â”€â”€ api.client.ts
```

### 1. TagSelector ì»´í¬ë„ŒíŠ¸

**íŒŒì¼:** `frontend/src/components/tag/TagSelector.tsx`

#### Props

```typescript
interface TagSelectorProps {
  selectedTags: Tag[];
  onTagsChange: (tags: Tag[]) => void;
  maxTags?: number;  // ê¸°ë³¸ê°’: 10
}
```

#### ì£¼ìš” ê¸°ëŠ¥

1. **íƒœê·¸ ê²€ìƒ‰ ë° ìë™ì™„ì„±**
   - ì‹¤ì‹œê°„ ê²€ìƒ‰ (API: `/tags/search?q=`)
   - ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ
   - Click-outside ê°ì§€ë¡œ ìë™ ë‹«ê¸°

2. **ì„ íƒëœ íƒœê·¸ í‘œì‹œ**
   - ìƒ‰ìƒë³„ ë°°ì§€ (Badge)
   - X ë²„íŠ¼ìœ¼ë¡œ ì œê±°
   - ìµœëŒ€ ê°œìˆ˜ ì œí•œ

3. **ìƒˆ íƒœê·¸ ìƒì„±**
   - ê²€ìƒ‰ ê²°ê³¼ ì—†ì„ ì‹œ "ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°" ë²„íŠ¼
   - ëª¨ë‹¬ íŒì—…ìœ¼ë¡œ ìƒì„± í¼ í‘œì‹œ

#### ìƒˆ íƒœê·¸ ìƒì„± ëª¨ë‹¬

**UI êµ¬ì„±:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  íƒœê·¸ ì´ë¦„ *                      â”‚
â”‚  [f-nine                    ]   â”‚
â”‚                                 â”‚
â”‚  ìƒ‰ìƒ                            â”‚
â”‚  [ğŸ¨] [#FF6B6B           ]      â”‚
â”‚  [ğŸ”´][ğŸ’][ğŸŒ±][ğŸŒŸ][ğŸ”µ][ğŸ’œ][ğŸ’—][ğŸ’š]  â”‚
â”‚                                 â”‚
â”‚  ì„¤ëª… (ì„ íƒì‚¬í•­)                  â”‚
â”‚  [F9 ê·¸ë£¹ ê´€ë ¨ íƒœê·¸...    ]      â”‚
â”‚                                 â”‚
â”‚  ë¯¸ë¦¬ë³´ê¸°                        â”‚
â”‚  [ f-nine ]  â† ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸   â”‚
â”‚                                 â”‚
â”‚  [  ìƒì„±  ] [  ì·¨ì†Œ  ]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Preset ìƒ‰ìƒ:**
```typescript
const presetColors = [
  '#FF6B6B',  // ë¹¨ê°•
  '#4ECDC4',  // ë¯¼íŠ¸
  '#95E1D3',  // ì—°ë‘
  '#F7DC6F',  // ë…¸ë‘
  '#3B82F6',  // íŒŒë‘
  '#8B5CF6',  // ë³´ë¼
  '#EC4899',  // í•‘í¬
  '#10B981'   // ì´ˆë¡
];
```

**ì½”ë“œ ì˜ˆì‹œ:**

```typescript
const handleSubmitNewTag = async () => {
  const response = await apiClient.post('/tags/', {
    name: newTagName.trim(),
    description: newTagDescription.trim() || undefined,
    color: newTagColor
  });

  const newTag = response.data;

  // ìë™ìœ¼ë¡œ ì„ íƒëœ íƒœê·¸ì— ì¶”ê°€
  onTagsChange([...selectedTags, newTag]);

  // ì „ì²´ íƒœê·¸ ëª©ë¡ ì—…ë°ì´íŠ¸
  setAllTags([...allTags, newTag]);
};
```

---

### 2. ë¹„ë””ì˜¤ ì—…ë¡œë“œ í˜ì´ì§€

**íŒŒì¼:** `frontend/src/pages/UploadVideo.tsx:153-157`

```typescript
// íƒœê·¸ ì„ íƒ UI
<TagSelector
  selectedTags={selectedTags}
  onTagsChange={setSelectedTags}
  maxTags={10}
/>

// ì—…ë¡œë“œ ì™„ë£Œ í›„ íƒœê·¸ ì €ì¥
const videoId = response.data.id;

if (selectedTags.length > 0) {
  await apiClient.post(`/videos/${videoId}/tags`, {
    tag_ids: selectedTags.map(tag => tag.id)
  });
}
```

---

### 3. ë¹„ë””ì˜¤ ìƒì„¸ í˜ì´ì§€

**íŒŒì¼:** `frontend/src/pages/VideoPlayer.tsx:350-410`

```typescript
// íƒœê·¸ í¸ì§‘ UI
{isOwner && !editingTags && (
  <button onClick={handleEditTags}>í¸ì§‘</button>
)}

{editingTags ? (
  <div>
    <TagSelector
      selectedTags={tempTags}
      onTagsChange={setTempTags}
      maxTags={10}
    />
    <button onClick={handleSaveTags}>ì €ì¥</button>
    <button onClick={handleCancelEditTags}>ì·¨ì†Œ</button>
  </div>
) : (
  <div>
    {tags.map(tag => (
      <span style={{ color: tag.color }}>{tag.name}</span>
    ))}
  </div>
)}

// ì €ì¥ í•¨ìˆ˜
const handleSaveTags = async () => {
  await apiClient.put(`/videos/${video.id}/tags`, {
    tag_ids: tempTags.map(tag => tag.id)
  });
  setTags(tempTags);
  setEditingTags(false);
};
```

**ê¶Œí•œ ì²´í¬:**
```typescript
const isOwner = video.user_id === currentUser?.id;
```

---

### 4. ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€

**íŒŒì¼:** `frontend/src/pages/Videos.tsx:88-124`

```typescript
// ì¸ê¸° íƒœê·¸ ë¡œë“œ
const loadPopularTags = async () => {
  const response = await apiClient.get('/tags/popular?limit=10');
  setTags(response.data);
};

// íƒœê·¸ í•„í„°ë§
const loadVideos = async () => {
  const params = selectedTag ? `?tag_ids=${selectedTag}` : '';
  const response = await apiClient.get(`/videos/${params}`);
  setVideos(response.data);
};

// UI
<div>
  <button onClick={() => setSelectedTag(null)}>ì „ì²´</button>

  {tags.map(tag => (
    <button
      onClick={() => handleTagClick(tag.id)}
      style={{
        backgroundColor: selectedTag === tag.id ? tag.color : tag.color + '40',
        border: `1px solid ${tag.color}`
      }}
    >
      {tag.name} ({tag.video_count})
    </button>
  ))}
</div>
```

**ìŠ¤íƒ€ì¼:**
- ì„ íƒëœ íƒœê·¸: ring-2 íš¨ê³¼, ì§„í•œ ìƒ‰ìƒ
- ë¯¸ì„ íƒ íƒœê·¸: 40% íˆ¬ëª…ë„

---

## ì£¼ìš” ê¸°ëŠ¥

### 1. Slug ìë™ ìƒì„±

**ëª©ì :** SEO-friendly URL ìƒì„±

**ì•Œê³ ë¦¬ì¦˜:**
```python
@staticmethod
def generate_slug(name: str) -> str:
    """
    Generate URL-friendly slug from tag name

    Examples:
      "K-POP" -> "k-pop"
      "f nine" -> "f-nine"
      "ëŒ„ìŠ¤ ì»¤ë²„" -> "ëŒ„ìŠ¤-ì»¤ë²„"
    """
    slug = name.lower()
    slug = re.sub(r'[^\w\s-]', '', slug)  # íŠ¹ìˆ˜ë¬¸ì ì œê±°
    slug = re.sub(r'[-\s]+', '-', slug)   # ê³µë°±/í•˜ì´í”ˆ ì •ê·œí™”
    slug = slug.strip('-')                # ì•ë’¤ í•˜ì´í”ˆ ì œê±°
    return slug
```

---

### 2. ì¤‘ë³µ íƒœê·¸ ë°©ì§€

**ì „ëµ:** ì¤‘ë³µ ì‹œ ê¸°ì¡´ íƒœê·¸ ë°˜í™˜ (ì—ëŸ¬ X)

```python
async def create(self, db: AsyncSession, tag_data: TagCreate) -> Tag:
    # Slug ìƒì„±
    slug = self.generate_slug(tag_data.name)

    # ê¸°ì¡´ íƒœê·¸ í™•ì¸
    existing_tag = await self.get_by_slug(db, slug)
    if existing_tag:
        return existing_tag  # ì¤‘ë³µ ì‹œ ê¸°ì¡´ íƒœê·¸ ë°˜í™˜

    # ìƒˆ íƒœê·¸ ìƒì„±
    tag = Tag(
        name=tag_data.name,
        slug=slug,
        description=tag_data.description,
        color=tag_data.color
    )
    db.add(tag)
    await db.commit()
    await db.refresh(tag)
    return tag
```

---

### 3. íƒœê·¸ ê²€ìƒ‰

**ê¸°ëŠ¥:** ì‹¤ì‹œê°„ ìë™ì™„ì„±

```python
async def search(self, db: AsyncSession, query: str) -> List[Tag]:
    """
    Search tags by name or description
    Case-insensitive, supports Korean
    """
    search_query = select(Tag).where(
        or_(
            Tag.name.ilike(f"%{query}%"),
            Tag.description.ilike(f"%{query}%")
        )
    ).order_by(Tag.name)

    result = await db.execute(search_query)
    return list(result.scalars().all())
```

**í”„ë¡ íŠ¸ì—”ë“œ:**
```typescript
useEffect(() => {
  if (searchQuery.trim().length > 0) {
    searchTags(searchQuery);  // Debounced
  } else {
    setSearchResults(allTags);
  }
}, [searchQuery, allTags]);
```

---

### 4. ì¸ê¸° íƒœê·¸ ì¡°íšŒ

**ì •ë ¬:** video_count DESC

```python
async def get_popular(self, db: AsyncSession, limit: int = 10) -> List[tuple[Tag, int]]:
    query = (
        select(Tag, func.count(video_tags.c.video_id).label('video_count'))
        .outerjoin(video_tags, Tag.id == video_tags.c.tag_id)
        .group_by(Tag.id)
        .order_by(func.count(video_tags.c.video_id).desc())
        .limit(limit)
    )
    result = await db.execute(query)
    return [(row[0], row[1]) for row in result.all()]
```

---

### 5. ë¹„ë””ì˜¤ í•„í„°ë§

**SQL JOIN:**
```python
if tag_ids:
    query = (
        query
        .join(video_tags, Video.id == video_tags.c.video_id)
        .where(video_tags.c.tag_id.in_(tag_ids))
        .distinct()
    )
```

**ì„¤ëª…:**
- INNER JOINìœ¼ë¡œ íƒœê·¸ê°€ ìˆëŠ” ë¹„ë””ì˜¤ë§Œ ì¡°íšŒ
- DISTINCTë¡œ ì¤‘ë³µ ì œê±°
- ë‹¤ì¤‘ íƒœê·¸ ì§€ì› (OR ì¡°ê±´)

---

## ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### 1. Many-to-Many ê´€ê³„ êµ¬í˜„

**Association Table:**
```python
video_tags = Table(
    'video_tags',
    Base.metadata,
    Column('video_id', Integer, ForeignKey('videos.id'), primary_key=True),
    Column('tag_id', Integer, ForeignKey('tags.id'), primary_key=True)
)
```

**Relationship:**
```python
# Tag ëª¨ë¸
videos = relationship("Video", secondary="video_tags", back_populates="tags")

# Video ëª¨ë¸
tags = relationship("Tag", secondary="video_tags", back_populates="videos")
```

---

### 2. Async SQLAlchemy ì¿¼ë¦¬

**ì˜ˆì‹œ:**
```python
# íƒœê·¸ ì¡°íšŒ (relationship ë¡œë“œ)
result = await db.execute(
    select(Video)
    .options(selectinload(Video.tags))
    .where(Video.id == video_id)
)
video = result.scalar_one_or_none()
```

**ì£¼ì˜ì‚¬í•­:**
- `selectinload()`: relationship ë¯¸ë¦¬ ë¡œë“œ
- ì•ˆ í•˜ë©´ lazy loading â†’ MissingGreenlet ì—ëŸ¬

---

### 3. Pydantic Validation

**ìŠ¤í‚¤ë§ˆ:**
```python
class TagBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    description: Optional[str] = Field(None, max_length=500)
    color: str = Field("#3B82F6", pattern="^#[0-9A-Fa-f]{6}$")

    @validator('name')
    def validate_name(cls, v):
        if not re.match(r'^[\w\s\-ê°€-í£]+$', v):
            raise ValueError('Invalid characters')
        return v.strip()
```

**í—ˆìš© ë¬¸ì:**
- ì•ŒíŒŒë²³ (a-z, A-Z)
- ìˆ«ì (0-9)
- í•œê¸€ (ê°€-í£)
- í•˜ì´í”ˆ (-)
- ê³µë°±

---

### 4. React State Management

**ìƒíƒœ êµ¬ì¡°:**
```typescript
// TagSelector
const [searchQuery, setSearchQuery] = useState('');
const [searchResults, setSearchResults] = useState<Tag[]>([]);
const [isDropdownOpen, setIsDropdownOpen] = useState(false);
const [isCreatingTag, setIsCreatingTag] = useState(false);

// VideoPlayer
const [tags, setTags] = useState<Tag[]>([]);
const [editingTags, setEditingTags] = useState(false);
const [tempTags, setTempTags] = useState<Tag[]>([]);

// Videos
const [selectedTag, setSelectedTag] = useState<number | null>(null);
```

---

### 5. Click-Outside ê°ì§€

**êµ¬í˜„:**
```typescript
useEffect(() => {
  const handleClickOutside = (event: MouseEvent) => {
    if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
      setIsDropdownOpen(false);
    }
  };

  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, []);
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ResponseValidationError - video_count

**ì—ëŸ¬ ë©”ì‹œì§€:**
```
ResponseValidationError: 'video_count'
MissingGreenlet: greenlet_spawn has not been called
```

**ì›ì¸:**
- Tag ëª¨ë¸ì— `@property video_count` ì •ì˜
- Pydantic validation ì¤‘ `len(self.videos)` í˜¸ì¶œ
- Async relationshipì´ ë¡œë“œë˜ì§€ ì•ŠìŒ
- â†’ Greenlet ì—ëŸ¬

**í•´ê²°ì±…:**
```python
# ë³€ê²½ ì „
@router.post("/", response_model=TagResponse, ...)  # âŒ video_count í¬í•¨

# ë³€ê²½ í›„
@router.post("/", response_model=TagSimple, ...)  # âœ… video_count ì—†ìŒ
```

**ì„¤ëª…:**
- TagResponse: id, name, slug, color, video_count
- TagSimple: id, name, slug, colorë§Œ ë°˜í™˜
- ìƒˆ íƒœê·¸ëŠ” ì–´ì°¨í”¼ video_count = 0
- Relationship ë¡œë“œ ë¶ˆí•„ìš”

---

### ë¬¸ì œ 2: CORS vs 500 ì—ëŸ¬ êµ¬ë¶„

**í‘œë©´ ì—ëŸ¬:**
```
Access to XMLHttpRequest blocked by CORS policy
```

**ì‹¤ì œ ì›ì¸:**
- ë°±ì—”ë“œ 500 ì—ëŸ¬ë¡œ ì¸í•œ ì‘ë‹µ ì‹¤íŒ¨
- CORSê°€ ì•„ë‹˜!

**êµ¬ë¶„ ë°©ë²•:**
| CORS ì—ëŸ¬ | 500 ì—ëŸ¬ |
|-----------|----------|
| OPTIONS ìš”ì²­ ì‹¤íŒ¨ | OPTIONS ì„±ê³µ (200 OK) |
| ë°±ì—”ë“œ ë¡œê·¸ ì—†ìŒ | ë°±ì—”ë“œ ERROR ë¡œê·¸ |
| ë¸Œë¼ìš°ì €ì—ë§Œ í‘œì‹œ | ë°±ì—”ë“œ Traceback |

---

## ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

### 1. ìƒˆ íƒœê·¸ ìƒì„± íë¦„

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend (TagSelector)
    participant B as Backend (FastAPI)
    participant DB as Database

    U->>F: ê²€ìƒ‰ì°½ì— "f-nine" ì…ë ¥
    F->>B: GET /api/v1/tags/search?q=f-nine
    B->>DB: SELECT * FROM tags WHERE name ILIKE '%f-nine%'
    DB-->>B: [] (ê²°ê³¼ ì—†ìŒ)
    B-->>F: 200 OK []

    F->>F: "ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°" ë²„íŠ¼ í‘œì‹œ
    U->>F: ë²„íŠ¼ í´ë¦­
    F->>F: ëª¨ë‹¬ ì—´ê¸°

    U->>F: ìƒ‰ìƒ ì„ íƒ (#FF6B6B), ìƒì„± í´ë¦­
    F->>B: POST /api/v1/tags/<br/>{name: "f-nine", color: "#FF6B6B"}

    B->>B: generate_slug("f-nine") â†’ "f-nine"
    B->>DB: INSERT INTO tags (name, slug, color)
    DB-->>B: Tag(id=5, name="f-nine")
    B-->>F: 201 Created {id:5, name:"f-nine", slug:"f-nine", color:"#FF6B6B"}

    F->>F: selectedTagsì— ì¶”ê°€
    F->>F: allTagsì— ì¶”ê°€
    F->>F: ëª¨ë‹¬ ë‹«ê¸°
```

---

### 2. ë¹„ë””ì˜¤ íƒœê·¸ í¸ì§‘ íë¦„

```mermaid
sequenceDiagram
    participant U as User (ì†Œìœ ì)
    participant F as Frontend (VideoPlayer)
    participant B as Backend
    participant DB as Database

    U->>F: "í¸ì§‘" ë²„íŠ¼ í´ë¦­
    F->>F: setEditingTags(true)
    F->>F: TagSelector í‘œì‹œ

    U->>F: íƒœê·¸ ì¶”ê°€/ì‚­ì œ
    F->>F: tempTags ì—…ë°ì´íŠ¸

    U->>F: "ì €ì¥" ë²„íŠ¼ í´ë¦­
    F->>B: PUT /api/v1/videos/8/tags<br/>{tag_ids: [1,3,5]}

    B->>B: ì†Œìœ ì ê¶Œí•œ í™•ì¸
    B->>DB: DELETE FROM video_tags WHERE video_id=8
    B->>DB: INSERT INTO video_tags VALUES (8,1), (8,3), (8,5)
    B->>DB: SELECT tags FROM videos WHERE id=8
    DB-->>B: [Tag(id=1), Tag(id=3), Tag(id=5)]
    B-->>F: 200 OK [...]

    F->>F: setTags(tempTags)
    F->>F: setEditingTags(false)
    F->>U: ì•Œë¦¼: "íƒœê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"
```

---

### 3. íƒœê·¸ í•„í„°ë§ íë¦„

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend (Videos)
    participant B as Backend
    participant DB as Database

    F->>B: GET /api/v1/tags/popular?limit=10
    B->>DB: SELECT tags, COUNT(videos) GROUP BY tags ORDER BY COUNT DESC
    DB-->>B: [K-POP(15), Dance(12), Music(10), ...]
    B-->>F: 200 OK [...]
    F->>F: ì¸ê¸° íƒœê·¸ ë²„íŠ¼ ë Œë”ë§

    U->>F: "K-POP (15)" ë²„íŠ¼ í´ë¦­
    F->>F: setSelectedTag(3)

    F->>B: GET /api/v1/videos/?tag_ids=3
    B->>DB: SELECT DISTINCT videos<br/>FROM videos<br/>JOIN video_tags ON videos.id=video_tags.video_id<br/>WHERE video_tags.tag_id=3
    DB-->>B: [Video(id=8), Video(id=12), ...]
    B-->>F: 200 OK [...]

    F->>F: setVideos(response.data)
    F->>F: K-POP íƒœê·¸ ë²„íŠ¼ ê°•ì¡° í‘œì‹œ
```

---

## í”Œë¡œìš°ì°¨íŠ¸

### íƒœê·¸ ìƒì„± ë¡œì§

```mermaid
flowchart TD
    Start([ì‚¬ìš©ìê°€ íƒœê·¸ ê²€ìƒ‰]) --> SearchAPI[GET /tags/search?q=]
    SearchAPI --> HasResults{ê²€ìƒ‰ ê²°ê³¼<br/>ìˆìŒ?}

    HasResults -->|Yes| ShowResults[ê¸°ì¡´ íƒœê·¸ ëª©ë¡ í‘œì‹œ]
    ShowResults --> UserSelect[ì‚¬ìš©ìê°€ íƒœê·¸ ì„ íƒ]
    UserSelect --> AddToSelected[selectedTagsì— ì¶”ê°€]
    AddToSelected --> End([ì™„ë£Œ])

    HasResults -->|No| ShowCreateBtn[ìƒˆ íƒœê·¸ ë§Œë“¤ê¸° ë²„íŠ¼ í‘œì‹œ]
    ShowCreateBtn --> UserClickCreate[ì‚¬ìš©ìê°€ ë²„íŠ¼ í´ë¦­]
    UserClickCreate --> OpenModal[ëª¨ë‹¬ ì—´ê¸°]

    OpenModal --> UserInput[ì´ë¦„, ìƒ‰ìƒ, ì„¤ëª… ì…ë ¥]
    UserInput --> ValidateName{ì´ë¦„<br/>ìœ íš¨?}

    ValidateName -->|No| ShowError[ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ]
    ShowError --> UserInput

    ValidateName -->|Yes| CreateAPI[POST /tags/]
    CreateAPI --> BackendSlug[Slug ìƒì„±]
    BackendSlug --> CheckDuplicate{ì¤‘ë³µ<br/>íƒœê·¸?}

    CheckDuplicate -->|Yes| ReturnExisting[ê¸°ì¡´ íƒœê·¸ ë°˜í™˜]
    CheckDuplicate -->|No| InsertDB[DBì— íƒœê·¸ ì‚½ì…]

    InsertDB --> ReturnNew[ìƒˆ íƒœê·¸ ë°˜í™˜]
    ReturnExisting --> AutoAdd
    ReturnNew --> AutoAdd[selectedTagsì— ìë™ ì¶”ê°€]

    AutoAdd --> UpdateAllTags[allTags ëª©ë¡ ì—…ë°ì´íŠ¸]
    UpdateAllTags --> CloseModal[ëª¨ë‹¬ ë‹«ê¸°]
    CloseModal --> End
```

---

## ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨

### TagSelector ìƒíƒœ ì „ì´

```mermaid
stateDiagram-v2
    [*] --> Idle: ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸

    Idle --> Searching: ê²€ìƒ‰ì°½ ì…ë ¥
    Searching --> ShowDropdown: ê²°ê³¼ ìˆìŒ
    Searching --> ShowCreateButton: ê²°ê³¼ ì—†ìŒ

    ShowDropdown --> Idle: íƒœê·¸ ì„ íƒ ë˜ëŠ” ë‹«ê¸°
    ShowCreateButton --> CreatingTag: "ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°" í´ë¦­

    CreatingTag --> Submitting: "ìƒì„±" í´ë¦­
    CreatingTag --> Idle: "ì·¨ì†Œ" í´ë¦­

    Submitting --> Success: API ì„±ê³µ
    Submitting --> Error: API ì‹¤íŒ¨

    Success --> Idle: íƒœê·¸ ìë™ ì¶”ê°€ + ëª¨ë‹¬ ë‹«ê¸°
    Error --> CreatingTag: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

    Idle --> [*]: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸
```

---

## íŒŒì¼ ë³€ê²½ ì‚¬í•­

### ìƒì„±ëœ íŒŒì¼

1. **Backend**
   ```
   backend/app/schemas/tag.py             (72ì¤„)
   backend/app/services/tag_service.py    (182ì¤„)
   backend/app/api/v1/tags.py             (167ì¤„)
   ```

2. **Frontend**
   ```
   frontend/src/components/tag/TagSelector.tsx  (358ì¤„)
   ```

### ìˆ˜ì •ëœ íŒŒì¼

1. **Backend**
   ```
   backend/app/api/v1/videos.py           (+77ì¤„) - ë¹„ë””ì˜¤-íƒœê·¸ ê´€ê³„ API
   backend/app/api/v1/router.py           (+2ì¤„)  - íƒœê·¸ ë¼ìš°í„° ë“±ë¡
   backend/app/services/video_service.py  (+15ì¤„) - íƒœê·¸ í•„í„°ë§ ë¡œì§
   ```

2. **Frontend**
   ```
   frontend/src/pages/UploadVideo.tsx     (+24ì¤„) - íƒœê·¸ ì„ íƒ UI
   frontend/src/pages/VideoPlayer.tsx     (+89ì¤„) - íƒœê·¸ í¸ì§‘ UI
   frontend/src/pages/Videos.tsx          (+38ì¤„) - íƒœê·¸ í•„í„°ë§ UI
   ```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. íƒœê·¸ ìƒì„± í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ë¹„ë””ì˜¤ ì—…ë¡œë“œ í˜ì´ì§€ ì ‘ì†
2. íƒœê·¸ ê²€ìƒ‰ì°½ì— "f-nine" ì…ë ¥
3. "ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°" ë²„íŠ¼ í´ë¦­
4. ìƒ‰ìƒ #FF6B6B ì„ íƒ
5. "ìƒì„±" ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… íƒœê·¸ê°€ DBì— ì €ì¥ë¨
- âœ… selectedTagsì— ìë™ ì¶”ê°€
- âœ… ëª¨ë‹¬ ë‹«í˜

---

### 2. íƒœê·¸ í¸ì§‘ í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ë¹„ë””ì˜¤ ìƒì„¸ í˜ì´ì§€ ì ‘ì† (ì†Œìœ ì)
2. "í¸ì§‘" ë²„íŠ¼ í´ë¦­
3. íƒœê·¸ ì¶”ê°€/ì‚­ì œ
4. "ì €ì¥" ë²„íŠ¼ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… PUT /videos/{id}/tags í˜¸ì¶œ
- âœ… DB ì—…ë°ì´íŠ¸
- âœ… UI ì¦‰ì‹œ ë°˜ì˜

---

### 3. íƒœê·¸ í•„í„°ë§ í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ì ‘ì†
2. "K-POP (15)" íƒœê·¸ í´ë¦­

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… K-POP íƒœê·¸ ë¹„ë””ì˜¤ë§Œ í‘œì‹œ
- âœ… ì„ íƒ íƒœê·¸ ê°•ì¡° í‘œì‹œ
- âœ… "ì „ì²´" ë²„íŠ¼ìœ¼ë¡œ í•„í„° í•´ì œ ê°€ëŠ¥

---

### 4. ì¤‘ë³µ íƒœê·¸ ë°©ì§€ í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤:**
1. "Music" íƒœê·¸ ìƒì„± ì‹œë„ (ì´ë¯¸ ì¡´ì¬)

**ì˜ˆìƒ ê²°ê³¼:**
- âœ… ì—ëŸ¬ ì—†ì´ ê¸°ì¡´ íƒœê·¸ ë°˜í™˜
- âœ… selectedTagsì— ì¶”ê°€

---

## ì„±ëŠ¥ ìµœì í™”

### 1. ì¸ë±ì‹±

```sql
CREATE INDEX idx_tags_name ON tags(name);
CREATE INDEX idx_tags_slug ON tags(slug);
CREATE INDEX idx_video_tags_video_id ON video_tags(video_id);
CREATE INDEX idx_video_tags_tag_id ON video_tags(tag_id);
```

### 2. N+1 ë¬¸ì œ í•´ê²°

**ë¬¸ì œ:**
```python
# âŒ N+1 ì¿¼ë¦¬ ë°œìƒ
videos = await db.execute(select(Video))
for video in videos:
    tags = video.tags  # ê° ë¹„ë””ì˜¤ë§ˆë‹¤ ì¿¼ë¦¬!
```

**í•´ê²°:**
```python
# âœ… í•œ ë²ˆì— ë¡œë“œ
videos = await db.execute(
    select(Video).options(selectinload(Video.tags))
)
```

---

## í–¥í›„ ê°œì„  ì‚¬í•­

### 1. íƒœê·¸ ê³„ì¸µ êµ¬ì¡°
- ë¶€ëª¨-ìì‹ íƒœê·¸ ê´€ê³„
- ì˜ˆ: "K-POP" â†’ "ì•„ì´ëŒ", "ì†”ë¡œ"

### 2. íƒœê·¸ í†µê³„
- íƒœê·¸ë³„ ì¡°íšŒìˆ˜
- íŠ¸ë Œë”© íƒœê·¸

### 3. íƒœê·¸ ì¶”ì²œ
- ìœ ì‚¬ íƒœê·¸ ì œì•ˆ
- AI ê¸°ë°˜ ìë™ íƒœê·¸

### 4. íƒœê·¸ ë³‘í•©
- ì¤‘ë³µ/ìœ ì‚¬ íƒœê·¸ í†µí•©
- ê´€ë¦¬ì ê¸°ëŠ¥

---

## ì°¸ê³  ìë£Œ

### API ë¬¸ì„œ
- FastAPI Swagger UI: http://localhost:8000/docs

### í”„ë¡ íŠ¸ì—”ë“œ ì ‘ì†
- ì—…ë¡œë“œ: http://localhost:5174/upload
- ë¹„ë””ì˜¤ ë¦¬ìŠ¤íŠ¸: http://localhost:5174/videos
- ë¹„ë””ì˜¤ ìƒì„¸: http://localhost:5174/videos/{id}

### ì½”ë“œ ìœ„ì¹˜
- Backend: `/backend/app/`
- Frontend: `/frontend/src/`
- ë¬¸ì„œ: `/doc/dev_Process/`

---

**ì‘ì„±ì¼:** 2026-01-08
**ì‘ì„±ì:** Claude Sonnet 4.5
**ë²„ì „:** v0.5
